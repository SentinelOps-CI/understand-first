# Understand-First JSON Schema Reference

This document provides comprehensive documentation for all Understand-First JSON schemas, including usage examples, validation rules, and integration guidelines.

## Table of Contents

- [Overview](#overview)
- [Schema Files](#schema-files)
- [Map Schema](#map-schema)
- [Lens Schema](#lens-schema)
- [Trace Schema](#trace-schema)
- [Tour Schema](#tour-schema)
- [Metrics Schema](#metrics-schema)
- [Config Schema](#config-schema)
- [Validation](#validation)
- [Integration](#integration)
- [Examples](#examples)

## Overview

Understand-First uses standardized JSON schemas to ensure consistency across all data formats. These schemas enable:

- **Validation**: Ensure data integrity and format compliance
- **Documentation**: Self-documenting data structures
- **Tooling**: IDE support, auto-completion, and type checking
- **Integration**: Consistent APIs across all platforms

All schemas follow JSON Schema Draft 7 specification and include comprehensive examples.

## Schema Files

| File | Description | Generated By |
|------|-------------|--------------|
| `map-schema.json` | Repository structure and function relationships | `u scan` |
| `lens-schema.json` | Focused views of codebase areas | `u lens` |
| `trace-schema.json` | Runtime execution traces | `u trace` |
| `tour-schema.json` | Guided learning experiences | `u tour` |
| `metrics-schema.json` | Performance and usage analytics | Instrumentation |
| `config-schema.json` | Configuration settings | User/System |

## Map Schema

**File**: `map-schema.json`  
**Generated by**: `u scan` command  
**Purpose**: Complete repository structure and function relationships

### Key Components

- **Repository metadata**: Name, path, scan timestamp
- **Functions**: Complete function catalog with complexity and relationships
- **Files**: File-level information and organization
- **Modules**: Logical grouping and dependencies
- **Relationships**: Call graphs and dependencies

### Example Usage

```python
import json
from jsonschema import validate

# Load schema
with open('schemas/map-schema.json') as f:
    map_schema = json.load(f)

# Validate map data
with open('maps/repo.json') as f:
    map_data = json.load(f)

validate(instance=map_data, schema=map_schema)
```

### Key Fields

- `version`: Schema version (always "1.0")
- `repository`: Repository metadata and scan information
- `functions`: Dictionary of all functions with complexity metrics
- `files`: File-level information and organization
- `modules`: Logical module structure and dependencies
- `relationships`: Call graphs and function relationships

## Lens Schema

**File**: `lens-schema.json`  
**Generated by**: `u lens` command  
**Purpose**: Focused views of specific codebase areas

### Key Components

- **Lens configuration**: Name, description, seed functions
- **Expansion rules**: How the lens grows from seeds
- **Filters**: What to include/exclude from the view
- **Functions**: Subset of functions relevant to the lens
- **Visualization**: Layout and display preferences

### Example Usage

```python
# Create a new lens
lens_data = {
    "version": "1.0",
    "lens": {
        "name": "Authentication Flow",
        "seeds": ["auth.py:authenticate_user"],
        "created_at": "2024-01-15T10:00:00Z"
    },
    "functions": {
        "auth.py:authenticate_user": {
            "name": "authenticate_user",
            "complexity": {"cyclomatic": 8},
            "side_effects": ["database_read", "session_create"]
        }
    }
}

# Validate
validate(instance=lens_data, schema=lens_schema)
```

### Key Fields

- `lens`: Lens metadata and configuration
- `seeds`: Starting functions for the lens
- `expansion`: Rules for growing the lens
- `filters`: Inclusion/exclusion criteria
- `functions`: Relevant functions with metadata
- `visualization`: Display and layout settings

## Trace Schema

**File**: `trace-schema.json`  
**Generated by**: `u trace` command  
**Purpose**: Runtime execution traces and performance data

### Key Components

- **Trace metadata**: Execution environment and configuration
- **Execution data**: Function calls, timing, and performance
- **Hot paths**: Identified performance bottlenecks
- **Function statistics**: Call counts, timing, memory usage
- **Performance analysis**: Bottlenecks and optimization opportunities

### Example Usage

```python
# Trace execution
trace_data = {
    "version": "1.0",
    "trace": {
        "name": "API Request Trace",
        "start_time": "2024-01-15T10:00:00Z",
        "end_time": "2024-01-15T10:00:02Z",
        "entry_point": {
            "file": "api.py",
            "function": "handle_request"
        }
    },
    "execution": {
        "calls": [
            {
                "id": "call-001",
                "function": "api.py:handle_request",
                "timestamp": "2024-01-15T10:00:00Z",
                "type": "call",
                "execution_time_ms": 150.5
            }
        ]
    }
}
```

### Key Fields

- `trace`: Execution metadata and environment
- `execution`: Call data and timeline
- `functions`: Function execution statistics
- `performance`: Performance metrics and analysis
- `hot_paths`: Identified performance bottlenecks

## Tour Schema

**File**: `tour-schema.json`  
**Generated by**: `u tour` command  
**Purpose**: Guided learning experiences and documentation

### Key Components

- **Tour metadata**: Name, description, learning objectives
- **Steps**: Sequential learning content with code examples
- **Navigation**: Step flow and branching logic
- **Visualization**: Focus areas and highlighting
- **Assessment**: Questions and validation criteria

### Example Usage

```python
# Create a tour
tour_data = {
    "version": "1.0",
    "tour": {
        "name": "Understanding Authentication",
        "description": "Learn how authentication works",
        "created_at": "2024-01-15T10:00:00Z",
        "estimated_duration_minutes": 15
    },
    "steps": [
        {
            "id": "step-001",
            "title": "Authentication Overview",
            "type": "overview",
            "content": {
                "text": "This step explains authentication...",
                "code_blocks": [
                    {
                        "code": "def authenticate_user(email, password):\n    ...",
                        "language": "python",
                        "file": "auth.py"
                    }
                ]
            }
        }
    ]
}
```

### Key Fields

- `tour`: Tour metadata and configuration
- `steps`: Learning content and instructions
- `navigation`: Step flow and branching
- `visualization`: Focus areas and highlighting
- `assessment`: Questions and validation

## Metrics Schema

**File**: `metrics-schema.json`  
**Generated by**: Instrumentation system  
**Purpose**: Performance and usage analytics

### Key Components

- **Session data**: User sessions and platform information
- **Events**: Tracked user interactions and system events
- **Performance**: Operation timing and resource usage
- **User experience**: TTU, TTFSC, and engagement metrics
- **KPIs**: Key performance indicators and analytics

### Example Usage

```python
# Track metrics
metrics_data = {
    "version": "1.0",
    "session": {
        "session_id": "sess_12345",
        "start_time": "2024-01-15T10:00:00Z",
        "platform": "cli",
        "opt_in_tracking": True
    },
    "events": [
        {
            "event_type": "command_executed",
            "timestamp": "2024-01-15T10:00:30Z",
            "properties": {
                "command": "u scan",
                "success": True,
                "function_count": 45
            }
        }
    ]
}
```

### Key Fields

- `session`: User session information
- `events`: Tracked events and interactions
- `performance`: Operation timing and metrics
- `user_experience`: TTU/TTFSC and engagement
- `kpis`: Key performance indicators

## Config Schema

**File**: `config-schema.json`  
**Generated by**: User/system configuration  
**Purpose**: System configuration and preferences

### Key Components

- **Repository settings**: Project-specific configuration
- **Analysis options**: Complexity, side effects, documentation
- **Visualization preferences**: Layout, styling, interactions
- **Integration settings**: GitHub, VS Code, web demo
- **Performance tuning**: Caching, parallel processing

### Example Usage

```python
# Configuration file
config_data = {
    "version": "1.0",
    "repository": {
        "name": "my-project",
        "languages": ["python", "javascript"]
    },
    "analysis": {
        "complexity": {
            "enabled": True,
            "threshold": 15
        }
    },
    "visualization": {
        "default_layout": "hierarchical"
    }
}
```

### Key Fields

- `repository`: Project-specific settings
- `analysis`: Analysis configuration
- `visualization`: Display preferences
- `integrations`: External service settings
- `performance`: Optimization settings

## Validation

### Using Python

```python
import json
from jsonschema import validate, ValidationError

def validate_json(data_file: str, schema_file: str) -> bool:
    """Validate JSON data against schema."""
    try:
        with open(schema_file) as f:
            schema = json.load(f)
        with open(data_file) as f:
            data = json.load(f)
        
        validate(instance=data, schema=schema)
        print(f"✓ {data_file} is valid")
        return True
    except ValidationError as e:
        print(f"✗ {data_file} validation error: {e.message}")
        return False
    except Exception as e:
        print(f"✗ {data_file} error: {e}")
        return False

# Validate all schemas
schemas = ["map", "lens", "trace", "tour", "metrics", "config"]
for schema in schemas:
    validate_json(f"data/{schema}.json", f"schemas/{schema}-schema.json")
```

### Using JavaScript

```javascript
const Ajv = require('ajv');
const ajv = new Ajv();

function validateJSON(dataFile, schemaFile) {
    const schema = require(schemaFile);
    const data = require(dataFile);
    
    const validate = ajv.compile(schema);
    const valid = validate(data);
    
    if (valid) {
        console.log(`✓ ${dataFile} is valid`);
    } else {
        console.log(`✗ ${dataFile} validation errors:`, validate.errors);
    }
    
    return valid;
}

// Validate schemas
const schemas = ['map', 'lens', 'trace', 'tour', 'metrics', 'config'];
schemas.forEach(schema => {
    validateJSON(`./data/${schema}.json`, `./schemas/${schema}-schema.json`);
});
```

### Command Line Validation

```bash
# Install jsonschema
pip install jsonschema

# Validate a single file
python -c "
import json
from jsonschema import validate
with open('schemas/map-schema.json') as f:
    schema = json.load(f)
with open('maps/repo.json') as f:
    data = json.load(f)
validate(instance=data, schema=schema)
print('Map is valid')
"

# Use the validation script
python schemas/validate_schemas.py
```

## Integration

### IDE Support

Add schema references to your JSON files:

```json
{
  "$schema": "./schemas/map-schema.json",
  "version": "1.0",
  "repository": {
    "name": "my-project"
  }
}
```

### VS Code

Install the "JSON Schema Validator" extension and configure `settings.json`:

```json
{
  "json.schemas": [
    {
      "fileMatch": ["**/maps/*.json"],
      "url": "./schemas/map-schema.json"
    },
    {
      "fileMatch": ["**/lenses/*.json"],
      "url": "./schemas/lens-schema.json"
    },
    {
      "fileMatch": ["**/traces/*.json"],
      "url": "./schemas/trace-schema.json"
    },
    {
      "fileMatch": ["**/tours/*.json"],
      "url": "./schemas/tour-schema.json"
    },
    {
      "fileMatch": ["**/metrics/*.json"],
      "url": "./schemas/metrics-schema.json"
    },
    {
      "fileMatch": ["**/.understand-first/config.json"],
      "url": "./schemas/config-schema.json"
    }
  ]
}
```

### API Integration

```python
from typing import Dict, Any
import json
from jsonschema import validate, ValidationError

class SchemaValidator:
    def __init__(self, schemas_dir: str):
        self.schemas = {}
        self.load_schemas(schemas_dir)
    
    def load_schemas(self, schemas_dir: str):
        """Load all schemas from directory."""
        schema_files = {
            'map': 'map-schema.json',
            'lens': 'lens-schema.json',
            'trace': 'trace-schema.json',
            'tour': 'tour-schema.json',
            'metrics': 'metrics-schema.json',
            'config': 'config-schema.json'
        }
        
        for name, filename in schema_files.items():
            with open(f"{schemas_dir}/{filename}") as f:
                self.schemas[name] = json.load(f)
    
    def validate(self, data_type: str, data: Dict[str, Any]) -> bool:
        """Validate data against schema."""
        if data_type not in self.schemas:
            raise ValueError(f"Unknown data type: {data_type}")
        
        try:
            validate(instance=data, schema=self.schemas[data_type])
            return True
        except ValidationError as e:
            raise ValueError(f"Validation error: {e.message}")

# Usage
validator = SchemaValidator("schemas")
validator.validate("map", map_data)
```

## Examples

### Complete Map Example

```json
{
  "$schema": "./schemas/map-schema.json",
  "version": "1.0",
  "repository": {
    "name": "authentication-service",
    "path": "/path/to/repo",
    "scan_timestamp": "2024-01-15T10:00:00Z",
    "main_branch": "main",
    "total_lines": 15000,
    "total_functions": 245,
    "languages": ["python", "javascript"],
    "dependencies": ["flask", "sqlalchemy", "redis"]
  },
  "functions": {
    "auth.py:authenticate_user": {
      "name": "authenticate_user",
      "file": "auth.py",
      "start_line": 15,
      "end_line": 45,
      "complexity": {
        "cyclomatic": 8,
        "cognitive": 12,
        "halstead": {
          "difficulty": 15.2,
          "volume": 1250.5,
          "effort": 19008.0
        }
      },
      "side_effects": [
        "database_read",
        "session_create",
        "log_write"
      ],
      "runtime_hotness": 0.85,
      "contracts": {
        "input": {
          "email": "str",
          "password": "str"
        },
        "output": "Optional[User]"
      },
      "documentation": {
        "has_docstring": true,
        "docstring_length": 150,
        "has_type_hints": true
      }
    }
  },
  "files": {
    "auth.py": {
      "path": "auth.py",
      "language": "python",
      "line_count": 450,
      "function_count": 12,
      "complexity_score": 85.5,
      "side_effects_count": 8,
      "documentation_coverage": 0.75
    }
  },
  "modules": {
    "authentication": {
      "name": "authentication",
      "files": ["auth.py", "session.py"],
      "functions": 25,
      "complexity_score": 120.5,
      "dependencies": ["database", "logging"]
    }
  },
  "relationships": {
    "call_graph": [
      {
        "caller": "auth.py:authenticate_user",
        "callee": "auth.py:verify_password",
        "call_type": "direct",
        "frequency": 100
      }
    ],
    "dependencies": [
      {
        "source": "auth.py",
        "target": "database.py",
        "type": "import",
        "strength": 0.8
      }
    ]
  }
}
```

### Complete Lens Example

```json
{
  "$schema": "./schemas/lens-schema.json",
  "version": "1.0",
  "lens": {
    "name": "User Authentication Flow",
    "description": "Focus on user authentication and session management",
    "seeds": ["auth.py:authenticate_user", "session.py:create_session"],
    "created_at": "2024-01-15T10:00:00Z",
    "updated_at": "2024-01-15T10:30:00Z",
    "tags": ["authentication", "security", "backend"]
  },
  "functions": {
    "auth.py:authenticate_user": {
      "name": "authenticate_user",
      "complexity": {"cyclomatic": 8},
      "side_effects": ["database_read", "session_create"],
      "runtime_hotness": 0.85,
      "is_in_lens": true,
      "lens_reason": "seed_function"
    }
  },
  "visualization": {
    "layout": "hierarchical",
    "highlight_functions": ["auth.py:authenticate_user"],
    "focus_area": "authentication"
  }
}
```

## Best Practices

1. **Always validate**: Use schemas to validate data before processing
2. **Version control**: Include schema version in all data files
3. **IDE integration**: Configure your editor for schema validation
4. **Error handling**: Provide meaningful error messages for validation failures
5. **Documentation**: Keep schemas up-to-date with code changes
6. **Testing**: Include schema validation in your test suite

## Troubleshooting

### Common Validation Errors

1. **Missing required fields**: Ensure all required properties are present
2. **Invalid types**: Check that values match expected types (string, number, boolean)
3. **Enum violations**: Verify enum values are from allowed list
4. **Format errors**: Ensure date-time and other formatted fields are correct

### Debugging Tips

1. **Use schema validator**: Run `python schemas/validate_schemas.py`
2. **Check examples**: Compare your data with schema examples
3. **Incremental validation**: Validate individual sections to isolate errors
4. **Schema inspection**: Use tools to explore schema structure

## Contributing

When modifying schemas:

1. **Update version**: Increment schema version for breaking changes
2. **Add examples**: Include comprehensive examples for new features
3. **Update documentation**: Keep this reference up-to-date
4. **Test validation**: Ensure all examples validate correctly
5. **Backward compatibility**: Consider migration paths for existing data
