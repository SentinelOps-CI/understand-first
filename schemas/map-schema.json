{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "https://understand-first.dev/schemas/map-schema.json",
  "title": "Understand-First Repository Map",
  "description": "Schema for repository maps generated by `u scan` command",
  "type": "object",
  "required": ["version", "repository", "functions", "files"],
  "properties": {
    "version": {
      "type": "string",
      "description": "Schema version",
      "enum": ["1.0"],
      "default": "1.0"
    },
    "repository": {
      "type": "object",
      "description": "Repository metadata",
      "required": ["name", "path", "scan_timestamp"],
      "properties": {
        "name": {
          "type": "string",
          "description": "Repository name"
        },
        "path": {
          "type": "string",
          "description": "Repository root path"
        },
        "scan_timestamp": {
          "type": "string",
          "format": "date-time",
          "description": "When the scan was performed"
        },
        "commit_hash": {
          "type": "string",
          "description": "Git commit hash at scan time"
        },
        "language": {
          "type": "string",
          "description": "Primary programming language",
          "enum": ["python", "javascript", "typescript", "go", "rust", "java", "csharp", "mixed"]
        },
        "total_files": {
          "type": "integer",
          "description": "Total number of files scanned"
        },
        "total_functions": {
          "type": "integer",
          "description": "Total number of functions found"
        }
      }
    },
    "functions": {
      "type": "object",
      "description": "Map of function qualified names to function metadata",
      "patternProperties": {
        "^[^:]+:[^:]+$": {
          "type": "object",
          "description": "Function metadata",
          "required": ["name", "file", "line", "type"],
          "properties": {
            "name": {
              "type": "string",
              "description": "Function name"
            },
            "file": {
              "type": "string",
              "description": "File path relative to repository root"
            },
            "line": {
              "type": "integer",
              "description": "Line number where function is defined"
            },
            "type": {
              "type": "string",
              "description": "Function type",
              "enum": ["function", "method", "class", "constructor", "async_function", "generator"]
            },
            "signature": {
              "type": "string",
              "description": "Function signature with parameters"
            },
            "docstring": {
              "type": "string",
              "description": "Function documentation string"
            },
            "complexity": {
              "type": "number",
              "description": "Cyclomatic complexity score",
              "minimum": 1
            },
            "lines": {
              "type": "integer",
              "description": "Number of lines in function body",
              "minimum": 1
            },
            "parameters": {
              "type": "array",
              "description": "Function parameters",
              "items": {
                "type": "object",
                "properties": {
                  "name": {"type": "string"},
                  "type": {"type": "string"},
                  "default": {"type": "string"}
                }
              }
            },
            "return_type": {
              "type": "string",
              "description": "Function return type"
            },
            "calls": {
              "type": "array",
              "description": "Functions called by this function",
              "items": {
                "type": "string"
              }
            },
            "callers": {
              "type": "array",
              "description": "Functions that call this function",
              "items": {
                "type": "string"
              }
            },
            "side_effects": {
              "type": "array",
              "description": "Side effects performed by this function",
              "items": {
                "type": "string",
                "enum": ["file_read", "file_write", "network_request", "database_query", "cache_operation", "logging", "exception_raised"]
              }
            },
            "imports": {
              "type": "array",
              "description": "Modules imported by this function's file",
              "items": {
                "type": "string"
              }
            },
            "decorators": {
              "type": "array",
              "description": "Decorators applied to this function",
              "items": {
                "type": "string"
              }
            },
            "is_async": {
              "type": "boolean",
              "description": "Whether this is an async function"
            },
            "is_generator": {
              "type": "boolean",
              "description": "Whether this is a generator function"
            },
            "visibility": {
              "type": "string",
              "description": "Function visibility",
              "enum": ["public", "protected", "private", "internal"]
            },
            "tags": {
              "type": "array",
              "description": "Custom tags for categorization",
              "items": {
                "type": "string"
              }
            }
          }
        }
      }
    },
    "files": {
      "type": "object",
      "description": "Map of file paths to file metadata",
      "patternProperties": {
        "^.+$": {
          "type": "object",
          "description": "File metadata",
          "required": ["path", "language", "line_count"],
          "properties": {
            "path": {
              "type": "string",
              "description": "File path relative to repository root"
            },
            "language": {
              "type": "string",
              "description": "Programming language",
              "enum": ["python", "javascript", "typescript", "go", "rust", "java", "csharp", "css", "html", "markdown", "yaml", "json"]
            },
            "line_count": {
              "type": "integer",
              "description": "Total number of lines in file",
              "minimum": 0
            },
            "function_count": {
              "type": "integer",
              "description": "Number of functions defined in file",
              "minimum": 0
            },
            "complexity": {
              "type": "number",
              "description": "Average complexity of functions in file",
              "minimum": 0
            },
            "imports": {
              "type": "array",
              "description": "External imports",
              "items": {
                "type": "string"
              }
            },
            "exports": {
              "type": "array",
              "description": "Exported symbols",
              "items": {
                "type": "string"
              }
            },
            "dependencies": {
              "type": "array",
              "description": "File dependencies",
              "items": {
                "type": "string"
              }
            },
            "test_file": {
              "type": "boolean",
              "description": "Whether this is a test file"
            },
            "main_file": {
              "type": "boolean",
              "description": "Whether this is a main entry point"
            },
            "config_file": {
              "type": "boolean",
              "description": "Whether this is a configuration file"
            },
            "documentation": {
              "type": "boolean",
              "description": "Whether this file contains documentation"
            },
            "last_modified": {
              "type": "string",
              "format": "date-time",
              "description": "Last modification timestamp"
            },
            "size_bytes": {
              "type": "integer",
              "description": "File size in bytes",
              "minimum": 0
            }
          }
        }
      }
    },
    "modules": {
      "type": "object",
      "description": "Module/package structure",
      "patternProperties": {
        "^.+$": {
          "type": "object",
          "description": "Module metadata",
          "properties": {
            "name": {"type": "string"},
            "path": {"type": "string"},
            "type": {
              "type": "string",
              "enum": ["package", "module", "namespace"]
            },
            "functions": {
              "type": "array",
              "items": {"type": "string"}
            },
            "submodules": {
              "type": "array",
              "items": {"type": "string"}
            }
          }
        }
      }
    },
    "relationships": {
      "type": "object",
      "description": "Relationships between code entities",
      "properties": {
        "inheritance": {
          "type": "array",
          "description": "Class inheritance relationships",
          "items": {
            "type": "object",
            "properties": {
              "child": {"type": "string"},
              "parent": {"type": "string"}
            }
          }
        },
        "composition": {
          "type": "array",
          "description": "Composition relationships",
          "items": {
            "type": "object",
            "properties": {
              "container": {"type": "string"},
              "contained": {"type": "string"}
            }
          }
        },
        "aggregation": {
          "type": "array",
          "description": "Aggregation relationships",
          "items": {
            "type": "object",
            "properties": {
              "aggregator": {"type": "string"},
              "aggregated": {"type": "string"}
            }
          }
        }
      }
    },
    "metadata": {
      "type": "object",
      "description": "Additional metadata",
      "properties": {
        "scan_duration_ms": {
          "type": "number",
          "description": "Time taken to scan repository in milliseconds"
        },
        "scanner_version": {
          "type": "string",
          "description": "Version of the scanner used"
        },
        "config": {
          "type": "object",
          "description": "Configuration used for scanning"
        },
        "warnings": {
          "type": "array",
          "description": "Warnings generated during scanning",
          "items": {
            "type": "object",
            "properties": {
              "message": {"type": "string"},
              "file": {"type": "string"},
              "line": {"type": "integer"},
              "severity": {
                "type": "string",
                "enum": ["info", "warning", "error"]
              }
            }
          }
        },
        "errors": {
          "type": "array",
          "description": "Errors encountered during scanning",
          "items": {
            "type": "object",
            "properties": {
              "message": {"type": "string"},
              "file": {"type": "string"},
              "line": {"type": "integer"},
              "error_type": {"type": "string"}
            }
          }
        }
      }
    }
  },
  "additionalProperties": false,
  "examples": [
    {
      "version": "1.0",
      "repository": {
        "name": "my-project",
        "path": "/path/to/my-project",
        "scan_timestamp": "2024-01-15T10:30:00Z",
        "commit_hash": "abc123def456",
        "language": "python",
        "total_files": 25,
        "total_functions": 45
      },
      "functions": {
        "main.py:compute": {
          "name": "compute",
          "file": "main.py",
          "line": 10,
          "type": "function",
          "signature": "compute(x: int, y: int) -> int",
          "complexity": 3,
          "lines": 15,
          "parameters": [
            {"name": "x", "type": "int"},
            {"name": "y", "type": "int"}
          ],
          "return_type": "int",
          "calls": ["main.py:add", "main.py:log"],
          "callers": ["main.py:main"],
          "side_effects": ["logging"],
          "is_async": false,
          "visibility": "public"
        }
      },
      "files": {
        "main.py": {
          "path": "main.py",
          "language": "python",
          "line_count": 50,
          "function_count": 3,
          "complexity": 2.5,
          "test_file": false,
          "main_file": true
        }
      }
    }
  ]
}
