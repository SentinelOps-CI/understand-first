{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "https://understand-first.dev/schemas/tour-schema.json",
  "title": "Understand-First Understanding Tour",
  "description": "Schema for understanding tours generated by `u tour` command",
  "type": "object",
  "required": ["version", "tour", "steps"],
  "properties": {
    "version": {
      "type": "string",
      "description": "Schema version",
      "enum": ["1.0"],
      "default": "1.0"
    },
    "tour": {
      "type": "object",
      "description": "Tour metadata and configuration",
      "required": ["name", "created_at"],
      "properties": {
        "name": {
          "type": "string",
          "description": "Human-readable name for this tour"
        },
        "description": {
          "type": "string",
          "description": "Description of what this tour teaches"
        },
        "created_at": {
          "type": "string",
          "format": "date-time",
          "description": "When this tour was created"
        },
        "updated_at": {
          "type": "string",
          "format": "date-time",
          "description": "When this tour was last updated"
        },
        "author": {
          "type": "string",
          "description": "Tour author"
        },
        "estimated_duration_minutes": {
          "type": "integer",
          "description": "Estimated time to complete tour",
          "minimum": 1
        },
        "difficulty": {
          "type": "string",
          "enum": ["beginner", "intermediate", "advanced"],
          "description": "Tour difficulty level"
        },
        "tags": {
          "type": "array",
          "description": "Tour tags for categorization",
          "items": {"type": "string"}
        },
        "prerequisites": {
          "type": "array",
          "description": "Prerequisites for this tour",
          "items": {"type": "string"}
        },
        "learning_objectives": {
          "type": "array",
          "description": "What users will learn from this tour",
          "items": {"type": "string"}
        },
        "source": {
          "type": "object",
          "description": "Source of tour generation",
          "properties": {
            "type": {
              "type": "string",
              "enum": ["manual", "auto", "lens", "trace"],
              "description": "How this tour was generated"
            },
            "lens_name": {"type": "string"},
            "trace_name": {"type": "string"},
            "seed_functions": {
              "type": "array",
              "items": {"type": "string"}
            },
            "focus_areas": {
              "type": "array",
              "items": {"type": "string"}
            }
          }
        },
        "config": {
          "type": "object",
          "description": "Tour configuration options",
          "properties": {
            "max_steps": {"type": "integer"},
            "include_side_effects": {"type": "boolean"},
            "include_tests": {"type": "boolean"},
            "include_documentation": {"type": "boolean"},
            "group_by_module": {"type": "boolean"},
            "show_complexity": {"type": "boolean"},
            "show_performance": {"type": "boolean"},
            "interactive_mode": {"type": "boolean"},
            "auto_advance": {"type": "boolean"},
            "step_timeout_seconds": {"type": "integer"}
          }
        }
      }
    },
    "steps": {
      "type": "array",
      "description": "Tour steps in order",
      "minItems": 1,
      "items": {
        "type": "object",
        "required": ["id", "title", "content", "type"],
        "properties": {
          "id": {
            "type": "string",
            "description": "Unique step identifier"
          },
          "title": {
            "type": "string",
            "description": "Step title"
          },
          "content": {
            "type": "object",
            "description": "Step content and instructions",
            "required": ["text"],
            "properties": {
              "text": {
                "type": "string",
                "description": "Main step description"
              },
              "code_blocks": {
                "type": "array",
                "description": "Code examples and snippets",
                "items": {
                  "type": "object",
                  "required": ["code", "language"],
                  "properties": {
                    "code": {"type": "string"},
                    "language": {"type": "string"},
                    "file": {"type": "string"},
                    "start_line": {"type": "integer"},
                    "end_line": {"type": "integer"},
                    "highlight_lines": {
                      "type": "array",
                      "items": {"type": "integer"}
                    },
                    "description": {"type": "string"}
                  }
                }
              },
              "diagrams": {
                "type": "array",
                "description": "Diagrams and visual aids",
                "items": {
                  "type": "object",
                  "properties": {
                    "type": {"type": "string", "enum": ["mermaid", "dot", "svg", "image"]},
                    "content": {"type": "string"},
                    "description": {"type": "string"},
                    "width": {"type": "integer"},
                    "height": {"type": "integer"}
                  }
                }
              },
              "tasks": {
                "type": "array",
                "description": "Interactive tasks for this step",
                "items": {
                  "type": "object",
                  "properties": {
                    "type": {"type": "string", "enum": ["read", "modify", "test", "analyze", "quiz"]},
                    "description": {"type": "string"},
                    "expected_outcome": {"type": "string"},
                    "hints": {"type": "array", "items": {"type": "string"}},
                    "validation": {"type": "object"}
                  }
                }
              },
              "resources": {
                "type": "array",
                "description": "Additional resources and links",
                "items": {
                  "type": "object",
                  "properties": {
                    "title": {"type": "string"},
                    "url": {"type": "string"},
                    "type": {"type": "string", "enum": ["documentation", "tutorial", "example", "reference"]}
                  }
                }
              }
            }
          },
          "type": {
            "type": "string",
            "enum": ["overview", "concept", "function", "module", "flow", "example", "exercise", "summary"],
            "description": "Type of tour step"
          },
          "focus": {
            "type": "object",
            "description": "What this step focuses on",
            "properties": {
              "functions": {
                "type": "array",
                "items": {"type": "string"}
              },
              "files": {
                "type": "array",
                "items": {"type": "string"}
              },
              "modules": {
                "type": "array",
                "items": {"type": "string"}
              },
              "concepts": {
                "type": "array",
                "items": {"type": "string"}
              }
            }
          },
          "navigation": {
            "type": "object",
            "description": "Navigation and flow control",
            "properties": {
              "previous_step": {"type": "string"},
              "next_step": {"type": "string"},
              "branching": {
                "type": "object",
                "description": "Conditional navigation based on user choices"
              },
              "can_skip": {"type": "boolean"},
              "is_optional": {"type": "boolean"},
              "prerequisite_steps": {
                "type": "array",
                "items": {"type": "string"}
              }
            }
          },
          "visualization": {
            "type": "object",
            "description": "Visual elements for this step",
            "properties": {
              "highlight_functions": {
                "type": "array",
                "items": {"type": "string"}
              },
              "highlight_files": {
                "type": "array",
                "items": {"type": "string"}
              },
              "zoom_to": {
                "type": "object",
                "properties": {
                  "functions": {"type": "array", "items": {"type": "string"}},
                  "files": {"type": "array", "items": {"type": "string"}},
                  "modules": {"type": "array", "items": {"type": "string"}}
                }
              },
              "filter": {
                "type": "object",
                "properties": {
                  "show_only": {"type": "array", "items": {"type": "string"}},
                  "hide": {"type": "array", "items": {"type": "string"}},
                  "complexity_threshold": {"type": "integer"},
                  "show_side_effects": {"type": "boolean"}
                }
              },
              "animation": {
                "type": "object",
                "properties": {
                  "type": {"type": "string", "enum": ["highlight", "pulse", "trace", "flow"]},
                  "duration_ms": {"type": "integer"},
                  "repeat": {"type": "integer"}
                }
              }
            }
          },
          "assessment": {
            "type": "object",
            "description": "Assessment and validation for this step",
            "properties": {
              "questions": {
                "type": "array",
                "items": {
                  "type": "object",
                  "properties": {
                    "question": {"type": "string"},
                    "type": {"type": "string", "enum": ["multiple_choice", "true_false", "open_ended"]},
                    "options": {"type": "array", "items": {"type": "string"}},
                    "correct_answer": {"type": "string"},
                    "explanation": {"type": "string"}
                  }
                }
              },
              "code_challenges": {
                "type": "array",
                "items": {
                  "type": "object",
                  "properties": {
                    "description": {"type": "string"},
                    "starter_code": {"type": "string"},
                    "test_cases": {"type": "array"},
                    "solution": {"type": "string"}
                  }
                }
              },
              "completion_criteria": {
                "type": "object",
                "properties": {
                  "must_read": {"type": "array", "items": {"type": "string"}},
                  "must_modify": {"type": "array", "items": {"type": "string"}},
                  "must_test": {"type": "array", "items": {"type": "string"}},
                  "time_limit_minutes": {"type": "integer"}
                }
              }
            }
          },
          "metadata": {
            "type": "object",
            "description": "Additional step metadata",
            "properties": {
              "created_at": {"type": "string", "format": "date-time"},
              "updated_at": {"type": "string", "format": "date-time"},
              "estimated_time_minutes": {"type": "integer"},
              "difficulty": {"type": "string", "enum": ["easy", "medium", "hard"]},
              "tags": {"type": "array", "items": {"type": "string"}},
              "version": {"type": "string"}
            }
          }
        }
      }
    },
    "progress": {
      "type": "object",
      "description": "Tour progress tracking",
      "properties": {
        "current_step": {"type": "string"},
        "completed_steps": {"type": "array", "items": {"type": "string"}},
        "skipped_steps": {"type": "array", "items": {"type": "string"}},
        "started_at": {"type": "string", "format": "date-time"},
        "last_activity": {"type": "string", "format": "date-time"},
        "total_time_minutes": {"type": "number"},
        "step_times": {
          "type": "object",
          "patternProperties": {
            "^.*$": {"type": "number"}
          }
        },
        "bookmarks": {
          "type": "array",
          "items": {
            "type": "object",
            "properties": {
              "step_id": {"type": "string"},
              "note": {"type": "string"},
              "created_at": {"type": "string", "format": "date-time"}
            }
          }
        },
        "notes": {
          "type": "array",
          "items": {
            "type": "object",
            "properties": {
              "step_id": {"type": "string"},
              "content": {"type": "string"},
              "created_at": {"type": "string", "format": "date-time"}
            }
          }
        }
      }
    },
    "analytics": {
      "type": "object",
      "description": "Tour analytics and metrics",
      "properties": {
        "completion_rate": {"type": "number", "minimum": 0, "maximum": 1},
        "average_time_minutes": {"type": "number"},
        "drop_off_points": {
          "type": "array",
          "items": {"type": "string"}
        },
        "most_difficult_steps": {
          "type": "array",
          "items": {
            "type": "object",
            "properties": {
              "step_id": {"type": "string"},
              "difficulty_score": {"type": "number"}
            }
          }
        },
        "user_feedback": {
          "type": "array",
          "items": {
            "type": "object",
            "properties": {
              "step_id": {"type": "string"},
              "rating": {"type": "integer", "minimum": 1, "maximum": 5},
              "comment": {"type": "string"},
              "timestamp": {"type": "string", "format": "date-time"}
            }
          }
        }
      }
    },
    "export": {
      "type": "object",
      "description": "Export options and formats",
      "properties": {
        "formats": {
          "type": "array",
          "items": {
            "type": "string",
            "enum": ["markdown", "html", "pdf", "json", "slides"]
          }
        },
        "templates": {
          "type": "object",
          "properties": {
            "markdown": {"type": "string"},
            "html": {"type": "string"},
            "pdf": {"type": "string"}
          }
        },
        "include_code": {"type": "boolean"},
        "include_diagrams": {"type": "boolean"},
        "include_progress": {"type": "boolean"},
        "include_analytics": {"type": "boolean"}
      }
    },
    "metadata": {
      "type": "object",
      "description": "Additional tour metadata",
      "properties": {
        "generated_at": {"type": "string", "format": "date-time"},
        "generator_version": {"type": "string"},
        "tour_file": {"type": "string"},
        "source_repository": {"type": "string"},
        "warnings": {
          "type": "array",
          "items": {
            "type": "object",
            "properties": {
              "message": {"type": "string"},
              "severity": {"type": "string"}
            }
          }
        }
      }
    }
  },
  "additionalProperties": false,
  "examples": [
    {
      "version": "1.0",
      "tour": {
        "name": "Authentication Flow Tour",
        "description": "Learn how user authentication works in our system",
        "created_at": "2024-01-15T10:00:00Z",
        "author": "system",
        "estimated_duration_minutes": 15,
        "difficulty": "intermediate",
        "tags": ["authentication", "security", "backend"],
        "learning_objectives": [
          "Understand the authentication flow",
          "Identify security considerations",
          "Learn about session management"
        ]
      },
      "steps": [
        {
          "id": "step-001",
          "title": "Authentication Overview",
          "type": "overview",
          "content": {
            "text": "This tour will walk you through the authentication system, showing how users log in and how sessions are managed.",
            "code_blocks": [
              {
                "code": "def authenticate_user(email, password):\n    user = get_user_by_email(email)\n    if user and verify_password(password, user.password_hash):\n        return create_session(user)\n    return None",
                "language": "python",
                "file": "auth.py",
                "start_line": 10,
                "end_line": 15
              }
            ]
          },
          "focus": {
            "functions": ["auth.py:authenticate_user"]
          }
        }
      ]
    }
  ]
}
