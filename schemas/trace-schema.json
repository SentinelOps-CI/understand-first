{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "https://understand-first.dev/schemas/trace-schema.json",
  "title": "Understand-First Runtime Trace",
  "description": "Schema for runtime traces generated by `u trace` command",
  "type": "object",
  "required": ["version", "trace", "functions", "execution"],
  "properties": {
    "version": {
      "type": "string",
      "description": "Schema version",
      "enum": ["1.0"],
      "default": "1.0"
    },
    "trace": {
      "type": "object",
      "description": "Trace metadata and configuration",
      "required": ["name", "start_time", "end_time"],
      "properties": {
        "name": {
          "type": "string",
          "description": "Human-readable name for this trace"
        },
        "description": {
          "type": "string",
          "description": "Description of what was traced"
        },
        "start_time": {
          "type": "string",
          "format": "date-time",
          "description": "When tracing started"
        },
        "end_time": {
          "type": "string",
          "format": "date-time",
          "description": "When tracing ended"
        },
        "duration_ms": {
          "type": "number",
          "description": "Total trace duration in milliseconds"
        },
        "entry_point": {
          "type": "object",
          "description": "Entry point function that was traced",
          "required": ["file", "function", "args"],
          "properties": {
            "file": {"type": "string"},
            "function": {"type": "string"},
            "args": {"type": "array"},
            "kwargs": {"type": "object"}
          }
        },
        "environment": {
          "type": "object",
          "description": "Runtime environment information",
          "properties": {
            "python_version": {"type": "string"},
            "platform": {"type": "string"},
            "hostname": {"type": "string"},
            "process_id": {"type": "integer"},
            "thread_id": {"type": "integer"}
          }
        },
        "config": {
          "type": "object",
          "description": "Trace configuration",
          "properties": {
            "max_depth": {"type": "integer"},
            "include_line_numbers": {"type": "boolean"},
            "include_variables": {"type": "boolean"},
            "include_timing": {"type": "boolean"},
            "include_memory": {"type": "boolean"},
            "filter_patterns": {"type": "array", "items": {"type": "string"}}
          }
        }
      }
    },
    "execution": {
      "type": "object",
      "description": "Execution trace data",
      "required": ["calls", "timeline"],
      "properties": {
        "calls": {
          "type": "array",
          "description": "Function calls in execution order",
          "items": {
            "type": "object",
            "required": ["id", "function", "timestamp", "type"],
            "properties": {
              "id": {
                "type": "string",
                "description": "Unique call identifier"
              },
              "function": {
                "type": "string",
                "description": "Qualified function name (file:function)"
              },
              "timestamp": {
                "type": "string",
                "format": "date-time",
                "description": "When this call occurred"
              },
              "type": {
                "type": "string",
                "enum": ["call", "return", "exception"],
                "description": "Type of execution event"
              },
              "depth": {
                "type": "integer",
                "description": "Call stack depth",
                "minimum": 0
              },
              "parent_call": {
                "type": "string",
                "description": "ID of parent call"
              },
              "args": {
                "type": "array",
                "description": "Function arguments"
              },
              "kwargs": {
                "type": "object",
                "description": "Function keyword arguments"
              },
              "return_value": {
                "description": "Function return value"
              },
              "exception": {
                "type": "object",
                "description": "Exception information (if applicable)",
                "properties": {
                  "type": {"type": "string"},
                  "message": {"type": "string"},
                  "traceback": {"type": "array", "items": {"type": "string"}}
                }
              },
              "line_number": {
                "type": "integer",
                "description": "Line number where call occurred"
              },
              "execution_time_ms": {
                "type": "number",
                "description": "Time spent in this call"
              },
              "memory_before_mb": {
                "type": "number",
                "description": "Memory usage before call"
              },
              "memory_after_mb": {
                "type": "number",
                "description": "Memory usage after call"
              },
              "cpu_percent": {
                "type": "number",
                "description": "CPU usage percentage"
              },
              "variables": {
                "type": "object",
                "description": "Local variables (if captured)"
              }
            }
          }
        },
        "timeline": {
          "type": "array",
          "description": "Chronological execution timeline",
          "items": {
            "type": "object",
            "required": ["timestamp", "event", "call_id"],
            "properties": {
              "timestamp": {"type": "string", "format": "date-time"},
              "event": {"type": "string"},
              "call_id": {"type": "string"},
              "data": {"type": "object"}
            }
          }
        },
        "call_stack": {
          "type": "array",
          "description": "Maximum call stack during execution",
          "items": {
            "type": "string"
          }
        },
        "hot_paths": {
          "type": "array",
          "description": "Identified hot execution paths",
          "items": {
            "type": "object",
            "required": ["functions", "frequency", "total_time_ms"],
            "properties": {
              "functions": {
                "type": "array",
                "items": {"type": "string"}
              },
              "frequency": {"type": "integer"},
              "total_time_ms": {"type": "number"},
              "avg_time_ms": {"type": "number"},
              "percentage": {"type": "number"}
            }
          }
        }
      }
    },
    "functions": {
      "type": "object",
      "description": "Function execution statistics",
      "patternProperties": {
        "^[^:]+:[^:]+$": {
          "type": "object",
          "description": "Function execution statistics",
          "required": ["name", "call_count", "total_time_ms"],
          "properties": {
            "name": {"type": "string"},
            "call_count": {
              "type": "integer",
              "description": "Number of times this function was called",
              "minimum": 0
            },
            "total_time_ms": {
              "type": "number",
              "description": "Total time spent in this function",
              "minimum": 0
            },
            "avg_time_ms": {
              "type": "number",
              "description": "Average time per call",
              "minimum": 0
            },
            "min_time_ms": {
              "type": "number",
              "description": "Minimum call time",
              "minimum": 0
            },
            "max_time_ms": {
              "type": "number",
              "description": "Maximum call time",
              "minimum": 0
            },
            "total_memory_mb": {
              "type": "number",
              "description": "Total memory allocated"
            },
            "avg_memory_mb": {
              "type": "number",
              "description": "Average memory per call"
            },
            "exception_count": {
              "type": "integer",
              "description": "Number of exceptions thrown",
              "minimum": 0
            },
            "is_hot": {
              "type": "boolean",
              "description": "Whether this function is a hot path"
            },
            "hot_score": {
              "type": "number",
              "description": "Hot path score (0-1)",
              "minimum": 0,
              "maximum": 1
            },
            "call_chain_depth": {
              "type": "integer",
              "description": "Maximum depth in call chain"
            },
            "callers": {
              "type": "array",
              "description": "Functions that called this function",
              "items": {"type": "string"}
            },
            "callees": {
              "type": "array",
              "description": "Functions called by this function",
              "items": {"type": "string"}
            },
            "execution_profile": {
              "type": "object",
              "description": "Detailed execution profile",
              "properties": {
                "cpu_intensive": {"type": "boolean"},
                "memory_intensive": {"type": "boolean"},
                "io_intensive": {"type": "boolean"},
                "bottleneck": {"type": "boolean"}
              }
            }
          }
        }
      }
    },
    "performance": {
      "type": "object",
      "description": "Performance metrics and analysis",
      "properties": {
        "total_execution_time_ms": {"type": "number"},
        "total_memory_peak_mb": {"type": "number"},
        "total_cpu_percent": {"type": "number"},
        "function_count": {"type": "integer"},
        "call_count": {"type": "integer"},
        "exception_count": {"type": "integer"},
        "hot_path_count": {"type": "integer"},
        "bottlenecks": {
          "type": "array",
          "description": "Identified performance bottlenecks",
          "items": {
            "type": "object",
            "properties": {
              "function": {"type": "string"},
              "type": {"type": "string", "enum": ["cpu", "memory", "io", "complexity"]},
              "severity": {"type": "string", "enum": ["low", "medium", "high", "critical"]},
              "description": {"type": "string"},
              "recommendation": {"type": "string"}
            }
          }
        },
        "optimization_opportunities": {
          "type": "array",
          "description": "Suggested optimization opportunities",
          "items": {
            "type": "object",
            "properties": {
              "function": {"type": "string"},
              "opportunity": {"type": "string"},
              "potential_savings": {"type": "string"},
              "effort": {"type": "string", "enum": ["low", "medium", "high"]}
            }
          }
        }
      }
    },
    "errors": {
      "type": "array",
      "description": "Errors and exceptions encountered during tracing",
      "items": {
        "type": "object",
        "required": ["timestamp", "type", "message", "function"],
        "properties": {
          "timestamp": {"type": "string", "format": "date-time"},
          "type": {"type": "string"},
          "message": {"type": "string"},
          "function": {"type": "string"},
          "line_number": {"type": "integer"},
          "call_id": {"type": "string"},
          "traceback": {"type": "array", "items": {"type": "string"}},
          "severity": {"type": "string", "enum": ["info", "warning", "error", "critical"]}
        }
      }
    },
    "metadata": {
      "type": "object",
      "description": "Additional trace metadata",
      "properties": {
        "generated_at": {"type": "string", "format": "date-time"},
        "generator_version": {"type": "string"},
        "trace_file": {"type": "string"},
        "source_files": {"type": "array", "items": {"type": "string"}},
        "warnings": {
          "type": "array",
          "items": {
            "type": "object",
            "properties": {
              "message": {"type": "string"},
              "severity": {"type": "string"}
            }
          }
        }
      }
    }
  },
  "additionalProperties": false,
  "examples": [
    {
      "version": "1.0",
      "trace": {
        "name": "Authentication Flow Trace",
        "description": "Trace of user authentication process",
        "start_time": "2024-01-15T10:30:00Z",
        "end_time": "2024-01-15T10:30:02Z",
        "duration_ms": 2000,
        "entry_point": {
          "file": "auth.py",
          "function": "authenticate_user",
          "args": ["john@example.com", "password123"]
        },
        "environment": {
          "python_version": "3.9.0",
          "platform": "linux",
          "hostname": "server-01"
        }
      },
      "execution": {
        "calls": [
          {
            "id": "call-001",
            "function": "auth.py:authenticate_user",
            "timestamp": "2024-01-15T10:30:00Z",
            "type": "call",
            "depth": 0,
            "args": ["john@example.com", "password123"],
            "execution_time_ms": 150.5
          }
        ],
        "hot_paths": [
          {
            "functions": ["auth.py:validate_token", "auth.py:get_user"],
            "frequency": 5,
            "total_time_ms": 750.0,
            "avg_time_ms": 150.0,
            "percentage": 37.5
          }
        ]
      },
      "functions": {
        "auth.py:authenticate_user": {
          "name": "authenticate_user",
          "call_count": 1,
          "total_time_ms": 150.5,
          "avg_time_ms": 150.5,
          "is_hot": true,
          "hot_score": 0.8
        }
      },
      "performance": {
        "total_execution_time_ms": 2000,
        "total_memory_peak_mb": 45.2,
        "function_count": 8,
        "call_count": 12,
        "hot_path_count": 2
      }
    }
  ]
}
