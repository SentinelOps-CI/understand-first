<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Understand-First Web Playground</title>
    <meta name="description" content="Interactive demonstration of Understand-First's code analysis and understanding capabilities. Test static analysis, complexity metrics, and code visualization tools.">
    <meta name="keywords" content="code analysis, static analysis, code visualization, developer tools, code understanding, complexity metrics">
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect width='80' height='80' x='10' y='10' fill='%23333' rx='8'/><text x='50' y='60' text-anchor='middle' fill='white' font-family='monospace' font-size='24'>UF</text></svg>">
    <script src="https://unpkg.com/cytoscape@3.26.0/dist/cytoscape.min.js"></script>
    <script src="https://unpkg.com/dagre@0.8.5/dist/dagre.min.js"></script>
    <script src="https://unpkg.com/cytoscape-dagre@2.5.0/cytoscape-dagre.js"></script>
    <script src="performance.js"></script>
    <script src="memory-manager.js"></script>
    <script src="virtual-scroll.js"></script>
    <script src="ttu-ttfsc-optimizer.js"></script>
    <script src="lighthouse-integration.js"></script>
    <script src="accessibility-validator.js"></script>
    <script src="assistive-technology-tester.js"></script>
    <link rel="stylesheet" href="design-system.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            line-height: 1.6;
            color: #2c3e50;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            min-height: 100vh;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            color: #2c3e50;
            margin-bottom: 40px;
            background: white;
            padding: 40px;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 15px;
            font-weight: 700;
            color: #1a252f;
        }

        .header p {
            font-size: 1.1rem;
            color: #6c757d;
            max-width: 600px;
            margin: 0 auto;
        }

        .demo-section {
            background: white;
            border-radius: 12px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }

        .demo-section h2 {
            color: #1a252f;
            margin-bottom: 20px;
            font-size: 1.8rem;
            font-weight: 600;
            border-bottom: 2px solid #e9ecef;
            padding-bottom: 10px;
        }

        .code-input {
            width: 100%;
            height: 200px;
            padding: 15px;
            border: 2px solid #e1e8ed;
            border-radius: 8px;
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            font-size: 14px;
            resize: vertical;
            background: #f8f9fa;
        }

        .code-input:focus {
            outline: none;
            border-color: #495057;
            box-shadow: 0 0 0 3px rgba(73, 80, 87, 0.1);
        }

        .code-input::placeholder {
            color: #adb5bd;
            font-style: italic;
        }

        .code-input:empty::before {
            content: "Paste Python code here and press ⌘⏎ to analyze...";
            color: #adb5bd;
            font-style: italic;
        }

        .analyze-btn {
            background: #495057;
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            margin: 15px 0;
            transition: all 0.2s;
        }

        .analyze-btn:hover {
            background: #343a40;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(73, 80, 87, 0.3);
        }

        .analyze-btn:active {
            transform: translateY(0);
        }

        .results {
            margin-top: 20px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid #495057;
        }

        .results h3 {
            color: #1a252f;
            margin-bottom: 15px;
            font-weight: 600;
        }

        .function-item {
            background: white;
            padding: 15px;
            margin: 10px 0;
            border-radius: 6px;
            border: 1px solid #e1e8ed;
            transition: box-shadow 0.2s;
        }

        .function-item:hover {
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .function-name {
            font-weight: 600;
            color: #1a252f;
            margin-bottom: 5px;
        }

        .function-details {
            font-size: 14px;
            color: #666;
        }

        .complexity {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
            margin-left: 10px;
        }

        .complexity.low { background: #d1ecf1; color: #0c5460; }
        .complexity.medium { background: #fff3cd; color: #856404; }
        .complexity.high { background: #f8d7da; color: #721c24; }

        .tour-section {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 20px;
            margin-top: 20px;
        }

        .tour-step {
            background: white;
            padding: 15px;
            margin: 10px 0;
            border-radius: 6px;
            border-left: 4px solid #495057;
        }

        .tour-step h4 {
            color: #495057;
            margin-bottom: 8px;
            font-weight: 600;
        }

        /* Onboarding Wizard Styles */
        .onboarding-wizard {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(4px);
        }

        .wizard-content {
            background: white;
            border-radius: 16px;
            padding: 40px;
            max-width: 800px;
            width: 90%;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            animation: wizardSlideIn 0.3s ease-out;
        }

        @keyframes wizardSlideIn {
            from {
                opacity: 0;
                transform: translateY(-20px) scale(0.95);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        .wizard-header {
            text-align: center;
            margin-bottom: 30px;
            position: relative;
        }

        .wizard-header h3 {
            font-size: 2rem;
            color: #1a252f;
            margin-bottom: 10px;
        }

        .wizard-header p {
            color: #6c757d;
            font-size: 1.1rem;
        }

        .wizard-header .btn {
            position: absolute;
            top: 0;
            right: 0;
        }

        .wizard-samples {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 30px;
        }

        .sample-card {
            background: #f8f9fa;
            border: 2px solid #e9ecef;
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .sample-card:hover {
            border-color: #495057;
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
        }

        .sample-card h4 {
            color: #1a252f;
            margin-bottom: 8px;
            font-size: 1.1rem;
        }

        .sample-card p {
            color: #6c757d;
            font-size: 0.9rem;
            margin-bottom: 15px;
        }

        .sample-card .btn {
            width: 100%;
        }

        /* Enhanced Onboarding Wizard Styles */
        .wizard-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(4px);
        }

        .wizard-content {
            position: relative;
            background: white;
            border-radius: 16px;
            padding: 0;
            max-width: 800px;
            width: 90%;
            max-height: 90vh;
            overflow: hidden;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            margin: 5vh auto;
            display: flex;
            flex-direction: column;
        }

        .dark-theme .wizard-content {
            background: #2d2d2d;
            color: #e9ecef;
        }

        .wizard-header {
            padding: 24px 24px 16px 24px;
            text-align: center;
            position: relative;
            border-bottom: 1px solid #e9ecef;
        }

        .dark-theme .wizard-header {
            border-bottom-color: #404040;
        }

        .wizard-header h3 {
            margin: 0 0 8px 0;
            color: #2c3e50;
            font-size: 28px;
            font-weight: 700;
        }

        .dark-theme .wizard-header h3 {
            color: #e9ecef;
        }

        .wizard-subtitle {
            margin: 0 0 16px 0;
            color: #666;
            font-size: 16px;
        }

        .dark-theme .wizard-subtitle {
            color: #adb5bd;
        }

        .wizard-steps {
            flex: 1;
            overflow-y: auto;
            padding: 24px;
        }

        .wizard-step {
            display: none;
        }

        .wizard-step.active {
            display: block;
        }

        .step-header {
            display: flex;
            align-items: center;
            margin-bottom: 24px;
            gap: 16px;
        }

        .step-number {
            background: #007bff;
            color: white;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 18px;
            flex-shrink: 0;
        }

        .step-title h4 {
            margin: 0 0 4px 0;
            font-size: 20px;
            color: #2c3e50;
        }

        .dark-theme .step-title h4 {
            color: #e9ecef;
        }

        .step-title p {
            margin: 0;
            color: #666;
            font-size: 14px;
        }

        .dark-theme .step-title p {
            color: #adb5bd;
        }

        .step-content {
            margin-bottom: 24px;
        }

        .step-content h5 {
            margin: 0 0 12px 0;
            color: #2c3e50;
            font-size: 16px;
        }

        .dark-theme .step-content h5 {
            color: #e9ecef;
        }

        .sample-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 16px;
            margin-bottom: 24px;
        }

        .sample-icon {
            font-size: 32px;
            margin-bottom: 12px;
        }

        .sample-card h6 {
            margin: 0 0 8px 0;
            font-size: 16px;
            color: #2c3e50;
            font-weight: 600;
        }

        .dark-theme .sample-card h6 {
            color: #e9ecef;
        }

        .code-input-section {
            margin-top: 24px;
        }

        #onboardingCode {
            width: 100%;
            height: 200px;
            padding: 16px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            font-size: 13px;
            line-height: 1.4;
            resize: vertical;
            background: #f8f9fa;
        }

        .dark-theme #onboardingCode {
            background: #404040;
            border-color: #505050;
            color: #e9ecef;
        }

        .code-tips {
            margin-top: 8px;
        }

        .code-tips small {
            color: #666;
            font-style: italic;
        }

        .dark-theme .code-tips small {
            color: #adb5bd;
        }

        .analysis-features {
            list-style: none;
            padding: 0;
            margin: 0 0 24px 0;
        }

        .analysis-features li {
            padding: 8px 0;
            border-bottom: 1px solid #e9ecef;
            color: #666;
            font-size: 14px;
        }

        .dark-theme .analysis-features li {
            border-bottom-color: #404040;
            color: #adb5bd;
        }

        .analysis-features li:last-child {
            border-bottom: none;
        }

        .feature-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-bottom: 24px;
        }

        .feature-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 16px;
            background: #f8f9fa;
            border-radius: 8px;
            border: 1px solid #e9ecef;
        }

        .dark-theme .feature-item {
            background: #404040;
            border-color: #505050;
        }

        .feature-icon {
            font-size: 24px;
            flex-shrink: 0;
        }

        .feature-text strong {
            display: block;
            color: #2c3e50;
            font-size: 14px;
            margin-bottom: 2px;
        }

        .dark-theme .feature-text strong {
            color: #e9ecef;
        }

        .feature-text p {
            margin: 0;
            color: #666;
            font-size: 12px;
        }

        .dark-theme .feature-text p {
            color: #adb5bd;
        }

        .option-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 16px;
            margin-bottom: 24px;
        }

        .option-card {
            background: #f8f9fa;
            border: 2px solid #e9ecef;
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
        }

        .dark-theme .option-card {
            background: #404040;
            border-color: #505050;
        }

        .option-card:hover {
            border-color: #007bff;
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0, 123, 255, 0.1);
        }

        .option-card.selected {
            border-color: #007bff;
            background: #e3f2fd;
        }

        .dark-theme .option-card.selected {
            background: #1e3a5f;
        }

        .option-icon {
            font-size: 28px;
            margin-bottom: 12px;
        }

        .option-card h6 {
            margin: 0 0 8px 0;
            font-size: 16px;
            color: #2c3e50;
            font-weight: 600;
        }

        .dark-theme .option-card h6 {
            color: #e9ecef;
        }

        .option-card p {
            margin: 0;
            font-size: 12px;
            color: #666;
        }

        .dark-theme .option-card p {
            color: #adb5bd;
        }

        .wizard-actions {
            text-align: center;
            margin: 24px 0;
        }

        .analyze-btn, .demo-btn, .tour-btn {
            background: #007bff;
            color: white;
            border: none;
            border-radius: 8px;
            padding: 12px 24px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .analyze-btn:hover, .demo-btn:hover, .tour-btn:hover {
            background: #0056b3;
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0, 123, 255, 0.3);
        }

        .analyze-btn:disabled, .tour-btn:disabled {
            background: #6c757d;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .btn-icon {
            font-size: 18px;
        }

        .step-actions {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-top: 16px;
            border-top: 1px solid #e9ecef;
        }

        .dark-theme .step-actions {
            border-top-color: #404040;
        }

        .prev-btn, .next-btn, .finish-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }

        .prev-btn {
            background: #6c757d;
            color: white;
        }

        .prev-btn:hover {
            background: #5a6268;
        }

        .next-btn {
            background: #28a745;
            color: white;
        }

        .next-btn:hover {
            background: #218838;
        }

        .next-btn:disabled {
            background: #6c757d;
            cursor: not-allowed;
        }

        .finish-btn {
            background: linear-gradient(135deg, #28a745, #20c997);
            color: white;
            font-size: 16px;
            padding: 12px 24px;
        }

        .finish-btn:hover {
            background: linear-gradient(135deg, #218838, #1ea085);
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(40, 167, 69, 0.3);
        }

        .wizard-progress {
            padding: 16px 24px;
            background: #f8f9fa;
            border-top: 1px solid #e9ecef;
        }

        .dark-theme .wizard-progress {
            background: #404040;
            border-top-color: #505050;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: #e9ecef;
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 8px;
        }

        .dark-theme .progress-bar {
            background: #505050;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #007bff, #28a745);
            border-radius: 4px;
            transition: width 0.3s ease;
        }

        .progress-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 12px;
            color: #666;
        }

        .dark-theme .progress-info {
            color: #adb5bd;
        }

        .progress-percentage {
            font-weight: 600;
            color: #007bff;
        }

        .analysis-progress, .tour-progress {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-top: 16px;
            padding: 12px;
            background: #e3f2fd;
            border-radius: 8px;
            color: #1976d2;
        }

        .dark-theme .analysis-progress, .dark-theme .tour-progress {
            background: #1e3a5f;
            color: #64b5f6;
        }

        .progress-spinner {
            width: 20px;
            height: 20px;
            border: 2px solid #e3f2fd;
            border-top: 2px solid #1976d2;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        .dark-theme .progress-spinner {
            border-color: #1e3a5f;
            border-top-color: #64b5f6;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Ghost Text Styles */
        .code-container {
            position: relative;
        }

        .ghost-text {
            position: absolute;
            top: 15px;
            left: 15px;
            color: #adb5bd;
            font-style: italic;
            pointer-events: none;
            z-index: 1;
            transition: opacity 0.2s;
        }

        .code-input:focus + .ghost-text,
        .code-input:not(:placeholder-shown) + .ghost-text {
            opacity: 0;
        }

        /* Progress Stages */
        .progress-stages {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 15px;
        }

        .stage {
            padding: 8px 16px;
            border-radius: 20px;
            background: #e9ecef;
            color: #6c757d;
            font-size: 0.9rem;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .stage.active {
            background: #495057;
            color: white;
            transform: scale(1.05);
        }

        .stage.completed {
            background: #28a745;
            color: white;
        }

        /* Hover Card Styles */
        .hover-card {
            position: absolute;
            background: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
            z-index: 1000;
            max-width: 300px;
            font-size: 14px;
        }

        .hover-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            padding-bottom: 8px;
            border-bottom: 1px solid #eee;
        }

        .hover-card-header h4 {
            margin: 0;
            color: #1a252f;
            font-size: 16px;
        }

        .complexity-badge {
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .complexity-badge.complexity-high {
            background: #e74c3c;
            color: white;
        }

        .complexity-badge.complexity-medium {
            background: #f39c12;
            color: white;
        }

        .complexity-badge.complexity-low {
            background: #27ae60;
            color: white;
        }

        .hover-card-section {
            margin-bottom: 8px;
        }

        .hover-card-section ul {
            margin: 4px 0;
            padding-left: 16px;
        }

        .hover-card-actions {
            margin-top: 10px;
            padding-top: 8px;
            border-top: 1px solid #eee;
            display: flex;
            gap: 8px;
        }

        .hover-card-actions .btn-small {
            padding: 4px 8px;
            font-size: 12px;
        }

        /* Minimap Styles */
        .minimap {
            position: absolute;
            top: 10px;
            right: 10px;
            width: 150px;
            height: 100px;
            border: 1px solid #ccc;
            background: white;
            border-radius: 4px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        #cy-minimap {
            width: 100%;
            height: 100%;
        }

        /* Map Controls */
        .map-controls {
            display: flex;
            gap: 8px;
            margin-left: auto;
        }

        .zoom-controls {
            display: flex;
            gap: 4px;
            margin-left: 10px;
        }

        .zoom-controls .toolbar-btn {
            padding: 4px 8px;
            font-size: 12px;
        }

        /* Trace Overlay Styles */
        .trace-controls {
            position: absolute;
            top: 10px;
            left: 10px;
            background: rgba(255, 255, 255, 0.95);
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            z-index: 100;
        }

        .trace-toggle {
            display: flex;
            gap: 8px;
            margin-bottom: 10px;
        }

        .trace-breadcrumb {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 8px;
            margin-top: 10px;
            max-height: 150px;
            overflow-y: auto;
        }

        .breadcrumb-title {
            font-weight: 600;
            margin-bottom: 5px;
            color: #495057;
        }

        .breadcrumb-item {
            padding: 2px 0;
            cursor: pointer;
            color: #007bff;
            font-size: 12px;
        }

        .breadcrumb-item:hover {
            background: #e9ecef;
            border-radius: 2px;
            padding: 2px 4px;
        }

        .conflict-badge {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
            border-radius: 4px;
            padding: 8px;
            margin-top: 10px;
            font-size: 12px;
            font-weight: 600;
        }

        /* Animation Styles */
        .animating {
            animation: pulse 1s ease-in-out;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }

        /* Trace Path Styles */
        .trace-path {
            background-color: #f39c12 !important;
            border-color: #e67e22 !important;
            line-color: #f39c12 !important;
            target-arrow-color: #f39c12 !important;
        }

        .hot-path {
            background-color: #e74c3c !important;
            border-color: #c0392b !important;
            border-width: 3px !important;
        }

        .conflict {
            border-style: dashed !important;
            border-color: #8e44ad !important;
            border-width: 3px !important;
        }

        /* Tour Reader Styles */
        .tour-reader {
            position: fixed;
            top: 0;
            right: 0;
            width: 400px;
            height: 100vh;
            background: white;
            border-left: 1px solid #ddd;
            box-shadow: -2px 0 10px rgba(0, 0, 0, 0.1);
            z-index: 1000;
            display: flex;
            flex-direction: column;
        }

        .tour-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            border-bottom: 1px solid #eee;
            background: #f8f9fa;
        }

        .tour-header h3 {
            margin: 0;
            color: #1a252f;
        }

        .btn-close {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #6c757d;
        }

        .tour-timeline {
            padding: 15px;
            border-bottom: 1px solid #eee;
        }

        .timeline-progress {
            height: 4px;
            background: #e9ecef;
            border-radius: 2px;
            margin-bottom: 15px;
            overflow: hidden;
        }

        .progress-bar {
            height: 100%;
            background: #007bff;
            transition: width 0.3s ease;
            width: 0%;
        }

        .timeline-steps {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .timeline-step {
            display: flex;
            align-items: center;
            padding: 8px 12px;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s ease;
            border: 1px solid transparent;
        }

        .timeline-step:hover {
            background: #f8f9fa;
        }

        .timeline-step.active {
            background: #e3f2fd;
            border-color: #2196f3;
        }

        .step-number {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: #6c757d;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: 600;
            margin-right: 10px;
        }

        .timeline-step.active .step-number {
            background: #2196f3;
        }

        .step-title {
            font-size: 14px;
            color: #495057;
        }

        .tour-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .tour-step-content {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
        }

        .step-header {
            margin-bottom: 15px;
        }

        .step-header h4 {
            margin: 0 0 5px 0;
            color: #1a252f;
        }

        .step-meta {
            font-size: 12px;
            color: #6c757d;
        }

        .step-description {
            margin-bottom: 15px;
            line-height: 1.6;
        }

        .step-code {
            margin-bottom: 15px;
        }

        .step-code h5 {
            margin: 0 0 8px 0;
            color: #495057;
            font-size: 14px;
        }

        .step-code pre {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 4px;
            padding: 10px;
            font-size: 12px;
            overflow-x: auto;
        }

        .step-why {
            background: #e8f5e8;
            border: 1px solid #c3e6c3;
            border-radius: 4px;
            padding: 10px;
        }

        .step-why h5 {
            margin: 0 0 8px 0;
            color: #155724;
            font-size: 14px;
        }

        .step-why p {
            margin: 0;
            color: #155724;
            font-size: 13px;
        }

        .tour-actions {
            display: flex;
            gap: 8px;
            padding: 15px;
            border-top: 1px solid #eee;
            background: #f8f9fa;
        }

        .tour-actions .btn {
            flex: 1;
            padding: 8px 12px;
            font-size: 12px;
        }

        /* Tour Highlight Styles */
        .tour-highlight {
            background-color: #ffeb3b !important;
            border-color: #ffc107 !important;
            border-width: 3px !important;
            z-index: 10 !important;
        }

        /* Lens Panel Styles */
        .lens-panel {
            position: fixed;
            top: 0;
            left: 0;
            width: 350px;
            height: 100vh;
            background: white;
            border-right: 1px solid #ddd;
            box-shadow: 2px 0 10px rgba(0, 0, 0, 0.1);
            z-index: 1000;
            display: flex;
            flex-direction: column;
        }

        .lens-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            border-bottom: 1px solid #eee;
            background: #f8f9fa;
        }

        .lens-header h3 {
            margin: 0;
            color: #1a252f;
        }

        .lens-content {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
        }

        .filter-section, .lens-section, .url-section {
            margin-bottom: 25px;
        }

        .filter-section h4, .lens-section h4, .url-section h4 {
            margin: 0 0 15px 0;
            color: #495057;
            font-size: 16px;
        }

        .filter-group {
            margin-bottom: 15px;
        }

        .filter-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #495057;
        }

        .filter-group select {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            background: white;
        }

        .checkbox-group {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
        }

        .checkbox-group label {
            display: flex;
            align-items: center;
            font-weight: normal;
            margin-bottom: 0;
            cursor: pointer;
        }

        .checkbox-group input[type="checkbox"] {
            margin-right: 8px;
        }

        .preset-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            margin-bottom: 15px;
        }

        .lens-actions {
            display: flex;
            gap: 8px;
        }

        .lens-actions .btn {
            flex: 1;
        }

        .url-input-group {
            display: flex;
            gap: 8px;
        }

        .url-input-group input {
            flex: 1;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 12px;
        }

        .url-input-group .btn {
            white-space: nowrap;
        }

        /* Filtered elements */
        .filtered {
            opacity: 0.3 !important;
            pointer-events: none !important;
        }

        /* Export Menu Styles */
        .export-menu {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            border: 1px solid #ddd;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            z-index: 1000;
            min-width: 400px;
            max-width: 500px;
        }

        .export-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
            border-bottom: 1px solid #eee;
            background: #f8f9fa;
            border-radius: 12px 12px 0 0;
        }

        .export-header h3 {
            margin: 0;
            color: #1a252f;
        }

        .export-options {
            padding: 20px;
        }

        .export-option {
            display: flex;
            align-items: center;
            padding: 15px;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .export-option:hover {
            background: #f8f9fa;
            border-color: #007bff;
            transform: translateY(-1px);
        }

        .export-icon {
            font-size: 24px;
            margin-right: 15px;
            width: 30px;
            text-align: center;
        }

        .export-details h4 {
            margin: 0 0 5px 0;
            color: #1a252f;
            font-size: 16px;
        }

        .export-details p {
            margin: 0;
            color: #6c757d;
            font-size: 14px;
        }

        .features-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 30px;
        }

        .feature-card {
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            text-align: center;
            transition: transform 0.2s;
        }

        .feature-card:hover {
            transform: translateY(-5px);
        }

        .feature-icon {
            font-size: 3rem;
            margin-bottom: 15px;
        }

        .feature-card h3 {
            color: #1a252f;
            margin-bottom: 10px;
            font-weight: 600;
        }

        .feature-card p {
            color: #666;
            line-height: 1.5;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #495057;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @keyframes fadeInOut {
            0% { opacity: 0; transform: translateX(-50%) translateY(10px); }
            20% { opacity: 1; transform: translateX(-50%) translateY(0); }
            80% { opacity: 1; transform: translateX(-50%) translateY(0); }
            100% { opacity: 0; transform: translateX(-50%) translateY(-10px); }
        }

        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(0, 123, 255, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(0, 123, 255, 0); }
            100% { box-shadow: 0 0 0 0 rgba(0, 123, 255, 0); }
        }

        .error {
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 6px;
            border: 1px solid #f5c6cb;
            margin-top: 15px;
        }

        .success {
            background: #d4edda;
            color: #155724;
            padding: 15px;
            border-radius: 6px;
            border: 1px solid #c3e6cb;
            margin-top: 15px;
        }

        .code-editor {
            position: relative;
            border: 2px solid #e1e8ed;
            border-radius: 8px;
            overflow: hidden;
            background: #f8f9fa;
        }

        .editor-header {
            background: #2c3e50;
            color: white;
            padding: 8px 15px;
            font-size: 12px;
            font-weight: 600;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .editor-actions {
            display: flex;
            gap: 10px;
        }

        .btn-small {
            background: rgba(255,255,255,0.2);
            border: 1px solid rgba(255,255,255,0.3);
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
            cursor: pointer;
            transition: background 0.2s;
        }

        .btn-small:hover {
            background: rgba(255,255,255,0.3);
        }

        .analysis-tabs {
            display: flex;
            border-bottom: 1px solid #e1e8ed;
            background: white;
        }

        .tab {
            padding: 12px 20px;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            transition: all 0.2s;
            font-weight: 500;
        }

        .tab.active {
            border-bottom-color: #495057;
            color: #495057;
            background: #f8f9fa;
        }

        .tab-content {
            display: none;
            padding: 20px;
        }

        .tab-content.active {
            display: block;
        }

        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .metric-card {
            background: white;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #e1e8ed;
            text-align: center;
        }

        .metric-value {
            font-size: 2rem;
            font-weight: bold;
            color: #495057;
            margin-bottom: 5px;
        }

        .metric-label {
            font-size: 0.9rem;
            color: #666;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .call-graph {
            background: white;
            border: 1px solid #e1e8ed;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
        }

        .graph-node {
            display: inline-block;
            background: #495057;
            color: white;
            padding: 8px 12px;
            border-radius: 6px;
            margin: 5px;
            font-size: 12px;
            font-weight: 600;
        }

        .graph-edge {
            color: #666;
            margin: 0 10px;
            font-size: 14px;
        }

        .complexity-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }

        .complexity-indicator.low { background: #17a2b8; }
        .complexity-indicator.medium { background: #ffc107; }
        .complexity-indicator.high { background: #dc3545; }

        .side-effects {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 6px;
            padding: 10px;
            margin: 10px 0;
        }

        .side-effects h4 {
            color: #856404;
            margin-bottom: 8px;
            font-size: 14px;
        }

        .side-effect-tag {
            display: inline-block;
            background: #f39c12;
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 11px;
            margin: 2px;
        }

        .tour-step {
            position: relative;
            padding-left: 30px;
            margin: 15px 0;
        }

        .tour-step::before {
            content: counter(step-counter);
            counter-increment: step-counter;
            position: absolute;
            left: 0;
            top: 0;
            background: #495057;
            color: white;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: bold;
        }

        .tour-section {
            counter-reset: step-counter;
        }

        .code-snippet {
            background: #2c3e50;
            color: #ecf0f1;
            padding: 15px;
            border-radius: 6px;
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            font-size: 13px;
            overflow-x: auto;
            margin: 10px 0;
        }

        .highlight {
            background: rgba(255, 255, 0, 0.3);
            padding: 2px 4px;
            border-radius: 3px;
        }

        .progress-bar {
            width: 100%;
            height: 4px;
            background: #e1e8ed;
            border-radius: 2px;
            overflow: hidden;
            margin: 10px 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #495057, #6c757d);
            width: 0%;
            transition: width 0.3s ease;
        }

        .export-options {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .export-btn {
            background: #6c757d;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 14px;
            cursor: pointer;
            transition: background 0.2s;
        }

        .export-btn:hover {
            background: #5a6268;
        }

        .export-btn.primary {
            background: #495057;
        }

        .export-btn.primary:hover {
            background: #343a40;
        }

        /* Enhanced Features */
        .wizard-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            z-index: 1000;
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(4px);
        }

        .wizard-modal {
            background: white;
            border-radius: 16px;
            padding: 40px;
            max-width: 800px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.3);
            animation: wizardSlideIn 0.3s ease-out;
        }

        @keyframes wizardSlideIn {
            from {
                opacity: 0;
                transform: translateY(-20px) scale(0.95);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        .wizard-step {
            display: none;
        }

        .wizard-step.active {
            display: block;
        }

        .sample-button {
            background: #17a2b8;
            color: white;
            border: none;
            padding: 15px 25px;
            border-radius: 8px;
            margin: 10px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s;
            display: inline-block;
            text-decoration: none;
        }

        .sample-button:hover {
            background: #138496;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(23, 162, 184, 0.3);
        }

        .wizard-header h2 {
            color: #1a252f;
            margin-bottom: 10px;
            font-size: 2rem;
        }

        .wizard-header p {
            color: #6c757d;
            font-size: 1.1rem;
            margin-bottom: 30px;
        }

        .wizard-samples h3 {
            color: #495057;
            margin-bottom: 20px;
            font-size: 1.3rem;
        }

        .sample-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin: 30px 0;
        }

        .sample-card {
            background: #f8f9fa;
            border: 2px solid #e9ecef;
            border-radius: 12px;
            padding: 20px;
            cursor: pointer;
            transition: all 0.2s ease;
            text-align: left;
        }

        .sample-card:hover {
            border-color: #495057;
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(73, 80, 87, 0.15);
        }

        .sample-icon {
            font-size: 2rem;
            margin-bottom: 10px;
        }

        .sample-card h4 {
            color: #1a252f;
            margin-bottom: 8px;
            font-size: 1.1rem;
        }

        .sample-card p {
            color: #6c757d;
            font-size: 0.9rem;
            margin-bottom: 15px;
            line-height: 1.4;
        }

        .sample-preview {
            background: #2c3e50;
            color: #ecf0f1;
            padding: 10px;
            border-radius: 6px;
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            font-size: 0.8rem;
            overflow-x: auto;
        }

        .wizard-actions {
            margin-top: 30px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 15px;
        }

        .wizard-hint {
            display: flex;
            align-items: center;
            gap: 8px;
            color: #6c757d;
            font-size: 0.9rem;
        }

        .hint-icon {
            font-size: 1.2rem;
        }

        kbd {
            background: #e9ecef;
            border: 1px solid #adb5bd;
            border-radius: 3px;
            padding: 2px 6px;
            font-family: monospace;
            font-size: 0.8rem;
        }

        .three-pane-layout {
            display: grid;
            grid-template-columns: 1fr 2fr 1fr;
            gap: 20px;
            height: 70vh;
            margin-top: 20px;
        }

        .pane {
            background: white;
            border-radius: 8px;
            border: 1px solid #e1e8ed;
            overflow: hidden;
        }

        .pane-header {
            background: #f8f9fa;
            padding: 12px 16px;
            border-bottom: 1px solid #e1e8ed;
            font-weight: 600;
            color: #495057;
        }

        .pane-content {
            padding: 16px;
            height: calc(100% - 50px);
            overflow-y: auto;
        }

        /* Enhanced Three-Pane Layout Styles */
        .pane.collapsed {
            width: 60px;
            min-width: 60px;
        }

        .pane-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            min-height: 60px;
        }

        .pane-title {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .pane-icon {
            font-size: 18px;
        }

        .pane-controls {
            display: flex;
            gap: 8px;
        }

        .btn-icon {
            background: none;
            border: none;
            padding: 4px 8px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            color: #6c757d;
            transition: all 0.2s ease;
        }

        .btn-icon:hover {
            background: #e9ecef;
            color: #495057;
        }

        /* Editor Tabs */
        .editor-tabs {
            display: flex;
            gap: 4px;
            margin-bottom: 15px;
        }

        .tab {
            padding: 8px 16px;
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 6px 6px 0 0;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s ease;
        }

        .tab.active {
            background: white;
            border-bottom: 1px solid white;
            color: #007bff;
        }

        .tab:hover:not(.active) {
            background: #e9ecef;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* File Browser */
        .file-browser {
            max-height: 200px;
            overflow-y: auto;
        }

        .file-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            border-radius: 4px;
            cursor: pointer;
            transition: background 0.2s ease;
        }

        .file-item:hover {
            background: #f8f9fa;
        }

        .file-item.active {
            background: #e3f2fd;
            color: #1976d2;
        }

        .file-icon {
            font-size: 16px;
        }

        .file-name {
            flex: 1;
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 13px;
        }

        .file-status {
            font-size: 11px;
            color: #6c757d;
            text-transform: uppercase;
        }

        /* Settings Panel */
        .settings-panel {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .setting-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .setting-group label {
            font-weight: 500;
            color: #495057;
            font-size: 14px;
        }

        .setting-group select,
        .setting-group input[type="checkbox"] {
            padding: 8px 12px;
            border: 1px solid #ced4da;
            border-radius: 4px;
            font-size: 14px;
        }

        .setting-group input[type="checkbox"] {
            width: auto;
            margin-right: 8px;
        }

        /* Insights Tabs */
        .insights-tabs {
            display: flex;
            gap: 4px;
            margin-bottom: 20px;
            border-bottom: 1px solid #e9ecef;
        }

        .insight-tab {
            padding: 8px 16px;
            background: none;
            border: none;
            border-bottom: 2px solid transparent;
            cursor: pointer;
            font-size: 14px;
            color: #6c757d;
            transition: all 0.2s ease;
        }

        .insight-tab.active {
            color: #007bff;
            border-bottom-color: #007bff;
        }

        .insight-tab:hover:not(.active) {
            color: #495057;
        }

        .insight-content {
            position: relative;
        }

        .insight-panel {
            display: none;
        }

        .insight-panel.active {
            display: block;
        }

        .insight-section {
            margin-bottom: 24px;
        }

        .insight-section h4 {
            margin: 0 0 12px 0;
            color: #495057;
            font-size: 16px;
        }

        /* Metrics Grid */
        .metrics-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
        }

        .metric-card {
            background: #f8f9fa;
            padding: 16px;
            border-radius: 8px;
            text-align: center;
            border: 1px solid #e9ecef;
        }

        .metric-value {
            font-size: 24px;
            font-weight: bold;
            color: #007bff;
            margin-bottom: 4px;
        }

        .metric-label {
            font-size: 12px;
            color: #6c757d;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* Analysis Results */
        .analysis-results {
            background: #f8f9fa;
            padding: 16px;
            border-radius: 8px;
            border: 1px solid #e9ecef;
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 13px;
            line-height: 1.4;
        }

        .complexity-chart {
            height: 200px;
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #6c757d;
        }

        /* Side Effects List */
        .side-effects-list {
            max-height: 300px;
            overflow-y: auto;
        }

        .side-effect-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            border: 1px solid #e9ecef;
            border-radius: 6px;
            margin-bottom: 8px;
            background: white;
        }

        .side-effect-icon {
            font-size: 18px;
        }

        .side-effect-details {
            flex: 1;
        }

        .side-effect-function {
            font-weight: 500;
            color: #495057;
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 13px;
        }

        .side-effect-description {
            font-size: 12px;
            color: #6c757d;
            margin-top: 2px;
        }

        /* Graph Overlay */
        .graph-overlay {
            position: absolute;
            top: 20px;
            right: 20px;
            z-index: 1000;
        }

        .overlay-controls {
            display: flex;
            gap: 8px;
        }

        .overlay-btn {
            background: rgba(255, 255, 255, 0.9);
            border: 1px solid #e9ecef;
            padding: 8px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 500;
            transition: all 0.2s ease;
            backdrop-filter: blur(4px);
        }

        .overlay-btn:hover {
            background: white;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .overlay-btn.active {
            background: #007bff;
            color: white;
            border-color: #007bff;
        }

        /* Shortcuts Help Modal */
        .shortcuts-help-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
        }

        .shortcuts-content {
            background: white;
            border-radius: 12px;
            padding: 24px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
        }

        .shortcuts-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
            padding-bottom: 16px;
            border-bottom: 1px solid #e9ecef;
        }

        .shortcuts-header h3 {
            margin: 0;
            color: #495057;
            font-size: 20px;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #6c757d;
            padding: 4px 8px;
            border-radius: 4px;
            transition: all 0.2s ease;
        }

        .close-btn:hover {
            background: #f8f9fa;
            color: #495057;
        }

        .shortcuts-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 24px;
        }

        .shortcut-category h4 {
            margin: 0 0 16px 0;
            color: #495057;
            font-size: 16px;
            font-weight: 600;
        }

        .shortcut-item {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 12px;
        }

        .shortcut-item kbd {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 4px;
            padding: 4px 8px;
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 12px;
            color: #495057;
            min-width: 24px;
            text-align: center;
        }

        .shortcut-item span {
            color: #6c757d;
            font-size: 14px;
        }

        /* Search Input */
        .search-input {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1000;
            padding: 12px 16px;
            border: 2px solid #007bff;
            border-radius: 8px;
            font-size: 16px;
            min-width: 300px;
            box-shadow: 0 4px 12px rgba(0, 123, 255, 0.3);
        }

        .search-input:focus {
            outline: none;
            box-shadow: 0 4px 12px rgba(0, 123, 255, 0.5);
        }

        /* Responsive Design for Shortcuts */
        @media (max-width: 768px) {
            .shortcuts-grid {
                grid-template-columns: 1fr;
                gap: 16px;
            }
            
            .shortcuts-content {
                padding: 16px;
                margin: 16px;
            }
        }

        /* Accessibility and Theming */
        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border: 0;
        }

        .skip-links {
            position: absolute;
            top: -40px;
            left: 6px;
            z-index: 1000;
        }

        .skip-link {
            position: absolute;
            top: -40px;
            left: 6px;
            background: #000;
            color: #fff;
            padding: 8px;
            text-decoration: none;
            border-radius: 4px;
            z-index: 1000;
            transition: top 0.3s;
        }

        .skip-link:focus {
            top: 6px;
        }

        .focus-ring {
            outline: 2px solid #007bff;
            outline-offset: 2px;
        }

        .theme-toggle, .contrast-toggle {
            background: none;
            border: 1px solid #e9ecef;
            padding: 8px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.2s ease;
        }

        .theme-toggle:hover, .contrast-toggle:hover {
            background: #f8f9fa;
            border-color: #007bff;
        }

        /* Dark Theme */
        .dark-theme {
            background-color: #1a1a1a;
            color: #e9ecef;
        }

        .dark-theme .header {
            background-color: #2d2d2d;
            border-bottom-color: #404040;
        }

        .dark-theme .pane {
            background-color: #2d2d2d;
            border-color: #404040;
        }

        .dark-theme .pane-header {
            background-color: #3a3a3a;
            border-bottom-color: #404040;
            color: #e9ecef;
        }

        .dark-theme .code-input {
            background-color: #1e1e1e;
            color: #e9ecef;
            border-color: #404040;
        }

        .dark-theme .code-input:focus {
            border-color: #007bff;
            box-shadow: 0 0 0 2px rgba(0, 123, 255, 0.25);
        }

        .dark-theme .btn {
            background-color: #404040;
            color: #e9ecef;
            border-color: #404040;
        }

        .dark-theme .btn:hover {
            background-color: #505050;
            border-color: #505050;
        }

        .dark-theme .btn-primary {
            background-color: #007bff;
            border-color: #007bff;
        }

        .dark-theme .btn-primary:hover {
            background-color: #0056b3;
            border-color: #0056b3;
        }

        .dark-theme .toolbar-btn {
            background-color: #404040;
            color: #e9ecef;
            border-color: #404040;
        }

        .dark-theme .toolbar-btn:hover {
            background-color: #505050;
        }

        .dark-theme .tab {
            background-color: #3a3a3a;
            color: #e9ecef;
            border-color: #404040;
        }

        .dark-theme .tab.active {
            background-color: #2d2d2d;
            color: #007bff;
        }

        .dark-theme .insight-tab {
            color: #adb5bd;
        }

        .dark-theme .insight-tab.active {
            color: #007bff;
        }

        .dark-theme .metric-card {
            background-color: #3a3a3a;
            border-color: #404040;
        }

        .dark-theme .analysis-results {
            background-color: #3a3a3a;
            border-color: #404040;
            color: #e9ecef;
        }

        .dark-theme .complexity-chart {
            background-color: #3a3a3a;
            border-color: #404040;
        }

        .dark-theme .side-effect-item {
            background-color: #2d2d2d;
            border-color: #404040;
        }

        .dark-theme .shortcuts-content {
            background-color: #2d2d2d;
            color: #e9ecef;
        }

        .dark-theme .shortcuts-header {
            border-bottom-color: #404040;
        }

        .dark-theme .shortcut-item kbd {
            background-color: #404040;
            border-color: #505050;
            color: #e9ecef;
        }

        /* High Contrast Theme */
        .high-contrast-theme {
            background-color: #000000;
            color: #ffffff;
        }

        .high-contrast-theme .header {
            background-color: #000000;
            border-bottom: 3px solid #ffffff;
        }

        .high-contrast-theme .pane {
            background-color: #000000;
            border: 3px solid #ffffff;
        }

        .high-contrast-theme .pane-header {
            background-color: #000000;
            border-bottom: 3px solid #ffffff;
            color: #ffffff;
        }

        .high-contrast-theme .code-input {
            background-color: #000000;
            color: #ffffff;
            border: 3px solid #ffffff;
        }

        .high-contrast-theme .code-input:focus {
            border-color: #ffff00;
            box-shadow: 0 0 0 3px #ffff00;
        }

        .high-contrast-theme .btn {
            background-color: #ffffff;
            color: #000000;
            border: 3px solid #ffffff;
            font-weight: bold;
        }

        .high-contrast-theme .btn:hover {
            background-color: #ffff00;
            color: #000000;
        }

        .high-contrast-theme .btn-primary {
            background-color: #ffff00;
            color: #000000;
            border-color: #ffff00;
        }

        .high-contrast-theme .btn-primary:hover {
            background-color: #ffffff;
            color: #000000;
        }

        .high-contrast-theme .focus-ring {
            outline: 3px solid #ffff00;
            outline-offset: 3px;
        }

        .high-contrast-theme .tab {
            background-color: #000000;
            color: #ffffff;
            border: 3px solid #ffffff;
        }

        .high-contrast-theme .tab.active {
            background-color: #ffff00;
            color: #000000;
        }

        .high-contrast-theme .insight-tab {
            color: #ffffff;
        }

        .high-contrast-theme .insight-tab.active {
            color: #ffff00;
        }

        .high-contrast-theme .metric-card {
            background-color: #000000;
            border: 3px solid #ffffff;
        }

        .high-contrast-theme .analysis-results {
            background-color: #000000;
            border: 3px solid #ffffff;
            color: #ffffff;
        }

        .high-contrast-theme .complexity-chart {
            background-color: #000000;
            border: 3px solid #ffffff;
        }

        .high-contrast-theme .side-effect-item {
            background-color: #000000;
            border: 3px solid #ffffff;
        }

        /* Reduced Motion */
        @media (prefers-reduced-motion: reduce) {
            * {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
            }
        }

        /* Advanced Graph Features Styles */
        .hover-card {
            background: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            max-width: 300px;
            font-size: 14px;
            z-index: 1000;
        }

        .dark-theme .hover-card {
            background: #2d2d2d;
            border-color: #404040;
            color: #e9ecef;
        }

        .hover-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
            border-bottom: 1px solid #eee;
            padding-bottom: 8px;
        }

        .dark-theme .hover-card-header {
            border-bottom-color: #404040;
        }

        .hover-card-header h4 {
            margin: 0;
            font-size: 16px;
            font-weight: 600;
        }

        .complexity-badge {
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 500;
            text-transform: uppercase;
        }

        .complexity-low {
            background: #d4edda;
            color: #155724;
        }

        .complexity-medium {
            background: #fff3cd;
            color: #856404;
        }

        .complexity-high {
            background: #f8d7da;
            color: #721c24;
        }

        .dark-theme .complexity-low {
            background: #1e4d2b;
            color: #d4edda;
        }

        .dark-theme .complexity-medium {
            background: #664d03;
            color: #fff3cd;
        }

        .dark-theme .complexity-high {
            background: #721c24;
            color: #f8d7da;
        }

        .hover-card-body {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .hover-metric {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .metric-label {
            font-weight: 500;
            color: #666;
        }

        .dark-theme .metric-label {
            color: #adb5bd;
        }

        .metric-value {
            font-family: monospace;
            font-size: 13px;
        }

        .search-container {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-left: 16px;
        }

        .search-input {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
            width: 200px;
            background: white;
        }

        .dark-theme .search-input {
            background: #2d2d2d;
            border-color: #404040;
            color: #e9ecef;
        }

        .search-input:focus {
            outline: none;
            border-color: #007bff;
            box-shadow: 0 0 0 2px rgba(0, 123, 255, 0.25);
        }

        .search-btn, .clear-search-btn {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            background: white;
            cursor: pointer;
            font-size: 14px;
        }

        .dark-theme .search-btn, .dark-theme .clear-search-btn {
            background: #2d2d2d;
            border-color: #404040;
            color: #e9ecef;
        }

        .search-btn:hover, .clear-search-btn:hover {
            background: #f8f9fa;
        }

        .dark-theme .search-btn:hover, .dark-theme .clear-search-btn:hover {
            background: #404040;
        }

        .search-results {
            background: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 16px;
            margin: 16px 0;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .dark-theme .search-results {
            background: #2d2d2d;
            border-color: #404040;
            color: #e9ecef;
        }

        .search-results-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 1px solid #eee;
        }

        .dark-theme .search-results-header {
            border-bottom-color: #404040;
        }

        .search-results-header h4 {
            margin: 0;
            font-size: 16px;
        }

        .result-count {
            font-size: 12px;
            color: #666;
            background: #f8f9fa;
            padding: 2px 8px;
            border-radius: 12px;
        }

        .dark-theme .result-count {
            color: #adb5bd;
            background: #404040;
        }

        .search-results-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .search-result-item {
            padding: 8px 12px;
            border: 1px solid #eee;
            border-radius: 6px;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .dark-theme .search-result-item {
            border-color: #404040;
        }

        .search-result-item:hover {
            background: #f8f9fa;
        }

        .dark-theme .search-result-item:hover {
            background: #404040;
        }

        .result-label {
            font-weight: 500;
            font-size: 14px;
        }

        .result-file {
            font-size: 12px;
            color: #666;
            font-family: monospace;
        }

        .dark-theme .result-file {
            color: #adb5bd;
        }

        .code-preview {
            background: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 16px;
            margin: 16px 0;
        }

        .dark-theme .code-preview {
            background: #2d2d2d;
            border-color: #404040;
            color: #e9ecef;
        }

        .code-preview-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 1px solid #eee;
        }

        .dark-theme .code-preview-header {
            border-bottom-color: #404040;
        }

        .file-path {
            font-size: 12px;
            color: #666;
            font-family: monospace;
        }

        .dark-theme .file-path {
            color: #adb5bd;
        }

        .code-preview-content {
            background: #f8f9fa;
            border-radius: 6px;
            padding: 12px;
            overflow-x: auto;
        }

        .dark-theme .code-preview-content {
            background: #1a1a1a;
        }

        .code-preview-content pre {
            margin: 0;
            font-size: 13px;
            line-height: 1.4;
        }

        .edge-details {
            background: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 16px;
            margin: 16px 0;
        }

        .dark-theme .edge-details {
            background: #2d2d2d;
            border-color: #404040;
            color: #e9ecef;
        }

        .edge-details-header {
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 1px solid #eee;
        }

        .dark-theme .edge-details-header {
            border-bottom-color: #404040;
        }

        .edge-details-header h4 {
            margin: 0;
            font-size: 16px;
        }

        .edge-details-body {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .edge-metric {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .node-metrics {
            background: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 16px;
            margin: 16px 0;
        }

        .dark-theme .node-metrics {
            background: #2d2d2d;
            border-color: #404040;
            color: #e9ecef;
        }

        .node-metrics h4 {
            margin: 0 0 12px 0;
            font-size: 16px;
        }

        .metric-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 4px 0;
        }

        .metric-name {
            font-weight: 500;
            color: #666;
        }

        .dark-theme .metric-name {
            color: #adb5bd;
        }

        /* Enhanced Graph Styles */
        .cy {
            border-radius: 8px;
            background: #f8f9fa;
        }

        .dark-theme .cy {
            background: #1a1a1a;
        }

        /* Search result highlighting */
        .search-result {
            background-color: #fff3cd !important;
            border-color: #ffc107 !important;
            border-width: 2px !important;
        }

        .dark-theme .search-result {
            background-color: #664d03 !important;
            border-color: #ffc107 !important;
        }

        .search-highlight {
            background-color: #d1ecf1 !important;
            border-color: #17a2b8 !important;
            border-width: 3px !important;
            z-index: 10 !important;
        }

        .dark-theme .search-highlight {
            background-color: #0c5460 !important;
            border-color: #17a2b8 !important;
        }

        /* Cluster styles */
        .cluster {
            background-color: #e9ecef !important;
            border-color: #6c757d !important;
            border-width: 2px !important;
            border-style: dashed !important;
        }

        .dark-theme .cluster {
            background-color: #404040 !important;
            border-color: #adb5bd !important;
        }

        /* Trace Overlay Styles */
        .trace-controls {
            background: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 16px;
            margin: 16px 0;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .dark-theme .trace-controls {
            background: #2d2d2d;
            border-color: #404040;
            color: #e9ecef;
        }

        .trace-controls-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 1px solid #eee;
        }

        .dark-theme .trace-controls-header {
            border-bottom-color: #404040;
        }

        .trace-controls-header h4 {
            margin: 0;
            font-size: 16px;
        }

        .trace-toggle {
            display: flex;
            gap: 12px;
            margin-bottom: 16px;
        }

        .trace-toggle label {
            display: flex;
            align-items: center;
            gap: 6px;
            cursor: pointer;
            font-size: 14px;
        }

        .trace-stats {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-bottom: 16px;
        }

        .trace-stat {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .stat-label {
            font-weight: 500;
            color: #666;
        }

        .dark-theme .stat-label {
            color: #adb5bd;
        }

        .stat-value {
            font-family: monospace;
            font-weight: 600;
            color: #007bff;
        }

        .trace-actions {
            display: flex;
            gap: 8px;
        }

        .action-btn {
            padding: 6px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            background: white;
            cursor: pointer;
            font-size: 12px;
            transition: background-color 0.2s;
        }

        .dark-theme .action-btn {
            background: #2d2d2d;
            border-color: #404040;
            color: #e9ecef;
        }

        .action-btn:hover {
            background: #f8f9fa;
        }

        .dark-theme .action-btn:hover {
            background: #404040;
        }

        /* Conflict tooltip */
        .conflict-tooltip {
            background: white;
            border: 2px solid #dc3545;
            border-radius: 8px;
            padding: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            max-width: 300px;
            font-size: 13px;
        }

        .dark-theme .conflict-tooltip {
            background: #2d2d2d;
            border-color: #dc3545;
            color: #e9ecef;
        }

        .conflict-header {
            margin-bottom: 8px;
            border-bottom: 1px solid #eee;
            padding-bottom: 8px;
        }

        .dark-theme .conflict-header {
            border-bottom-color: #404040;
        }

        .conflict-header h5 {
            margin: 0;
            color: #dc3545;
            font-size: 14px;
        }

        .conflict-body p {
            margin: 4px 0;
            font-size: 12px;
        }

        /* Breadcrumb panel */
        .breadcrumb-panel {
            background: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 16px;
            margin: 16px 0;
        }

        .dark-theme .breadcrumb-panel {
            background: #2d2d2d;
            border-color: #404040;
            color: #e9ecef;
        }

        .breadcrumb-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 1px solid #eee;
        }

        .dark-theme .breadcrumb-header {
            border-bottom-color: #404040;
        }

        .breadcrumb-header h4 {
            margin: 0;
            font-size: 16px;
        }

        .breadcrumb-list {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .breadcrumb-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 8px;
            border-radius: 6px;
            background: #f8f9fa;
        }

        .dark-theme .breadcrumb-item {
            background: #404040;
        }

        .breadcrumb-step {
            background: #007bff;
            color: white;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: 600;
        }

        .breadcrumb-call {
            flex: 1;
            font-family: monospace;
            font-size: 13px;
        }

        .breadcrumb-count {
            font-size: 11px;
            color: #666;
            background: #e9ecef;
            padding: 2px 6px;
            border-radius: 12px;
        }

        .dark-theme .breadcrumb-count {
            color: #adb5bd;
            background: #2d2d2d;
        }

        /* Trace mode styles */
        .runtime-only {
            opacity: 0.3 !important;
        }

        .static-only {
            opacity: 0.3 !important;
            stroke-dasharray: 5,5 !important;
        }

        .compare-mode .conflict {
            background-color: #ffc107 !important;
            border-color: #ff9800 !important;
            border-width: 3px !important;
            animation: conflict-pulse 2s infinite;
        }

        @keyframes conflict-pulse {
            0% { opacity: 1; }
            50% { opacity: 0.7; }
            100% { opacity: 1; }
        }

        /* Enhanced Tour Styles */
        .tour-header {
            margin-bottom: 20px;
        }

        .tour-title {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .tour-title h4 {
            margin: 0;
            font-size: 18px;
            color: #2c3e50;
        }

        .dark-theme .tour-title h4 {
            color: #e9ecef;
        }

        .tour-stats {
            display: flex;
            gap: 12px;
        }

        .stat-item {
            font-size: 12px;
            color: #666;
            background: #f8f9fa;
            padding: 4px 8px;
            border-radius: 12px;
        }

        .dark-theme .stat-item {
            color: #adb5bd;
            background: #404040;
        }

        .tour-filters {
            display: flex;
            gap: 8px;
            margin-bottom: 16px;
        }

        .filter-btn {
            padding: 6px 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            background: white;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.2s;
        }

        .dark-theme .filter-btn {
            background: #2d2d2d;
            border-color: #404040;
            color: #e9ecef;
        }

        .filter-btn:hover {
            background: #f8f9fa;
        }

        .dark-theme .filter-btn:hover {
            background: #404040;
        }

        .filter-btn.active {
            background: #007bff;
            color: white;
            border-color: #007bff;
        }

        .tour-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 20px;
            padding-top: 16px;
            border-top: 1px solid #eee;
        }

        .dark-theme .tour-controls {
            border-top-color: #404040;
        }

        .tour-nav, .tour-export {
            display: flex;
            gap: 8px;
        }

        .tour-timeline-item {
            display: flex;
            align-items: flex-start;
            margin-bottom: 16px;
            position: relative;
        }

        .timeline-marker {
            position: relative;
            margin-right: 16px;
        }

        .timeline-dot {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: #e9ecef;
            border: 2px solid #dee2e6;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: 600;
            position: relative;
            z-index: 2;
        }

        .tour-timeline-item.active .timeline-dot {
            background: #007bff;
            border-color: #0056b3;
            color: white;
        }

        .tour-timeline-item.completed .timeline-dot {
            background: #28a745;
            border-color: #1e7e34;
            color: white;
        }

        .tour-timeline-item.bookmarked .timeline-dot {
            border-color: #ffc107;
        }

        .timeline-line {
            position: absolute;
            left: 50%;
            top: 32px;
            width: 2px;
            height: 20px;
            background: #dee2e6;
            transform: translateX(-50%);
        }

        .timeline-content {
            flex: 1;
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 16px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .dark-theme .timeline-content {
            background: #2d2d2d;
            border-color: #404040;
        }

        .timeline-content:hover {
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            transform: translateY(-1px);
        }

        .tour-timeline-item.active .timeline-content {
            border-color: #007bff;
            box-shadow: 0 0 0 2px rgba(0, 123, 255, 0.25);
        }

        .timeline-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 8px;
        }

        .timeline-header h5 {
            margin: 0;
            font-size: 16px;
            color: #2c3e50;
        }

        .dark-theme .timeline-header h5 {
            color: #e9ecef;
        }

        .timeline-actions {
            display: flex;
            gap: 4px;
        }

        .btn-icon {
            width: 28px;
            height: 28px;
            border: none;
            background: #f8f9fa;
            border-radius: 4px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            transition: background-color 0.2s;
        }

        .dark-theme .btn-icon {
            background: #404040;
            color: #e9ecef;
        }

        .btn-icon:hover {
            background: #e9ecef;
        }

        .dark-theme .btn-icon:hover {
            background: #505050;
        }

        .timeline-details p {
            margin: 0 0 8px 0;
            color: #666;
            line-height: 1.4;
        }

        .dark-theme .timeline-details p {
            color: #adb5bd;
        }

        .step-focus, .step-time {
            font-size: 12px;
            color: #666;
            margin-top: 4px;
        }

        .dark-theme .step-focus, .dark-theme .step-time {
            color: #adb5bd;
        }

        .tour-step-detail {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 16px;
            margin-top: 16px;
        }

        .dark-theme .tour-step-detail {
            background: #404040;
            border-color: #505050;
            color: #e9ecef;
        }

        .current-step-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 1px solid #dee2e6;
        }

        .dark-theme .current-step-header {
            border-bottom-color: #505050;
        }

        .current-step-header h5 {
            margin: 0;
            font-size: 18px;
            color: #2c3e50;
        }

        .dark-theme .current-step-header h5 {
            color: #e9ecef;
        }

        .step-meta {
            display: flex;
            gap: 12px;
            font-size: 12px;
            color: #666;
        }

        .dark-theme .step-meta {
            color: #adb5bd;
        }

        .step-why {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 6px;
            padding: 8px;
            margin: 8px 0;
            font-size: 13px;
        }

        .dark-theme .step-why {
            background: #664d03;
            border-color: #ffc107;
            color: #fff3cd;
        }

        .step-focus-nodes {
            background: #d1ecf1;
            border: 1px solid #bee5eb;
            border-radius: 6px;
            padding: 8px;
            margin: 8px 0;
            font-size: 13px;
        }

        .dark-theme .step-focus-nodes {
            background: #0c5460;
            border-color: #17a2b8;
            color: #d1ecf1;
        }

        .tour-keyboard-help {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 12px;
            margin-top: 16px;
            font-size: 12px;
        }

        .dark-theme .tour-keyboard-help {
            background: #404040;
            border-color: #505050;
            color: #e9ecef;
        }

        .keyboard-shortcuts h6 {
            margin: 0 0 8px 0;
            font-size: 13px;
            color: #666;
        }

        .dark-theme .keyboard-shortcuts h6 {
            color: #adb5bd;
        }

        .shortcut-list {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
        }

        .shortcut-list span {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .shortcut-list kbd {
            background: #e9ecef;
            border: 1px solid #adb5bd;
            border-radius: 3px;
            padding: 2px 4px;
            font-size: 10px;
            font-family: monospace;
        }

        .dark-theme .shortcut-list kbd {
            background: #505050;
            border-color: #6c757d;
            color: #e9ecef;
        }

        /* Modal styles for step details */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
        }

        .modal-content {
            background: white;
            border-radius: 8px;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
        }

        .dark-theme .modal-content {
            background: #2d2d2d;
            color: #e9ecef;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px;
            border-bottom: 1px solid #dee2e6;
        }

        .dark-theme .modal-header {
            border-bottom-color: #404040;
        }

        .modal-header h3 {
            margin: 0;
            font-size: 18px;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #666;
            padding: 0;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 4px;
        }

        .close-btn:hover {
            background: #f8f9fa;
            color: #000;
        }

        .dark-theme .close-btn {
            color: #adb5bd;
        }

        .dark-theme .close-btn:hover {
            background: #404040;
            color: #e9ecef;
        }

        .modal-body {
            padding: 16px;
        }

        .step-detail-section {
            margin-bottom: 16px;
        }

        .step-detail-section h4 {
            margin: 0 0 8px 0;
            font-size: 16px;
            color: #2c3e50;
        }

        .dark-theme .step-detail-section h4 {
            color: #e9ecef;
        }

        .step-detail-section p {
            margin: 0;
            color: #666;
            line-height: 1.4;
        }

        .dark-theme .step-detail-section p {
            color: #adb5bd;
        }

        .step-actions {
            display: flex;
            gap: 8px;
        }

        /* Enhanced Lens Styles */
        .lens-panel {
            background: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 16px;
            margin: 16px 0;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            max-height: 80vh;
            overflow-y: auto;
        }

        .dark-theme .lens-panel {
            background: #2d2d2d;
            border-color: #404040;
            color: #e9ecef;
        }

        .lens-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
            padding-bottom: 8px;
            border-bottom: 1px solid #eee;
        }

        .dark-theme .lens-header {
            border-bottom-color: #404040;
        }

        .lens-header h4 {
            margin: 0;
            font-size: 18px;
        }

        .lens-content {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .lens-presets h5, .lens-seeds h5, .lens-filters h5, .lens-preview h5 {
            margin: 0 0 8px 0;
            font-size: 14px;
            color: #666;
        }

        .dark-theme .lens-presets h5, .dark-theme .lens-seeds h5, 
        .dark-theme .lens-filters h5, .dark-theme .lens-preview h5 {
            color: #adb5bd;
        }

        .preset-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .preset-btn {
            padding: 6px 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            background: white;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.2s;
        }

        .dark-theme .preset-btn {
            background: #2d2d2d;
            border-color: #404040;
            color: #e9ecef;
        }

        .preset-btn:hover {
            background: #f8f9fa;
            transform: translateY(-1px);
        }

        .dark-theme .preset-btn:hover {
            background: #404040;
        }

        .seed-input-container {
            display: flex;
            gap: 8px;
            margin-bottom: 8px;
        }

        .seed-input {
            flex: 1;
            padding: 6px 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 12px;
        }

        .dark-theme .seed-input {
            background: #2d2d2d;
            border-color: #404040;
            color: #e9ecef;
        }

        .add-seed-btn {
            padding: 6px 12px;
            border: 1px solid #007bff;
            border-radius: 4px;
            background: #007bff;
            color: white;
            cursor: pointer;
            font-size: 12px;
        }

        .add-seed-btn:hover {
            background: #0056b3;
        }

        .seeds-list {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .seed-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 4px 8px;
            background: #f8f9fa;
            border-radius: 4px;
            font-size: 12px;
        }

        .dark-theme .seed-item {
            background: #404040;
        }

        .seed-name {
            font-family: monospace;
        }

        .remove-seed-btn {
            width: 16px;
            height: 16px;
            border: none;
            background: #dc3545;
            color: white;
            border-radius: 50%;
            cursor: pointer;
            font-size: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .remove-seed-btn:hover {
            background: #c82333;
        }

        .filter-group {
            margin-bottom: 12px;
        }

        .filter-group h6 {
            margin: 0 0 6px 0;
            font-size: 12px;
            color: #666;
            font-weight: 600;
        }

        .dark-theme .filter-group h6 {
            color: #adb5bd;
        }

        .filter-controls {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .slider {
            flex: 1;
            height: 4px;
            border-radius: 2px;
            background: #ddd;
            outline: none;
            -webkit-appearance: none;
        }

        .slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: #007bff;
            cursor: pointer;
        }

        .filter-options {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .filter-options label {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 12px;
            cursor: pointer;
        }

        .module-input {
            width: 100%;
            padding: 4px 6px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 11px;
            margin-bottom: 4px;
        }

        .dark-theme .module-input {
            background: #2d2d2d;
            border-color: #404040;
            color: #e9ecef;
        }

        .preview-stats {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .preview-stat {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 11px;
        }

        .lens-actions {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .apply-lens-btn, .reset-lens-btn, .save-preset-btn, .load-preset-btn {
            padding: 6px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            background: white;
            cursor: pointer;
            font-size: 11px;
            transition: background-color 0.2s;
        }

        .dark-theme .apply-lens-btn, .dark-theme .reset-lens-btn, 
        .dark-theme .save-preset-btn, .dark-theme .load-preset-btn {
            background: #2d2d2d;
            border-color: #404040;
            color: #e9ecef;
        }

        .apply-lens-btn {
            background: #007bff;
            color: white;
            border-color: #007bff;
        }

        .apply-lens-btn:hover {
            background: #0056b3;
        }

        .reset-lens-btn:hover, .save-preset-btn:hover, .load-preset-btn:hover {
            background: #f8f9fa;
        }

        .dark-theme .reset-lens-btn:hover, .dark-theme .save-preset-btn:hover, 
        .dark-theme .load-preset-btn:hover {
            background: #404040;
        }

        .lens-url {
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid #eee;
        }

        .dark-theme .lens-url {
            border-top-color: #404040;
        }

        .lens-url h6 {
            margin: 0 0 6px 0;
            font-size: 12px;
            color: #666;
        }

        .dark-theme .lens-url h6 {
            color: #adb5bd;
        }

        .url-container {
            display: flex;
            gap: 4px;
        }

        .url-input {
            flex: 1;
            padding: 4px 6px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 10px;
            font-family: monospace;
            background: #f8f9fa;
        }

        .dark-theme .url-input {
            background: #404040;
            border-color: #505050;
            color: #e9ecef;
        }

        .copy-url-btn {
            padding: 4px 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            background: white;
            cursor: pointer;
            font-size: 10px;
        }

        .dark-theme .copy-url-btn {
            background: #2d2d2d;
            border-color: #404040;
            color: #e9ecef;
        }

        .copy-url-btn:hover {
            background: #f8f9fa;
        }

        .dark-theme .copy-url-btn:hover {
            background: #404040;
        }

        /* Preset list styles */
        .preset-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .preset-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .dark-theme .preset-item {
            border-color: #404040;
        }

        .preset-item:hover {
            background: #f8f9fa;
        }

        .dark-theme .preset-item:hover {
            background: #404040;
        }

        .preset-info h4 {
            margin: 0 0 4px 0;
            font-size: 14px;
        }

        .preset-info p {
            margin: 0;
            font-size: 11px;
            color: #666;
        }

        .dark-theme .preset-info p {
            color: #adb5bd;
        }

        .delete-preset-btn {
            padding: 4px 8px;
            border: none;
            background: #dc3545;
            color: white;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }

        .delete-preset-btn:hover {
            background: #c82333;
        }

        /* Lens highlighting styles */
        .lens-highlighted {
            background-color: #fff3cd !important;
            border-color: #ffc107 !important;
            border-width: 3px !important;
            z-index: 5 !important;
        }

        .dark-theme .lens-highlighted {
            background-color: #664d03 !important;
            border-color: #ffc107 !important;
        }

        /* Export & PR Snippet Styles */
        .export-panel {
            background: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 16px;
            margin: 16px 0;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            max-height: 80vh;
            overflow-y: auto;
        }

        .dark-theme .export-panel {
            background: #2d2d2d;
            border-color: #404040;
            color: #e9ecef;
        }

        .export-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
            padding-bottom: 8px;
            border-bottom: 1px solid #eee;
        }

        .dark-theme .export-header {
            border-bottom-color: #404040;
        }

        .export-header h4 {
            margin: 0;
            font-size: 18px;
        }

        .export-formats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 12px;
            margin-bottom: 16px;
        }

        .format-card {
            border: 1px solid #ddd;
            border-radius: 6px;
            padding: 12px;
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
        }

        .dark-theme .format-card {
            border-color: #404040;
        }

        .format-card:hover {
            background: #f8f9fa;
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .dark-theme .format-card:hover {
            background: #404040;
        }

        .format-card.selected {
            border-color: #007bff;
            background: #e3f2fd;
        }

        .dark-theme .format-card.selected {
            background: #1e3a5f;
            border-color: #007bff;
        }

        .format-icon {
            font-size: 24px;
            margin-bottom: 8px;
        }

        .format-title {
            font-weight: 600;
            margin-bottom: 4px;
        }

        .format-description {
            font-size: 11px;
            color: #666;
            line-height: 1.3;
        }

        .dark-theme .format-description {
            color: #adb5bd;
        }

        .export-options {
            margin-bottom: 16px;
        }

        .export-options h5 {
            margin: 0 0 8px 0;
            font-size: 14px;
            color: #666;
        }

        .dark-theme .export-options h5 {
            color: #adb5bd;
        }

        .option-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-bottom: 12px;
        }

        .option-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .option-item label {
            font-size: 12px;
            cursor: pointer;
        }

        .export-preview {
            background: #f8f9fa;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 12px;
            margin-bottom: 16px;
            font-family: monospace;
            font-size: 11px;
            max-height: 200px;
            overflow-y: auto;
        }

        .dark-theme .export-preview {
            background: #404040;
            border-color: #505050;
            color: #e9ecef;
        }

        .export-actions {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .export-btn, .preview-btn, .copy-btn {
            padding: 8px 16px;
            border: 1px solid #ddd;
            border-radius: 4px;
            background: white;
            cursor: pointer;
            font-size: 12px;
            transition: background-color 0.2s;
        }

        .dark-theme .export-btn, .dark-theme .preview-btn, .dark-theme .copy-btn {
            background: #2d2d2d;
            border-color: #404040;
            color: #e9ecef;
        }

        .export-btn {
            background: #007bff;
            color: white;
            border-color: #007bff;
        }

        .export-btn:hover {
            background: #0056b3;
        }

        .preview-btn:hover, .copy-btn:hover {
            background: #f8f9fa;
        }

        .dark-theme .preview-btn:hover, .dark-theme .copy-btn:hover {
            background: #404040;
        }

        /* PR Snippet Styles */
        .pr-snippet {
            background: #f8f9fa;
            border: 1px solid #ddd;
            border-radius: 6px;
            padding: 16px;
            margin: 16px 0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }

        .dark-theme .pr-snippet {
            background: #404040;
            border-color: #505050;
            color: #e9ecef;
        }

        .pr-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 1px solid #ddd;
        }

        .dark-theme .pr-header {
            border-bottom-color: #505050;
        }

        .pr-icon {
            font-size: 20px;
        }

        .pr-title {
            font-weight: 600;
            font-size: 16px;
        }

        .pr-summary {
            margin-bottom: 16px;
        }

        .pr-summary h4 {
            margin: 0 0 8px 0;
            font-size: 14px;
            color: #666;
        }

        .dark-theme .pr-summary h4 {
            color: #adb5bd;
        }

        .pr-summary p {
            margin: 0;
            font-size: 13px;
            line-height: 1.4;
        }

        .pr-deltas {
            margin-bottom: 16px;
        }

        .delta-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 12px;
        }

        .delta-table th, .delta-table td {
            padding: 6px 8px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }

        .dark-theme .delta-table th, .dark-theme .delta-table td {
            border-bottom-color: #505050;
        }

        .delta-table th {
            background: #f8f9fa;
            font-weight: 600;
        }

        .dark-theme .delta-table th {
            background: #404040;
        }

        .delta-positive {
            color: #28a745;
        }

        .delta-negative {
            color: #dc3545;
        }

        .delta-neutral {
            color: #6c757d;
        }

        .pr-insights {
            background: #e3f2fd;
            border: 1px solid #bbdefb;
            border-radius: 4px;
            padding: 12px;
            margin-bottom: 16px;
        }

        .dark-theme .pr-insights {
            background: #1e3a5f;
            border-color: #1976d2;
        }

        .pr-insights h5 {
            margin: 0 0 8px 0;
            font-size: 13px;
            color: #1976d2;
        }

        .dark-theme .pr-insights h5 {
            color: #64b5f6;
        }

        .pr-insights ul {
            margin: 0;
            padding-left: 16px;
        }

        .pr-insights li {
            font-size: 12px;
            margin-bottom: 4px;
        }

        .pr-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-top: 8px;
            border-top: 1px solid #ddd;
            font-size: 11px;
            color: #666;
        }

        .dark-theme .pr-footer {
            border-top-color: #505050;
            color: #adb5bd;
        }

        .pr-actions {
            display: flex;
            gap: 8px;
        }

        .pr-action-btn {
            padding: 4px 8px;
            border: 1px solid #ddd;
            border-radius: 3px;
            background: white;
            cursor: pointer;
            font-size: 10px;
            transition: background-color 0.2s;
        }

        .dark-theme .pr-action-btn {
            background: #2d2d2d;
            border-color: #404040;
            color: #e9ecef;
        }

        .pr-action-btn:hover {
            background: #f8f9fa;
        }

        .dark-theme .pr-action-btn:hover {
            background: #404040;
        }

        /* Export modal styles */
        .export-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .export-modal-content {
            background: white;
            border-radius: 8px;
            padding: 24px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .dark-theme .export-modal-content {
            background: #2d2d2d;
            color: #e9ecef;
        }

        .export-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 12px;
            border-bottom: 1px solid #ddd;
        }

        .dark-theme .export-modal-header {
            border-bottom-color: #404040;
        }

        .export-modal-header h3 {
            margin: 0;
            font-size: 20px;
        }

        .close-modal-btn {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #666;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .dark-theme .close-modal-btn {
            color: #adb5bd;
        }

        .close-modal-btn:hover {
            color: #000;
        }

        .dark-theme .close-modal-btn:hover {
            color: #fff;
        }

        /* High Contrast for Focus */
        @media (prefers-contrast: high) {
            .focus-ring {
                outline: 3px solid #000000;
                outline-offset: 3px;
            }
            
            .btn:focus {
                outline: 3px solid #000000;
                outline-offset: 3px;
            }
        }

        .graph-canvas {
            width: 100%;
            height: 100%;
            background: #f8f9fa;
            position: relative;
        }

        .map-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .map-controls {
            display: flex;
            gap: 8px;
        }

        .map-container {
            position: relative;
        }

        .minimap {
            position: absolute;
            top: 10px;
            right: 10px;
            width: 150px;
            height: 100px;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            background: white;
            z-index: 10;
        }

        .hover-card {
            position: absolute;
            top: 10px;
            left: 10px;
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            z-index: 20;
            max-width: 250px;
        }

        .hover-card-content h4 {
            margin: 0 0 10px 0;
            color: #1a252f;
            font-size: 1.1rem;
        }

        .hover-details {
            font-size: 0.9rem;
            color: #6c757d;
        }

        .hover-details div {
            margin-bottom: 4px;
        }

        .conflict-badge {
            background-color: #e74c3c !important;
            border-color: #c0392b !important;
            border-width: 3px !important;
        }

        .conflict-alert {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            border-radius: 4px;
            padding: 8px 12px;
            color: #721c24;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.9rem;
        }

        .conflict-icon {
            font-size: 1.2rem;
        }

        .trace-controls {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
            margin-top: 10px;
        }

        .trace-controls h4 {
            margin: 0 0 10px 0;
            color: #495057;
            font-size: 1rem;
        }

        .trace-toggle {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 10px;
        }

        .trace-toggle input[type="checkbox"] {
            margin: 0;
        }

        .breadcrumb-list {
            display: flex;
            flex-wrap: wrap;
            gap: 4px;
        }

        .breadcrumb-item {
            background: #e9ecef;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 0.8rem;
            color: #495057;
        }

        .tour-timeline {
            max-height: 400px;
            overflow-y: auto;
            padding: 10px 0;
        }

        .tour-timeline-item {
            display: flex;
            margin-bottom: 20px;
            position: relative;
        }

        .timeline-marker {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-right: 15px;
        }

        .timeline-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #dee2e6;
            border: 2px solid #fff;
            z-index: 2;
            position: relative;
        }

        .timeline-line {
            width: 2px;
            height: 30px;
            background: #dee2e6;
            margin-top: -1px;
        }

        .tour-timeline-item.active .timeline-dot {
            background: #007acc;
            border-color: #007acc;
        }

        .tour-timeline-item.completed .timeline-dot {
            background: #28a745;
            border-color: #28a745;
        }

        .timeline-content {
            flex: 1;
            background: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .timeline-content:hover {
            background: #e9ecef;
            transform: translateX(2px);
        }

        .timeline-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .timeline-header h5 {
            margin: 0;
            color: #1a252f;
            font-size: 1rem;
        }

        .timeline-actions {
            display: flex;
            gap: 5px;
        }

        .btn-icon {
            background: none;
            border: none;
            padding: 4px;
            cursor: pointer;
            border-radius: 4px;
            transition: background 0.2s;
        }

        .btn-icon:hover {
            background: #dee2e6;
        }

        /* Accessibility styles */
        .skip-links {
            position: absolute;
            top: -40px;
            left: 6px;
            z-index: 1000;
        }

        .skip-link {
            position: absolute;
            left: -9999px;
            width: 1px;
            height: 1px;
            overflow: hidden;
            background: #000;
            color: #fff;
            padding: 8px 16px;
            text-decoration: none;
            border-radius: 4px;
        }

        .skip-link:focus {
            position: static;
            width: auto;
            height: auto;
            left: 6px;
            top: 6px;
        }

        .focus-ring {
            outline: 3px solid #007bff;
            outline-offset: 2px;
        }

        .accessibility-btn {
            background: #6c757d;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            margin-left: 8px;
        }

        .accessibility-btn:hover {
            background: #5a6268;
        }

        .accessibility-btn:focus {
            outline: 3px solid #007bff;
            outline-offset: 2px;
        }

        /* High contrast theme */
        .high-contrast {
            --primary-color: #0000ff;
            --secondary-color: #000000;
            --success-color: #008000;
            --danger-color: #ff0000;
            --warning-color: #ffff00;
            --info-color: #00ffff;
            --light-color: #ffffff;
            --dark-color: #000000;
            --border-color: #000000;
        }

        .high-contrast .btn {
            background: var(--primary-color);
            color: var(--light-color);
            border: 2px solid var(--dark-color);
        }

        .high-contrast .btn:hover {
            background: var(--dark-color);
            color: var(--light-color);
        }

        .high-contrast .card {
            border: 2px solid var(--dark-color);
            background: var(--light-color);
            color: var(--dark-color);
        }

        .high-contrast .pane {
            border: 2px solid var(--dark-color);
        }

        .high-contrast .header {
            background: var(--dark-color);
            color: var(--light-color);
        }

        .high-contrast .header h1 {
            color: var(--light-color);
        }

        .high-contrast .filter-chip {
            border: 2px solid var(--dark-color);
            background: var(--light-color);
            color: var(--dark-color);
        }

        .high-contrast .filter-chip.active {
            background: var(--primary-color);
            color: var(--light-color);
        }

        .high-contrast .export-btn {
            border: 2px solid var(--dark-color);
        }

        .high-contrast .export-btn.primary {
            background: var(--primary-color);
            color: var(--light-color);
        }

        .high-contrast .export-btn:hover {
            background: var(--dark-color);
            color: var(--light-color);
        }

        /* Screen reader only content */
        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border: 0;
        }

        /* Enhanced focus indicators */
        button:focus,
        input:focus,
        select:focus,
        textarea:focus,
        [tabindex]:focus {
            outline: 3px solid #007bff;
            outline-offset: 2px;
        }

        /* High contrast focus indicators */
        .high-contrast button:focus,
        .high-contrast input:focus,
        .high-contrast select:focus,
        .high-contrast textarea:focus,
        .high-contrast [tabindex]:focus {
            outline: 3px solid #ffff00;
            outline-offset: 2px;
        }

        .timeline-details p {
            margin: 0;
            color: #6c757d;
            font-size: 0.9rem;
            line-height: 1.4;
        }

        .tour-progress {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
        }

        .progress-bar {
            flex: 1;
            height: 8px;
            background: #e9ecef;
            border-radius: 4px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: #007acc;
            transition: width 0.3s ease;
        }

        .progress-text {
            font-size: 0.9rem;
            color: #6c757d;
            font-weight: 500;
        }

        .tour-controls {
            display: flex;
            gap: 8px;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #dee2e6;
        }

        .tour-step-detail {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
        }

        .tour-step-detail h5 {
            margin: 0 0 10px 0;
            color: #1a252f;
        }

        .lens-actions {
            display: flex;
            gap: 8px;
            margin-top: 10px;
        }

        .lens-summary {
            background: #f8f9fa;
            border-radius: 6px;
            padding: 10px;
        }

        .lens-filters {
            display: flex;
            flex-wrap: wrap;
            gap: 4px;
            margin-top: 8px;
        }

        .filter-tag {
            background: #007acc;
            color: white;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 0.8rem;
        }

        .presets-list {
            max-height: 200px;
            overflow-y: auto;
        }

        .preset-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px;
            background: #f8f9fa;
            border-radius: 4px;
            margin-bottom: 4px;
        }

        .preset-name {
            font-weight: 500;
            color: #1a252f;
        }

        .preset-actions {
            display: flex;
            gap: 4px;
        }

        .no-presets {
            color: #6c757d;
            font-style: italic;
            text-align: center;
            padding: 20px;
        }

        .filter-chip.active {
            background: #007acc;
            color: white;
        }

        .filter-chip {
            background: #e9ecef;
            border: 1px solid #dee2e6;
            padding: 4px 8px;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 0.8rem;
        }

        .filter-chip:hover {
            background: #dee2e6;
        }

        .insight-panel {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .insight-card {
            background: #f8f9fa;
            border: 1px solid #e1e8ed;
            border-radius: 8px;
            padding: 16px;
        }

        .insight-card h4 {
            margin-bottom: 8px;
            color: #495057;
            font-size: 14px;
            font-weight: 600;
        }

        .progress-milestones {
            display: flex;
            justify-content: space-between;
            margin: 20px 0;
            padding: 0 20px;
        }

        .milestone {
            display: flex;
            flex-direction: column;
            align-items: center;
            flex: 1;
        }

        .milestone-dot {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: #e1e8ed;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 8px;
            transition: all 0.3s;
        }

        .milestone-dot.active {
            background: #495057;
            color: white;
        }

        .milestone-dot.completed {
            background: #17a2b8;
            color: white;
        }

        .milestone-label {
            font-size: 12px;
            color: #6c757d;
            text-align: center;
        }

        .tour-reader {
            background: white;
            border: 1px solid #e1e8ed;
            border-radius: 8px;
            overflow: hidden;
        }

        .tour-timeline {
            display: flex;
            flex-direction: column;
            gap: 12px;
            padding: 16px;
        }

        .tour-step {
            position: relative;
            padding: 16px;
            border: 1px solid #e1e8ed;
            border-radius: 8px;
            background: #f8f9fa;
            transition: all 0.2s;
        }

        .tour-step.active {
            border-color: #495057;
            background: white;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .tour-step h4 {
            color: #495057;
            margin-bottom: 8px;
            font-size: 14px;
        }

        .tour-step p {
            color: #6c757d;
            font-size: 13px;
            line-height: 1.4;
        }

        .filter-bar {
            display: flex;
            gap: 10px;
            margin-bottom: 16px;
            flex-wrap: wrap;
        }

        .filter-chip {
            background: #e1e8ed;
            color: #495057;
            border: none;
            padding: 6px 12px;
            border-radius: 16px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .filter-chip.active {
            background: #495057;
            color: white;
        }

        .filter-chip:hover {
            background: #6c757d;
            color: white;
        }

        .minimap {
            position: absolute;
            top: 16px;
            right: 16px;
            width: 200px;
            height: 150px;
            background: white;
            border: 1px solid #e1e8ed;
            border-radius: 8px;
            opacity: 0.8;
            z-index: 10;
        }

        .toolbar {
            display: flex;
            gap: 10px;
            padding: 12px 16px;
            background: #f8f9fa;
            border-bottom: 1px solid #e1e8ed;
            flex-wrap: wrap;
        }

        .toolbar-btn {
            background: white;
            border: 1px solid #e1e8ed;
            padding: 8px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.2s;
        }

        .toolbar-btn:hover {
            background: #495057;
            color: white;
        }

        .toolbar-btn.active {
            background: #495057;
            color: white;
        }

        .keyboard-shortcuts {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 16px;
            border-radius: 8px;
            font-size: 12px;
            z-index: 100;
            display: none;
        }

        .shortcut-item {
            display: flex;
            justify-content: space-between;
            margin: 4px 0;
            gap: 16px;
        }

        .shortcut-key {
            background: rgba(255, 255, 255, 0.2);
            padding: 2px 6px;
            border-radius: 3px;
            font-family: monospace;
        }

        .accessibility-skip {
            position: absolute;
            left: -9999px;
            top: 0;
            background: #495057;
            color: white;
            padding: 8px 16px;
            text-decoration: none;
            z-index: 1001;
        }

        .accessibility-skip:focus {
            left: 0;
        }

        @media (max-width: 768px) {
            .three-pane-layout {
                grid-template-columns: 1fr;
                grid-template-rows: auto 1fr auto;
                height: auto;
            }
            
            .wizard-modal {
                width: 95%;
                padding: 20px;
            }
            
            .toolbar {
                flex-direction: column;
            }
            
            .minimap {
                position: relative;
                width: 100%;
                height: 100px;
                margin-top: 16px;
            }
        }

        /* Dark theme support */
        @media (prefers-color-scheme: dark) {
            body {
                background: #1a1a1a;
                color: #e0e0e0;
            }
            
            .header, .demo-section, .pane {
                background: #2d2d2d;
                border-color: #404040;
            }
            
            .code-input, .code-editor {
                background: #1e1e1e;
                border-color: #404040;
                color: #e0e0e0;
            }
            
            .tab.active {
                background: #3d3d3d;
                color: #e0e0e0;
            }
        }

        /* High contrast theme */
        @media (prefers-contrast: high) {
            .analyze-btn, .sample-button {
                border: 2px solid #000;
            }
            
            .tour-step.active {
                border-width: 2px;
            }
            
            .milestone-dot.active, .milestone-dot.completed {
                border: 2px solid #000;
            }
        }

        /* Enhanced features CSS */
        .conflict-badge {
            background: #f8d7da;
            color: #721c24;
            padding: 8px 12px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
            margin-left: 10px;
            border: 1px solid #f5c6cb;
        }

        .lens-panel {
            position: absolute;
            top: 0;
            right: 0;
            width: 300px;
            height: 100%;
            background: white;
            border-left: 1px solid #e1e8ed;
            z-index: 100;
            display: none;
            overflow-y: auto;
        }

        .lens-header {
            background: #f8f9fa;
            padding: 12px 16px;
            border-bottom: 1px solid #e1e8ed;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .lens-header h4 {
            margin: 0;
            color: #495057;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 18px;
            cursor: pointer;
            color: #6c757d;
        }

        .lens-content {
            padding: 16px;
        }

        .lens-seeds, .lens-filters, .lens-actions {
            margin-bottom: 20px;
        }

        .lens-seeds h5, .lens-filters h5 {
            margin-bottom: 8px;
            color: #495057;
            font-size: 14px;
        }

        .seed-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 6px 8px;
            background: #f8f9fa;
            border-radius: 4px;
            margin-bottom: 4px;
            font-size: 12px;
        }

        .remove-seed-btn {
            background: #dc3545;
            color: white;
            border: none;
            border-radius: 3px;
            width: 20px;
            height: 20px;
            cursor: pointer;
            font-size: 12px;
        }

        .add-seed-btn, .save-lens-btn, .load-lens-btn {
            background: #495057;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            margin-right: 8px;
        }

        .add-seed-btn:hover, .save-lens-btn:hover, .load-lens-btn:hover {
            background: #343a40;
        }

        .lens-filters label {
            display: block;
            margin-bottom: 6px;
            font-size: 12px;
            cursor: pointer;
        }

        .lens-filters input[type="checkbox"] {
            margin-right: 6px;
        }

        .export-menu {
            background: white;
            border: 1px solid #e1e8ed;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            padding: 8px 0;
            min-width: 200px;
        }

        .export-option {
            display: flex;
            align-items: center;
            padding: 8px 16px;
            cursor: pointer;
            transition: background 0.2s;
        }

        .export-option:hover {
            background: #f8f9fa;
        }

        .export-icon {
            margin-right: 8px;
            font-size: 16px;
        }

        .success-message {
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .trace-path {
            background-color: #f39c12 !important;
            border-color: #e67e22 !important;
        }

        .conflict {
            background-color: #dc3545 !important;
            border-color: #c82333 !important;
            animation: pulse 1s infinite;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.7; }
            100% { opacity: 1; }
        }

        .search-highlight {
            background-color: #fff3cd !important;
            border-color: #ffeaa7 !important;
        }

        .filtered {
            opacity: 0.3;
        }

        /* Enhanced tour reader */
        .tour-reader {
            max-height: 400px;
            overflow-y: auto;
        }

        .tour-step {
            cursor: pointer;
            transition: all 0.2s;
        }

        .tour-step:hover {
            background: #e9ecef;
        }

        .tour-step.active {
            background: #495057;
            color: white;
        }

        .tour-step.active h4 {
            color: white;
        }

        /* Enhanced minimap */
        .minimap {
            background: white;
            border: 1px solid #e1e8ed;
            border-radius: 8px;
            overflow: hidden;
        }

        #cy-minimap {
            width: 100%;
            height: 100%;
        }

        /* Enhanced toolbar */
        .toolbar-btn.active {
            background: #495057;
            color: white;
        }

        .toolbar-btn:hover {
            background: #6c757d;
            color: white;
        }

        /* Enhanced accessibility */
        .accessibility-skip:focus {
            left: 0;
            z-index: 1001;
        }

        /* Enhanced keyboard shortcuts */
        .keyboard-shortcuts {
            background: rgba(0, 0, 0, 0.9);
            color: white;
            padding: 16px;
            border-radius: 8px;
            font-size: 12px;
            z-index: 100;
            max-width: 300px;
        }

        .shortcut-item {
            display: flex;
            justify-content: space-between;
            margin: 4px 0;
            gap: 16px;
        }

        .shortcut-key {
            background: rgba(255, 255, 255, 0.2);
            padding: 2px 6px;
            border-radius: 3px;
            font-family: monospace;
            font-size: 11px;
        }

        /* Footer Styles */
        .footer {
            background: #f8f9fa;
            border-top: 1px solid #e9ecef;
            margin-top: 40px;
            padding: 40px 0 20px;
        }

        .footer-content {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 30px;
        }

        .footer-section h3,
        .footer-section h4 {
            margin-bottom: 15px;
            color: #2c3e50;
        }

        .footer-section ul {
            list-style: none;
            padding: 0;
        }

        .footer-section ul li {
            margin-bottom: 8px;
        }

        .footer-section ul li a {
            color: #6c757d;
            text-decoration: none;
            transition: color 0.2s;
        }

        .footer-section ul li a:hover {
            color: #495057;
        }

        .footer-bottom {
            max-width: 1200px;
            margin: 20px auto 0;
            padding: 20px;
            text-align: center;
            border-top: 1px solid #e9ecef;
            color: #6c757d;
        }

        /* Header Navigation */
        .header-nav ul {
            list-style: none;
            display: flex;
            gap: 20px;
            margin-top: 15px;
            padding: 0;
        }

        .header-nav ul li a {
            color: #495057;
            text-decoration: none;
            padding: 8px 16px;
            border-radius: 4px;
            transition: all 0.2s;
        }

        .header-nav ul li a:hover {
            background: #e9ecef;
            color: #2c3e50;
        }

        .header-nav ul li a:focus {
            outline: 2px solid #007acc;
            outline-offset: 2px;
        }
    </style>
</head>
<body>
    <a href="#main-content" class="accessibility-skip">Skip to main content</a>
    
    <!-- Enhanced Onboarding Wizard -->
    <div class="wizard-overlay" id="wizardOverlay">
        <div class="wizard-modal">
            <div class="wizard-step active" id="wizardStep1">
                <div class="wizard-header">
                    <h2>🧠 Welcome to Understand-First!</h2>
                    <p>Get to understanding your code in under 10 minutes with our interactive analysis tools.</p>
                </div>
                
                <div class="wizard-samples">
                    <h3>Choose a sample to get started:</h3>
                    <div class="sample-grid">
                        <div class="sample-card" onclick="loadSampleCode('simple')">
                            <div class="sample-icon">🔧</div>
                            <h4>Simple Service</h4>
                            <p>Basic Python functions with clear call relationships</p>
                            <div class="sample-preview">
                                <code>def compute(x, y):<br>&nbsp;&nbsp;&nbsp;&nbsp;return add(x, y)</code>
                            </div>
                        </div>
                        
                        <div class="sample-card" onclick="loadSampleCode('async')">
                            <div class="sample-icon">⚡</div>
                            <h4>Async FastAPI</h4>
                            <p>Modern async patterns and API service architecture</p>
                            <div class="sample-preview">
                                <code>async def get_users():<br>&nbsp;&nbsp;&nbsp;&nbsp;return await service.fetch()</code>
                            </div>
                        </div>
                        
                        <div class="sample-card" onclick="loadSampleCode('complex')">
                            <div class="sample-icon">🏗️</div>
                            <h4>Complex Utils</h4>
                            <p>Class-heavy utilities with side effects and dependencies</p>
                            <div class="sample-preview">
                                <code>class UserService:<br>&nbsp;&nbsp;&nbsp;&nbsp;def create_user(self):</code>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="wizard-actions">
                    <button class="btn btn-outline" onclick="closeWizard()">Skip Wizard</button>
                    <div class="wizard-hint">
                        <span class="hint-icon">💡</span>
                        <span>Or paste your own Python code and press <kbd>⌘⏎</kbd> to analyze</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Keyboard Shortcuts Help -->
    <div class="keyboard-shortcuts" id="shortcutsHelp">
        <h4>Keyboard Shortcuts</h4>
        <div class="shortcut-item">
            <span>Analyze Code</span>
            <span class="shortcut-key">⌘⏎</span>
        </div>
        <div class="shortcut-item">
            <span>Go to Map</span>
            <span class="shortcut-key">g m</span>
        </div>
        <div class="shortcut-item">
            <span>Go to Tour</span>
            <span class="shortcut-key">g t</span>
        </div>
        <div class="shortcut-item">
            <span>Focus Search</span>
            <span class="shortcut-key">/</span>
        </div>
        <div class="shortcut-item">
            <span>Toggle Filters</span>
            <span class="shortcut-key">f</span>
        </div>
        <div class="shortcut-item">
            <span>Toggle Overlay</span>
            <span class="shortcut-key">o</span>
        </div>
        <div class="shortcut-item">
            <span>Show Help</span>
            <span class="shortcut-key">?</span>
        </div>
    </div>

    <main id="main-content" role="main">
        <div class="container">
            <header class="header" id="navigation" role="banner">
                <h1>Understand-First Web Playground</h1>
                <p>Interactive demonstration of advanced code analysis and understanding capabilities. Test static analysis, complexity metrics, and code visualization tools in real-time.</p>
                <nav class="header-nav" role="navigation" aria-label="Main navigation">
                    <ul>
                        <li><a href="#code-editor" aria-label="Go to code editor">Code</a></li>
                        <li><a href="#map-canvas" aria-label="Go to map visualization">Map</a></li>
                        <li><a href="#tour-panel" aria-label="Go to tour panel">Tour</a></li>
                        <li><a href="#metrics-panel" aria-label="Go to metrics panel">Metrics</a></li>
                    </ul>
                </nav>
            </header>

        <!-- Onboarding Wizard -->
        <div id="onboardingWizard" class="onboarding-wizard" style="display: none;">
            <div class="wizard-overlay"></div>
            <div class="wizard-content">
                <div class="wizard-header">
                    <h3>🧠 Welcome to Understand First!</h3>
                    <p class="wizard-subtitle">Let's get you up and running in minutes</p>
                    <button onclick="hideOnboardingWizard()" class="close-btn">×</button>
                </div>
                
                <div class="wizard-steps">
                    <!-- Step 1: Choose Starting Point -->
                    <div class="wizard-step active" id="wizardStep1">
                        <div class="step-header">
                            <div class="step-number">1</div>
                            <div class="step-title">
                                <h4>Choose Your Starting Point</h4>
                                <p>Select a sample or paste your own code to begin</p>
                            </div>
                        </div>
                        <div class="step-content">
                            <div class="sample-selector">
                                <h5>📚 Try These Samples:</h5>
                                <div class="sample-grid">
                                    <div class="sample-card" onclick="loadSampleFromWizard('simple')">
                                        <div class="sample-icon">🐍</div>
                                        <h6>Simple Service</h6>
                                        <p>Basic function calls and dependencies</p>
                                    </div>
                                    <div class="sample-card" onclick="loadSampleFromWizard('async')">
                                        <div class="sample-icon">⚡</div>
                                        <h6>Async FastAPI</h6>
                                        <p>Modern async patterns and API structure</p>
                                    </div>
                                    <div class="sample-card" onclick="loadSampleFromWizard('complex')">
                                        <div class="sample-icon">🏗️</div>
                                        <h6>Class-Heavy Utility</h6>
                                        <p>Complex inheritance and side effects</p>
                                    </div>
                                    <div class="sample-card" onclick="loadSampleFromWizard('data')">
                                        <div class="sample-icon">📊</div>
                                        <h6>Data Processing</h6>
                                        <p>Complex data transformations</p>
                                    </div>
                                </div>
                            </div>
                            <div class="code-input-section">
                                <h5>✍️ Or Paste Your Own Code:</h5>
                                <textarea id="onboardingCode" placeholder="Enter your Python code here...">def hello_world():
    \"\"\"A simple greeting function.\"\"\"
    print("Hello, World!")

def calculate_sum(a, b):
    \"\"\"Calculate the sum of two numbers.\"\"\"
    return a + b

class Calculator:
    \"\"\"A simple calculator class with history tracking.\"\"\"
    
    def __init__(self):
        self.history = []
    
    def add(self, x, y):
        result = x + y
        self.history.append(f"{x} + {y} = {result}")
        return result
    
    def multiply(self, x, y):
        result = x * y
        self.history.append(f"{x} * {y} = {result}")
        return result

if __name__ == "__main__":
    hello_world()
    calc = Calculator()
    result = calc.add(5, 3)
    print(f"Result: {result}")</textarea>
                                <div class="code-tips">
                                    <small>💡 Tip: Include functions, classes, and imports for best results</small>
                                </div>
                            </div>
                        </div>
                        <div class="step-actions">
                            <button onclick="nextWizardStep()" class="next-btn">Next →</button>
                        </div>
                    </div>
                    
                    <!-- Step 2: Analyze Code -->
                    <div class="wizard-step" id="wizardStep2">
                        <div class="step-header">
                            <div class="step-number">2</div>
                            <div class="step-title">
                                <h4>Analyze Your Code</h4>
                                <p>Let's understand the structure and relationships</p>
                            </div>
                        </div>
                        <div class="step-content">
                            <div class="analysis-preview">
                                <h5>🔍 What We'll Discover:</h5>
                                <ul class="analysis-features">
                                    <li>📊 Function complexity and metrics</li>
                                    <li>🔗 Call relationships and dependencies</li>
                                    <li>📁 Module structure and imports</li>
                                    <li>⚠️ Potential issues and improvements</li>
                                </ul>
                            </div>
                            <div class="wizard-actions">
                                <button onclick="analyzeCodeFromWizard()" class="analyze-btn">
                                    <span class="btn-icon">🔍</span>
                                    Analyze My Code
                                </button>
                                <div class="analysis-progress" id="analysisProgress" style="display: none;">
                                    <div class="progress-spinner"></div>
                                    <span>Analyzing code structure...</span>
                                </div>
                            </div>
                        </div>
                        <div class="step-actions">
                            <button onclick="prevWizardStep()" class="prev-btn">← Previous</button>
                            <button onclick="nextWizardStep()" class="next-btn" id="step2Next" disabled>Next →</button>
                        </div>
                    </div>
                    
                    <!-- Step 3: Explore Visualization -->
                    <div class="wizard-step" id="wizardStep3">
                        <div class="step-header">
                            <div class="step-number">3</div>
                            <div class="step-title">
                                <h4>Explore the Visualization</h4>
                                <p>Navigate and interact with your code graph</p>
                            </div>
                        </div>
                        <div class="step-content">
                            <div class="interaction-guide">
                                <h5>🎮 Interactive Features:</h5>
                                <div class="feature-grid">
                                    <div class="feature-item">
                                        <div class="feature-icon">🖱️</div>
                                        <div class="feature-text">
                                            <strong>Pan & Zoom</strong>
                                            <p>Drag to move, scroll to zoom</p>
                                        </div>
                                    </div>
                                    <div class="feature-item">
                                        <div class="feature-icon">👆</div>
                                        <div class="feature-text">
                                            <strong>Node Details</strong>
                                            <p>Click nodes for information</p>
                                        </div>
                                    </div>
                                    <div class="feature-item">
                                        <div class="feature-icon">🔗</div>
                                        <div class="feature-text">
                                            <strong>Relationships</strong>
                                            <p>Hover edges to see connections</p>
                                        </div>
                                    </div>
                                    <div class="feature-item">
                                        <div class="feature-icon">🔍</div>
                                        <div class="feature-text">
                                            <strong>Search & Filter</strong>
                                            <p>Find specific functions quickly</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="wizard-actions">
                                <button onclick="demonstrateInteraction()" class="demo-btn">
                                    <span class="btn-icon">🎯</span>
                                    Show Me How
                                </button>
                            </div>
                        </div>
                        <div class="step-actions">
                            <button onclick="prevWizardStep()" class="prev-btn">← Previous</button>
                            <button onclick="nextWizardStep()" class="next-btn">Next →</button>
                        </div>
                    </div>
                    
                    <!-- Step 4: Create Tour -->
                    <div class="wizard-step" id="wizardStep4">
                        <div class="step-header">
                            <div class="step-number">4</div>
                            <div class="step-title">
                                <h4>Create Your Learning Path</h4>
                                <p>Generate a personalized understanding tour</p>
                            </div>
                        </div>
                        <div class="step-content">
                            <div class="tour-options">
                                <h5>🗺️ Tour Options:</h5>
                                <div class="option-cards">
                                    <div class="option-card" onclick="selectTourOption('beginner')">
                                        <div class="option-icon">🌱</div>
                                        <h6>Beginner</h6>
                                        <p>Step-by-step introduction</p>
                                    </div>
                                    <div class="option-card" onclick="selectTourOption('advanced')">
                                        <div class="option-icon">🚀</div>
                                        <h6>Advanced</h6>
                                        <p>Deep dive into complexity</p>
                                    </div>
                                    <div class="option-card" onclick="selectTourOption('custom')">
                                        <div class="option-icon">⚙️</div>
                                        <h6>Custom</h6>
                                        <p>Focus on specific functions</p>
                                    </div>
                                </div>
                            </div>
                            <div class="wizard-actions">
                                <button onclick="generateTourFromWizard()" class="tour-btn" id="generateTourBtn" disabled>
                                    <span class="btn-icon">🗺️</span>
                                    Generate Tour
                                </button>
                                <div class="tour-progress" id="tourProgress" style="display: none;">
                                    <div class="progress-spinner"></div>
                                    <span>Creating your personalized tour...</span>
                                </div>
                            </div>
                        </div>
                        <div class="step-actions">
                            <button onclick="prevWizardStep()" class="prev-btn">← Previous</button>
                            <button onclick="finishWizard()" class="finish-btn">
                                <span class="btn-icon">🎉</span>
                                Start Exploring!
                            </button>
                        </div>
                    </div>
                </div>
                
                <div class="wizard-progress">
                    <div class="progress-bar">
                        <div class="progress-fill" id="wizardProgress"></div>
                    </div>
                    <div class="progress-info">
                        <span class="progress-text">Step <span id="currentStep">1</span> of 4</span>
                        <span class="progress-percentage" id="progressPercentage">25%</span>
                    </div>
                </div>
            </div>
        </div>

        <div class="demo-section">
            <h2>Interactive Code Analysis</h2>
            <p>Input Python code to analyze function relationships, complexity metrics, side effects, and execution patterns. The analysis engine performs static analysis to extract structural and behavioral insights.</p>
            
            <div class="toolbar">
                <button class="toolbar-btn" onclick="analyzeCode()" id="analyzeBtn">Analyze</button>
                <button class="toolbar-btn" onclick="toggleLens()" id="lensBtn">Lens</button>
                <button class="toolbar-btn" onclick="toggleTrace()" id="traceBtn">Trace</button>
                <button class="toolbar-btn" onclick="startTour()" id="tourBtn">Tour</button>
                <button class="toolbar-btn" onclick="showDiff()" id="diffBtn">Diff</button>
                <button class="toolbar-btn" onclick="showExportPanel()" id="exportBtn">Export</button>
            </div>

            <div class="three-pane-layout" id="mainLayout">
                <!-- Left Pane: Code/Inputs -->
                <div class="pane left-pane" id="leftPane">
                    <div class="pane-header">
                        <div class="pane-title">
                            <span class="pane-icon">📝</span>
                            Code Editor
                        </div>
                        <div class="pane-controls">
                            <button class="btn-icon" onclick="togglePane('left')" title="Toggle Pane">⊟</button>
                        </div>
                    </div>
                    <div class="pane-content">
                        <div class="code-editor">
                            <div class="editor-header">
                                <div class="editor-tabs">
                                    <div class="tab active" data-tab="code">Code</div>
                                    <div class="tab" data-tab="files">Files</div>
                                    <div class="tab" data-tab="settings">Settings</div>
                                </div>
                                <div class="editor-actions">
                                    <button class="btn-small" onclick="loadSampleCode('simple')" title="Load Simple Example">Simple</button>
                                    <button class="btn-small" onclick="loadSampleCode('async')" title="Load Async Example">Async</button>
                                    <button class="btn-small" onclick="loadSampleCode('complex')" title="Load Complex Example">Complex</button>
                                    <button class="btn-small" onclick="clearCode()" title="Clear Code">Clear</button>
                                </div>
                            </div>
                            <div class="tab-content active" id="codeTab">
                                <div class="code-container">
                                    <textarea class="code-input" id="codeInput" placeholder="Paste Python code here, then press ⌘⏎ to analyze" spellcheck="false">def compute(x, y):
    z = add(x, y)
    maybe_log(z)
    return z

def add(a, b):
    return a + b

def maybe_log(value):
    if value > 10:
        print(f'Large value: {value}')</textarea>
                                    <div class="ghost-text" id="ghostText">Paste Python, press Analyze (⌘⏎)</div>
                                </div>
                            </div>
                            <div class="tab-content" id="filesTab">
                                <div class="file-browser">
                                    <div class="file-item active" data-file="main.py">
                                        <span class="file-icon">🐍</span>
                                        <span class="file-name">main.py</span>
                                        <span class="file-status">modified</span>
                                    </div>
                                    <div class="file-item" data-file="utils.py">
                                        <span class="file-icon">🔧</span>
                                        <span class="file-name">utils.py</span>
                                        <span class="file-status">untracked</span>
                                    </div>
                                </div>
                            </div>
                            <div class="tab-content" id="settingsTab">
                                <div class="settings-panel">
                                    <div class="setting-group">
                                        <label>Analysis Depth</label>
                                        <select id="analysisDepth">
                                            <option value="shallow">Shallow (Fast)</option>
                                            <option value="medium" selected>Medium (Balanced)</option>
                                            <option value="deep">Deep (Thorough)</option>
                                        </select>
                                    </div>
                                    <div class="setting-group">
                                        <label>Include Dependencies</label>
                                        <input type="checkbox" id="includeDeps" checked>
                                    </div>
                                    <div class="setting-group">
                                        <label>Side Effect Detection</label>
                                        <input type="checkbox" id="detectSideEffects" checked>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="progress-milestones" id="progressMilestones">
                            <div class="milestone">
                                <div class="milestone-dot" id="milestone1">1</div>
                                <div class="milestone-label">Parse</div>
                            </div>
                            <div class="milestone">
                                <div class="milestone-dot" id="milestone2">2</div>
                                <div class="milestone-label">Build Graph</div>
                            </div>
                            <div class="milestone">
                                <div class="milestone-dot" id="milestone3">3</div>
                                <div class="milestone-label">Compute Metrics</div>
                            </div>
                            <div class="milestone">
                                <div class="milestone-dot" id="milestone4">4</div>
                                <div class="milestone-label">Render</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Center Pane: Map/Trace Canvas -->
                <div class="pane center-pane" id="centerPane">
                    <div class="pane-header">
                        <div class="pane-title">
                            <span class="pane-icon">🗺️</span>
                            Code Map
                        </div>
                        <div class="pane-controls">
                            <button class="toolbar-btn" onclick="toggleMinimap()" id="minimapBtn" title="Toggle Minimap">Minimap</button>
                            <button class="toolbar-btn" onclick="zoomToFit()" id="zoomBtn" title="Fit to Screen">Fit</button>
                            <button class="btn-icon" onclick="togglePane('center')" title="Toggle Pane">⊟</button>
                        </div>
                    </div>
                    <div class="pane-content">
                        <div id="cy" class="graph-canvas"></div>
                        <div class="minimap" id="minimap" style="display: none;">
                            <div id="cy-minimap"></div>
                        </div>
                        <div id="hoverCard" class="hover-card" style="display: none;"></div>
                        <div class="graph-overlay" id="graphOverlay">
                            <div class="overlay-controls">
                                <button class="overlay-btn" onclick="toggleTraceOverlay()" id="traceOverlayBtn">Trace</button>
                                <button class="overlay-btn" onclick="toggleHeatmap()" id="heatmapBtn">Heatmap</button>
                                <button class="overlay-btn" onclick="toggleClusters()" id="clustersBtn">Clusters</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Right Pane: Insights/Tour -->
                <div class="pane right-pane" id="rightPane">
                    <div class="pane-header">
                        <div class="pane-title">
                            <span class="pane-icon">💡</span>
                            Insights
                        </div>
                        <div class="pane-controls">
                            <button class="btn-icon" onclick="togglePane('right')" title="Toggle Pane">⊟</button>
                        </div>
                    </div>
                    <div class="pane-content">
                        <div class="insights-tabs">
                            <div class="insight-tab active" data-tab="analysis">Analysis</div>
                            <div class="insight-tab" data-tab="tour">Tour</div>
                            <div class="insight-tab" data-tab="metrics">Metrics</div>
                            <div class="insight-tab" data-tab="side-effects">Side Effects</div>
                        </div>
                        <div class="insight-content">
                            <div class="insight-panel active" id="analysisPanel">
                                <div class="insight-section">
                                    <h4>Function Analysis</h4>
                                    <div id="functionAnalysis" class="analysis-results"></div>
                                </div>
                                <div class="insight-section">
                                    <h4>Complexity Overview</h4>
                                    <div id="complexityOverview" class="complexity-chart"></div>
                                </div>
                            </div>
                            <div class="insight-panel" id="tourPanel">
                                <div class="tour-controls">
                                    <button class="btn btn-primary btn-sm" onclick="startTour()">Start Tour</button>
                                    <button class="btn btn-outline btn-sm" onclick="generateTour()">Generate Tour</button>
                                </div>
                                <div id="tourContent" class="tour-content"></div>
                            </div>
                            <div class="insight-panel" id="metricsPanel">
                                <div class="metrics-grid">
                                    <div class="metric-card">
                                        <div class="metric-value" id="totalFunctions">0</div>
                                        <div class="metric-label">Functions</div>
                                    </div>
                                    <div class="metric-card">
                                        <div class="metric-value" id="avgComplexity">0</div>
                                        <div class="metric-label">Avg Complexity</div>
                                    </div>
                                    <div class="metric-card">
                                        <div class="metric-value" id="sideEffectCount">0</div>
                                        <div class="metric-label">Side Effects</div>
                                    </div>
                                    <div class="metric-card">
                                        <div class="metric-value" id="hotPathCount">0</div>
                                        <div class="metric-label">Hot Paths</div>
                                    </div>
                                </div>
                            </div>
                            <div class="insight-panel" id="sideEffectsPanel">
                                <div class="side-effects-list" id="sideEffectsList"></div>
                            </div>
                        </div>
                    </div>
                </div>
                            </div>
                        </div>
                        
                        <div class="insight-card" id="lensDisplay">
                            <h4>Current Lens</h4>
                            <p>No filters applied</p>
                        </div>
                        
                        <div class="trace-controls" id="traceControls" style="display: none;">
                            <h4>Trace Overlay Controls</h4>
                            <div class="trace-toggle">
                                <input type="checkbox" id="staticRuntimeToggle" onchange="toggleStaticRuntime()">
                                <label for="staticRuntimeToggle">Show Static Analysis Only</label>
                            </div>
                            <button class="btn btn-sm" onclick="showTraceBreadcrumb()">Show Hot Path Breadcrumb</button>
                        </div>
                        
                        <div id="conflictNotification" style="display: none;"></div>
                        
                        <div id="traceBreadcrumb" style="display: none;"></div>
                            
                            <div class="insight-card">
                                <h4>Metrics</h4>
                                <div id="metricsDisplay">
                                    <p>No analysis yet. Paste code and analyze to see metrics.</p>
                                </div>
                            </div>
                            
                            <div class="tour-reader">
                                <div class="pane-header">Understanding Tour</div>
                                <div class="tour-timeline" id="tourTimeline">
                                    <div class="tour-step">
                                        <h4>Welcome!</h4>
                                        <p>Analyze your code to see an interactive understanding tour.</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="loading" id="loading">
                <div class="spinner"></div>
                <p>Analyzing your code...</p>
                <div class="progress-stages">
                    <div class="stage" id="stage-parse">Parse</div>
                    <div class="stage" id="stage-graph">Build Graph</div>
                    <div class="stage" id="stage-metrics">Compute Metrics</div>
                    <div class="stage" id="stage-render">Render</div>
                </div>
            </div>
            
            <div id="results"></div>
        </div>

        <div class="demo-section">
            <h2>Analysis Capabilities</h2>
            <div class="features-grid">
                <div class="feature-card">
                    <h3>Static Code Analysis</h3>
                    <p>Comprehensive analysis of function relationships, call graphs, and dependencies. Identifies structural patterns and architectural insights across codebases.</p>
                </div>
                
                <div class="feature-card">
                    <h3>Complexity Metrics</h3>
                    <p>Cyclomatic complexity calculation, side effect detection, and maintainability scoring. Provides quantitative measures of code quality and technical debt.</p>
                </div>
                
                <div class="feature-card">
                    <h3>Execution Flow Analysis</h3>
                    <p>Runtime tracing capabilities that capture actual execution paths and data flow. Complements static analysis with dynamic behavior insights.</p>
                </div>
                
                <div class="feature-card">
                    <h3>Contract Verification</h3>
                    <p>Formal verification of API contracts using Lean theorem prover. Ensures correctness of interface specifications and behavioral guarantees.</p>
                </div>
                
                <div class="feature-card">
                    <h3>Context Debt Measurement</h3>
                    <p>Time To Understanding (TTU) metrics and documentation gap analysis. Quantifies the cognitive load required to comprehend code sections.</p>
                </div>
                
                <div class="feature-card">
                    <h3>IDE Integration</h3>
                    <p>VS Code extension providing real-time analysis, gutter decorations, and interactive code exploration tools for enhanced developer productivity.</p>
                </div>
            </div>
        </div>

        <div class="demo-section">
            <h2>Analysis Impact</h2>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                <div>
                    <h3 style="color: #dc3545; font-weight: 600;">Traditional Development</h3>
                    <ul style="color: #6c757d; line-height: 1.8;">
                        <li>Manual code exploration across multiple files</li>
                        <li>Limited visibility into execution patterns</li>
                        <li>Unclear identification of critical code paths</li>
                        <li>High risk of introducing breaking changes</li>
                        <li>Static documentation that becomes outdated</li>
                        <li>No quantitative measures of code complexity</li>
                    </ul>
                </div>
                <div>
                    <h3 style="color: #17a2b8; font-weight: 600;">With Understand-First</h3>
                    <ul style="color: #6c757d; line-height: 1.8;">
                        <li>Automated code structure analysis and visualization</li>
                        <li>Clear identification of execution flows and dependencies</li>
                        <li>Quantified complexity metrics and hot path detection</li>
                        <li>Context-aware change impact analysis</li>
                        <li>Dynamic documentation generation and maintenance</li>
                        <li>Measurable context debt and understanding gaps</li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="demo-section">
            <h2>Implementation</h2>
            <p>Deploy Understand-First in your development environment to enable advanced code analysis capabilities:</p>
            
            <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin: 20px 0;">
                <h4>Installation and Setup</h4>
                <pre style="background: #2c3e50; color: #ecf0f1; padding: 15px; border-radius: 6px; overflow-x: auto; margin: 10px 0;"><code># Install Understand-First
pip install understand-first

# Initialize in your project
u init --wizard

# Scan your codebase
u scan . -o maps/repo.json

# Generate analysis reports
u demo</code></pre>
            </div>
            
            <div style="text-align: center; margin-top: 30px;">
                <a href="https://github.com/SentinelOps-CI/understand-first" style="background: #495057; color: white; padding: 15px 30px; text-decoration: none; border-radius: 8px; font-weight: 600; display: inline-block; margin: 0 10px;">
                    View Documentation
                </a>
                <a href="https://github.com/SentinelOps-CI/understand-first" style="background: #6c757d; color: white; padding: 15px 30px; text-decoration: none; border-radius: 8px; font-weight: 600; display: inline-block; margin: 0 10px;">
                    GitHub Repository
                </a>
            </div>
        </div>
        </div>
    </main>

    <footer class="footer" role="contentinfo">
        <div class="footer-content">
            <div class="footer-section">
                <h3>Understand-First</h3>
                <p>Generate understanding, not just code.</p>
            </div>
            <div class="footer-section">
                <h4>Features</h4>
                <ul>
                    <li><a href="#code-analysis">Code Analysis</a></li>
                    <li><a href="#visualization">Visualization</a></li>
                    <li><a href="#tours">Interactive Tours</a></li>
                    <li><a href="#metrics">Metrics</a></li>
                </ul>
            </div>
            <div class="footer-section">
                <h4>Resources</h4>
                <ul>
                    <li><a href="https://github.com/SentinelOps-CI/understand-first" target="_blank" rel="noopener">GitHub</a></li>
                    <li><a href="#documentation">Documentation</a></li>
                    <li><a href="#examples">Examples</a></li>
                </ul>
            </div>
            <div class="footer-section">
                <h4>Accessibility</h4>
                <p>This application follows WCAG 2.1 AA guidelines and supports keyboard navigation and screen readers.</p>
            </div>
        </div>
        <div class="footer-bottom">
            <p>&copy; 2024 Understand-First. All rights reserved.</p>
        </div>
    </footer>

    <script>
        // Global state
        let currentAnalysis = null;
        let cy = null;
        let cyMinimap = null;
        let currentFilters = new Set();
        let traceOverlay = false;
        let tourSteps = [];
        let currentTourStep = 0;
        let isFirstVisit = true;
        
        // Performance optimization instances
        let performanceOptimizer = null;
        let memoryManager = null;
        let virtualScrollManager = null;
        let progressStages = ['parse', 'graph', 'metrics', 'render'];

        // Enhanced Onboarding Wizard Functions
        let currentWizardStep = 1;
        let selectedTourOption = null;

        function showOnboardingWizard() {
            if (isFirstVisit && !localStorage.getItem('uf-onboarding-completed')) {
                document.getElementById('onboardingWizard').style.display = 'flex';
                currentWizardStep = 1;
                updateWizardProgress();
                setupWizardInteractions();
            }
        }

        function hideOnboardingWizard() {
            document.getElementById('onboardingWizard').style.display = 'none';
            localStorage.setItem('uf-onboarding-completed', 'true');
            isFirstVisit = false;
        }

        function nextWizardStep() {
            if (currentWizardStep < 4) {
                document.getElementById(`wizardStep${currentWizardStep}`).classList.remove('active');
                currentWizardStep++;
                document.getElementById(`wizardStep${currentWizardStep}`).classList.add('active');
                updateWizardProgress();
            }
        }

        function prevWizardStep() {
            if (currentWizardStep > 1) {
                document.getElementById(`wizardStep${currentWizardStep}`).classList.remove('active');
                currentWizardStep--;
                document.getElementById(`wizardStep${currentWizardStep}`).classList.add('active');
                updateWizardProgress();
            }
        }

        function updateWizardProgress() {
            const progress = (currentWizardStep / 4) * 100;
            document.getElementById('wizardProgress').style.width = `${progress}%`;
            document.getElementById('currentStep').textContent = currentWizardStep;
            document.getElementById('progressPercentage').textContent = `${Math.round(progress)}%`;
        }

        function setupWizardInteractions() {
            // Add keyboard navigation
            document.addEventListener('keydown', function(e) {
                if (document.getElementById('onboardingWizard').style.display === 'flex') {
                    if (e.key === 'ArrowRight' && currentWizardStep < 4) {
                        nextWizardStep();
                    } else if (e.key === 'ArrowLeft' && currentWizardStep > 1) {
                        prevWizardStep();
                    } else if (e.key === 'Escape') {
                        hideOnboardingWizard();
                    }
                }
            });
        }

        function loadSampleFromWizard(sampleType) {
            loadSampleCode(sampleType);
            nextWizardStep();
        }

        function analyzeCodeFromWizard() {
            const code = document.getElementById('onboardingCode').value;
            document.getElementById('codeInput').value = code;
            
            // Show progress
            document.getElementById('analysisProgress').style.display = 'flex';
            
            // Simulate analysis
            setTimeout(() => {
                analyzeCode();
                document.getElementById('analysisProgress').style.display = 'none';
                document.getElementById('step2Next').disabled = false;
                
                // Auto-advance to next step
                setTimeout(() => {
                    nextWizardStep();
                }, 1000);
            }, 2000);
        }

        function demonstrateInteraction() {
            // Highlight the graph area and show interaction hints
            const graphArea = document.querySelector('.graph-pane');
            if (graphArea) {
                graphArea.style.animation = 'pulse 2s ease-in-out 3';
                
                // Show tooltip with interaction hints
                setTimeout(() => {
                    showTooltip('Try clicking on nodes, dragging to pan, or scrolling to zoom!', graphArea);
                }, 500);
            }
        }

        function selectTourOption(option) {
            selectedTourOption = option;
            
            // Update UI
            document.querySelectorAll('.option-card').forEach(card => {
                card.classList.remove('selected');
            });
            event.target.closest('.option-card').classList.add('selected');
            
            // Enable generate button
            document.getElementById('generateTourBtn').disabled = false;
        }

        function generateTourFromWizard() {
            if (!selectedTourOption) return;
            
            // Show progress
            document.getElementById('tourProgress').style.display = 'flex';
            
            // Generate tour based on selected option
            setTimeout(() => {
                generateTour(selectedTourOption);
                document.getElementById('tourProgress').style.display = 'none';
                
                // Show success message
                showSuccess('Tour generated successfully! You can now explore your code step by step.');
            }, 1500);
        }

        function finishWizard() {
            hideOnboardingWizard();
            showSuccess('🎉 Welcome to Understand First! You\'re all set to explore your code.');
            
            // Track onboarding completion
            trackMetric('onboarding_completed', {
                tour_option: selectedTourOption,
                samples_tried: document.querySelectorAll('.sample-card').length
            });
        }

        function showTooltip(message, element) {
            const tooltip = document.createElement('div');
            tooltip.className = 'interaction-tooltip';
            tooltip.textContent = message;
            tooltip.style.cssText = `
                position: absolute;
                background: #007bff;
                color: white;
                padding: 8px 12px;
                border-radius: 6px;
                font-size: 12px;
                z-index: 1000;
                pointer-events: none;
                animation: fadeInOut 3s ease-in-out;
            `;
            
            document.body.appendChild(tooltip);
            
            // Position tooltip near element
            const rect = element.getBoundingClientRect();
            tooltip.style.left = `${rect.left + rect.width / 2}px`;
            tooltip.style.top = `${rect.top - 40}px`;
            tooltip.style.transform = 'translateX(-50%)';
            
            // Remove tooltip after animation
            setTimeout(() => {
                document.body.removeChild(tooltip);
            }, 3000);
        }

        function generateTour(type) {
            // Generate tour based on type
            let tourSteps = [];
            
            switch(type) {
                case 'beginner':
                    tourSteps = [
                        {
                            title: "Understanding the Code Structure",
                            description: "Let's start by exploring the main functions and classes in your code.",
                            focusNodes: [],
                            estimatedTime: 2,
                            completed: false,
                            bookmarked: false
                        },
                        {
                            title: "Following Function Calls",
                            description: "Trace how functions call each other and understand the execution flow.",
                            focusNodes: [],
                            estimatedTime: 3,
                            completed: false,
                            bookmarked: false
                        },
                        {
                            title: "Identifying Key Components",
                            description: "Find the most important parts of your code that you should understand first.",
                            focusNodes: [],
                            estimatedTime: 2,
                            completed: false,
                            bookmarked: false
                        }
                    ];
                    break;
                case 'advanced':
                    tourSteps = [
                        {
                            title: "Complexity Analysis",
                            description: "Analyze the most complex functions and identify refactoring opportunities.",
                            focusNodes: [],
                            estimatedTime: 4,
                            completed: false,
                            bookmarked: false
                        },
                        {
                            title: "Dependency Mapping",
                            description: "Map out all dependencies and identify potential coupling issues.",
                            focusNodes: [],
                            estimatedTime: 3,
                            completed: false,
                            bookmarked: false
                        },
                        {
                            title: "Performance Hotspots",
                            description: "Identify functions that might be performance bottlenecks.",
                            focusNodes: [],
                            estimatedTime: 3,
                            completed: false,
                            bookmarked: false
                        }
                    ];
                    break;
                case 'custom':
                    tourSteps = [
                        {
                            title: "Custom Analysis",
                            description: "Focus on specific functions you're interested in understanding.",
                            focusNodes: [],
                            estimatedTime: 2,
                            completed: false,
                            bookmarked: false
                        }
                    ];
                    break;
            }
            
            // Update global tour steps
            window.tourSteps = tourSteps;
            window.currentTourStep = 0;
            
            // Render the tour
            renderTour();
        }

        function updateProgressStage(stageIndex) {
            progressStages.forEach((stage, index) => {
                const stageElement = document.getElementById(`stage-${stage}`);
                if (stageElement) {
                    stageElement.classList.remove('active', 'completed');
                    if (index < stageIndex) {
                        stageElement.classList.add('completed');
                    } else if (index === stageIndex) {
                        stageElement.classList.add('active');
                    }
                }
            });
        }

        // Enhanced sample code snippets
        const sampleCode = {
            simple: `def compute(x, y):
    z = add(x, y)
    maybe_log(z)
    return z

def add(a, b):
    return a + b

def maybe_log(value):
    if value > 10:
        print(f'Large value: {value}')`,

            async: `from fastapi import FastAPI, HTTPException, Depends
from pydantic import BaseModel
import asyncio
import aiohttp
from typing import List, Dict, Optional
import logging

app = FastAPI(title="User Management API")

class User(BaseModel):
    id: int
    name: str
    email: str
    is_active: bool = True

class UserService:
    def __init__(self, api_url: str):
        self.api_url = api_url
        self.session = None
        self.logger = logging.getLogger(__name__)
    
    async def get_session(self):
        if not self.session:
            self.session = aiohttp.ClientSession()
        return self.session
    
    async def fetch_user(self, user_id: int) -> Optional[User]:
        session = await self.get_session()
        try:
            async with session.get(f"{self.api_url}/users/{user_id}") as response:
                if response.status == 200:
                    data = await response.json()
                    return User(**data)
                return None
        except Exception as e:
            self.logger.error(f"Error fetching user {user_id}: {e}")
            return None
    
    async def fetch_multiple_users(self, user_ids: List[int]) -> List[User]:
        tasks = [self.fetch_user(uid) for uid in user_ids]
        results = await asyncio.gather(*tasks, return_exceptions=True)
        return [r for r in results if isinstance(r, User)]

user_service = UserService("https://api.example.com")

@app.get("/users/{user_id}")
async def get_user(user_id: int):
    user = await user_service.fetch_user(user_id)
    if not user:
        raise HTTPException(status_code=404, detail="User not found")
    return user

@app.post("/users/batch")
async def get_users_batch(user_ids: List[int]):
    users = await user_service.fetch_multiple_users(user_ids)
    return {"users": users, "count": len(users)}`,

            complex: `import asyncio
import aiohttp
import hashlib
import secrets
import logging
from datetime import datetime
from typing import Dict, List, Optional, Union
from dataclasses import dataclass
from abc import ABC, abstractmethod

logger = logging.getLogger(__name__)

@dataclass
class UserData:
    email: str
    password: str
    first_name: str
    last_name: str
    role: str = "user"

@dataclass
class UserResponse:
    id: str
    email: str
    first_name: str
    last_name: str
    role: str
    created_at: datetime
    is_active: bool

class DatabaseInterface(ABC):
    @abstractmethod
    async def acquire_connection(self):
        pass
    
    @abstractmethod
    async def execute_query(self, query: str, params: tuple) -> List[Dict]:
        pass

class PostgreSQLDatabase(DatabaseInterface):
    def __init__(self, connection_string: str):
        self.connection_string = connection_string
        self._pool = None
    
    async def acquire_connection(self):
        if not self._pool:
            self._pool = await asyncpg.create_pool(self.connection_string)
        return self._pool.acquire()
    
    async def execute_query(self, query: str, params: tuple) -> List[Dict]:
        async with self.acquire_connection() as conn:
            return await conn.fetch(query, *params)

class UserService:
    def __init__(self, db: DatabaseInterface, auth_service_url: str, cache_service_url: str):
        self.db = db
        self.auth_service_url = auth_service_url
        self.cache_service_url = cache_service_url
        self._session = None
        self._rate_limiter = {}
    
    async def create_user(self, user_data: UserData) -> UserResponse:
        # Rate limiting check
        if self._is_rate_limited(user_data.email):
            raise ValueError("Too many requests for this email")
        
        async with self.db.acquire_connection() as conn:
            async with conn.transaction():
                # Check if user exists
                existing_user = await conn.fetchrow(
                    "SELECT id FROM users WHERE email = $1", user_data.email
                )
                if existing_user:
                    raise ValueError("User already exists")
                
                # Hash password with salt
                password_hash = self._hash_password(user_data.password)
                user_id = secrets.token_urlsafe(16)
                
                # Insert user
                await conn.execute(
                    "INSERT INTO users (id, email, password_hash, first_name, last_name, role, created_at, is_active) VALUES ($1, $2, $3, $4, $5, $6, $7, $8)",
                    user_id, user_data.email, password_hash, user_data.first_name, 
                    user_data.last_name, user_data.role, datetime.utcnow(), True
                )
                
                # Notify services asynchronously
                await asyncio.gather(
                    self._notify_auth_service("user_created", {"user_id": user_id}),
                    self._update_cache(user_id, user_data),
                    return_exceptions=True
                )
                
                return UserResponse(
                    id=user_id, email=user_data.email, first_name=user_data.first_name,
                    last_name=user_data.last_name, role=user_data.role,
                    created_at=datetime.utcnow(), is_active=True
                )
    
    def _hash_password(self, password: str) -> str:
        salt = secrets.token_hex(16)
        password_hash = hashlib.pbkdf2_hmac("sha256", password.encode("utf-8"), salt.encode("utf-8"), 100000)
        return f"{salt}:{password_hash.hex()}"

    def _is_rate_limited(self, email: str) -> bool:
        now = datetime.utcnow()
        if email in self._rate_limiter:
            if (now - self._rate_limiter[email]).seconds < 60:
                return True
        self._rate_limiter[email] = now
        return False
    
    async def _notify_auth_service(self, event: str, data: Dict) -> None:
        try:
            session = await self._get_session()
                payload = {"event": event, "data": data, "timestamp": datetime.utcnow().isoformat()}
                async with session.post(f"{self.auth_service_url}/events", json=payload, timeout=aiohttp.ClientTimeout(total=5)) as response:
                    if response.status != 200:
                        logger.warning(f"Auth service notification failed: {response.status}")
        except Exception as e:
            logger.error(f"Failed to notify auth service: {str(e)}")
    
    async def _update_cache(self, user_id: str, user_data: UserData) -> None:
        try:
            session = await self._get_session()
            cache_data = {"user_id": user_id, "email": user_data.email, "role": user_data.role}
            async with session.post(f"{self.cache_service_url}/cache", json=cache_data) as response:
                if response.status != 200:
                    logger.warning(f"Cache update failed: {response.status}")
        except Exception as e:
            logger.error(f"Failed to update cache: {str(e)}")
    
    async def _get_session(self):
        if not self._session:
            self._session = aiohttp.ClientSession()
        return self._session`
        };

        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            initializeCytoscape();
            setupKeyboardShortcuts();
            setupAccessibility();
            setupOnboardingWizard();
            setupEnhancedLayout();
            setupPerformanceDashboard();
            showOnboardingWizard();
            loadFiltersFromURL();
            updatePresetsDisplay();
        });

        // Cleanup on page unload
        window.addEventListener('beforeunload', function() {
            cleanupPerformanceModules();
        });

        function setupPerformanceDashboard() {
            // Create performance dashboard
            const dashboard = document.createElement('div');
            dashboard.id = 'performance-dashboard';
            dashboard.className = 'performance-dashboard';
            dashboard.innerHTML = `
                <div class="dashboard-header">
                    <h3>Performance Guardrails</h3>
                    <button id="toggleDashboard" class="toggle-btn">−</button>
                </div>
                <div class="dashboard-content">
                    <div class="guardrail-item">
                        <span class="guardrail-label">UI Latency (p95):</span>
                        <span id="ui-latency" class="guardrail-value">-- ms</span>
                        <span class="guardrail-target">Target: <100ms</span>
                    </div>
                    <div class="guardrail-item">
                        <span class="guardrail-label">Map Render (5k nodes):</span>
                        <span id="map-render" class="guardrail-value">-- ms</span>
                        <span class="guardrail-target">Target: <1500ms</span>
                    </div>
                    <div class="guardrail-item">
                        <span class="guardrail-label">Frame Rate:</span>
                        <span id="frame-rate" class="guardrail-value">-- fps</span>
                        <span class="guardrail-target">Target: 60fps</span>
                    </div>
                    <div class="guardrail-item">
                        <span class="guardrail-label">TTU:</span>
                        <span id="ttu-metric" class="guardrail-value">-- s</span>
                        <span class="guardrail-target">Target: ≤600s</span>
                    </div>
                    <div class="guardrail-item">
                        <span class="guardrail-label">TTFSC:</span>
                        <span id="ttfsc-metric" class="guardrail-value">-- s</span>
                        <span class="guardrail-target">Target: ≤86400s</span>
                    </div>
                </div>
            `;
            
            // Add styles
            const style = document.createElement('style');
            style.textContent = `
                .performance-dashboard {
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    width: 300px;
                    background: white;
                    border: 1px solid #ddd;
                    border-radius: 8px;
                    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
                    z-index: 1000;
                    font-size: 12px;
                }
                
                .dashboard-header {
                    display: flex;
                    justify-content: space-between;
                    align-items: center;
                    padding: 10px;
                    background: #f5f5f5;
                    border-bottom: 1px solid #ddd;
                }
                
                .dashboard-content {
                    padding: 10px;
                }
                
                .guardrail-item {
                    display: flex;
                    justify-content: space-between;
                    align-items: center;
                    margin: 5px 0;
                    padding: 5px;
                    border-radius: 4px;
                }
                
                .guardrail-label {
                    font-weight: bold;
                    flex: 1;
                }
                
                .guardrail-value {
                    font-family: monospace;
                    font-weight: bold;
                    margin: 0 10px;
                }
                
                .guardrail-target {
                    font-size: 10px;
                    color: #666;
                }
                
                .guardrail-item.warning {
                    background: #fff3cd;
                    border-left: 3px solid #ffc107;
                }
                
                .guardrail-item.critical {
                    background: #f8d7da;
                    border-left: 3px solid #dc3545;
                }
                
                .guardrail-item.success {
                    background: #d4edda;
                    border-left: 3px solid #28a745;
                }
                
                .toggle-btn {
                    background: none;
                    border: none;
                    font-size: 16px;
                    cursor: pointer;
                }
            `;
            document.head.appendChild(style);
            
            // Add to page
            document.body.appendChild(dashboard);
            
            // Setup toggle
            document.getElementById('toggleDashboard').addEventListener('click', function() {
                const content = dashboard.querySelector('.dashboard-content');
                const btn = this;
                
                if (content.style.display === 'none') {
                    content.style.display = 'block';
                    btn.textContent = '−';
                } else {
                    content.style.display = 'none';
                    btn.textContent = '+';
                }
            });
            
            // Listen for performance alerts
            document.addEventListener('performanceAlert', function(event) {
                updatePerformanceDashboard(event.detail);
            });
            
            // Listen for TTU/TTFSC updates
            document.addEventListener('ttu_completed', function(event) {
                updateTTUMetric(event.detail.duration);
            });
            
            document.addEventListener('ttfsc_completed', function(event) {
                updateTTFSCMetric(event.detail.duration);
            });
        }

        function updatePerformanceDashboard(alert) {
            const { type, value, context } = alert;
            
            switch(type) {
                case 'ui_latency_critical':
                    updateGuardrailValue('ui-latency', value, 'critical');
                    break;
                case 'map_render_critical':
                    updateGuardrailValue('map-render', value, 'critical');
                    break;
                case 'frame_rate_low':
                    updateGuardrailValue('frame-rate', value, 'critical');
                    break;
            }
        }

        function updateGuardrailValue(elementId, value, status) {
            const element = document.getElementById(elementId);
            const item = element.closest('.guardrail-item');
            
            if (element) {
                element.textContent = Math.round(value);
                
                // Update status
                item.className = `guardrail-item ${status}`;
            }
        }

        function updateTTUMetric(ttu) {
            updateGuardrailValue('ttu-metric', ttu, ttu <= 600 ? 'success' : 'critical');
        }

        function updateTTFSCMetric(ttfsc) {
            updateGuardrailValue('ttfsc-metric', ttfsc, ttfsc <= 86400 ? 'success' : 'critical');
        }

        // Enhanced Layout Functions
        function setupEnhancedLayout() {
            // Setup editor tabs
            setupEditorTabs();
            
            // Setup insight tabs
            setupInsightTabs();
            
            // Setup file browser
            setupFileBrowser();
            
            // Setup settings
            setupSettings();
            
            // Initialize metrics
            initializeMetrics();
        }

        function setupEditorTabs() {
            const tabs = document.querySelectorAll('.editor-tabs .tab');
            const tabContents = document.querySelectorAll('.tab-content');
            
            tabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    const targetTab = tab.dataset.tab;
                    
                    // Remove active class from all tabs and contents
                    tabs.forEach(t => t.classList.remove('active'));
                    tabContents.forEach(tc => tc.classList.remove('active'));
                    
                    // Add active class to clicked tab and corresponding content
                    tab.classList.add('active');
                    document.getElementById(targetTab + 'Tab').classList.add('active');
                });
            });
        }

        function setupInsightTabs() {
            const tabs = document.querySelectorAll('.insight-tab');
            const panels = document.querySelectorAll('.insight-panel');
            
            tabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    const targetTab = tab.dataset.tab;
                    
                    // Remove active class from all tabs and panels
                    tabs.forEach(t => t.classList.remove('active'));
                    panels.forEach(p => p.classList.remove('active'));
                    
                    // Add active class to clicked tab and corresponding panel
                    tab.classList.add('active');
                    document.getElementById(targetTab + 'Panel').classList.add('active');
                });
            });
        }

        function setupFileBrowser() {
            const fileItems = document.querySelectorAll('.file-item');
            
            fileItems.forEach(item => {
                item.addEventListener('click', () => {
                    // Remove active class from all items
                    fileItems.forEach(fi => fi.classList.remove('active'));
                    
                    // Add active class to clicked item
                    item.classList.add('active');
                    
                    // Load file content (mock implementation)
                    const fileName = item.dataset.file;
                    loadFileContent(fileName);
                });
            });
        }

        function loadFileContent(fileName) {
            // Mock file loading - in production, this would load actual file content
            const codeInput = document.getElementById('codeInput');
            const sampleCode = {
                'main.py': `def main():
    result = process_data()
    print(f"Result: {result}")

def process_data():
    data = fetch_data()
    return transform_data(data)

def fetch_data():
    return [1, 2, 3, 4, 5]

def transform_data(data):
    return [x * 2 for x in data]`,
                'utils.py': `import logging

def setup_logging():
    logging.basicConfig(level=logging.INFO)
    return logging.getLogger(__name__)

def validate_input(data):
    if not isinstance(data, list):
        raise ValueError("Data must be a list")
    return True

def format_output(data):
    return f"Processed {len(data)} items"`
            };
            
            if (sampleCode[fileName]) {
                codeInput.value = sampleCode[fileName];
                updateGhostText();
            }
        }

        function setupSettings() {
            const analysisDepth = document.getElementById('analysisDepth');
            const includeDeps = document.getElementById('includeDeps');
            const detectSideEffects = document.getElementById('detectSideEffects');
            
            if (analysisDepth) {
                analysisDepth.addEventListener('change', (e) => {
                    console.log('Analysis depth changed to:', e.target.value);
                    // In production, this would update analysis settings
                });
            }
            
            if (includeDeps) {
                includeDeps.addEventListener('change', (e) => {
                    console.log('Include dependencies:', e.target.checked);
                    // In production, this would update analysis settings
                });
            }
            
            if (detectSideEffects) {
                detectSideEffects.addEventListener('change', (e) => {
                    console.log('Detect side effects:', e.target.checked);
                    // In production, this would update analysis settings
                });
            }
        }

        function initializeMetrics() {
            // Initialize metric values
            updateMetrics({
                totalFunctions: 0,
                avgComplexity: 0,
                sideEffectCount: 0,
                hotPathCount: 0
            });
        }

        function updateMetrics(metrics) {
            const totalFunctionsEl = document.getElementById('totalFunctions');
            const avgComplexityEl = document.getElementById('avgComplexity');
            const sideEffectCountEl = document.getElementById('sideEffectCount');
            const hotPathCountEl = document.getElementById('hotPathCount');
            
            if (totalFunctionsEl) totalFunctionsEl.textContent = metrics.totalFunctions || 0;
            if (avgComplexityEl) avgComplexityEl.textContent = metrics.avgComplexity || 0;
            if (sideEffectCountEl) sideEffectCountEl.textContent = metrics.sideEffectCount || 0;
            if (hotPathCountEl) hotPathCountEl.textContent = metrics.hotPathCount || 0;
        }

        function togglePane(paneName) {
            const pane = document.getElementById(paneName + 'Pane');
            if (pane) {
                pane.classList.toggle('collapsed');
                
                // Update grid layout when panes are collapsed
                const layout = document.getElementById('mainLayout');
                if (layout) {
                    const collapsedPanes = document.querySelectorAll('.pane.collapsed');
                    if (collapsedPanes.length > 0) {
                        layout.style.gridTemplateColumns = '60px 2fr 1fr';
                    } else {
                        layout.style.gridTemplateColumns = '1fr 2fr 1fr';
                    }
                }
            }
        }

        function toggleHeatmap() {
            const btn = document.getElementById('heatmapBtn');
            if (btn) {
                btn.classList.toggle('active');
                // In production, this would toggle heatmap overlay
                console.log('Heatmap toggled');
            }
        }

        function toggleClusters() {
            const btn = document.getElementById('clustersBtn');
            if (btn) {
                btn.classList.toggle('active');
                // In production, this would toggle cluster grouping
                console.log('Clusters toggled');
            }
        }

        function generateTour() {
            // Generate a new tour based on current analysis
            console.log('Generating tour...');
            // In production, this would call the backend to generate a tour
            showNotification('Tour generation started...', 'info');
        }

        // Onboarding Wizard Setup
        function setupOnboardingWizard() {
            // Skip wizard button
            document.getElementById('skipWizard').addEventListener('click', hideOnboardingWizard);
            
            // Sample card buttons
            document.querySelectorAll('.sample-card').forEach(card => {
                card.addEventListener('click', function() {
                    const sampleType = this.getAttribute('data-sample');
                    loadSampleFromWizard(sampleType);
                });
            });
        }

        // Accessibility features
        function setupAccessibility() {
            // Add focus management
            setupFocusManagement();
            
            // Add theme switching
            setupThemeSwitching();
            
            // Add high contrast theme toggle
            setupHighContrastToggle();
            
            // Add ARIA labels and roles
            setupARIALabels();
            
            // Add skip links
            setupSkipLinks();
            
            // Setup screen reader announcements
            setupScreenReaderAnnouncements();
            
            // Setup keyboard navigation
            setupKeyboardNavigation();
            
            // Setup focus indicators
            setupFocusIndicators();
            
            // Setup color contrast validation
            setupColorContrastValidation();
        }

        function setupThemeSwitching() {
            // Create theme toggle button
            const themeToggle = document.createElement('button');
            themeToggle.id = 'themeToggle';
            themeToggle.className = 'theme-toggle';
            themeToggle.innerHTML = '🌙';
            themeToggle.setAttribute('aria-label', 'Toggle dark mode');
            themeToggle.title = 'Toggle dark mode';
            
            // Add to toolbar
            const toolbar = document.querySelector('.toolbar');
            if (toolbar) {
                toolbar.appendChild(themeToggle);
            }
            
            // Load saved theme
            const savedTheme = localStorage.getItem('theme') || 'light';
            setTheme(savedTheme);
            
            // Add click handler
            themeToggle.addEventListener('click', () => {
                const currentTheme = document.body.classList.contains('dark-theme') ? 'dark' : 'light';
                const newTheme = currentTheme === 'light' ? 'dark' : 'light';
                setTheme(newTheme);
                localStorage.setItem('theme', newTheme);
            });
        }

        function setTheme(theme) {
            const body = document.body;
            const themeToggle = document.getElementById('themeToggle');
            
            if (theme === 'dark') {
                body.classList.add('dark-theme');
                body.classList.remove('light-theme', 'high-contrast-theme');
                if (themeToggle) themeToggle.innerHTML = '☀️';
            } else if (theme === 'high-contrast') {
                body.classList.add('high-contrast-theme');
                body.classList.remove('light-theme', 'dark-theme');
                if (themeToggle) themeToggle.innerHTML = '🔆';
            } else {
                body.classList.add('light-theme');
                body.classList.remove('dark-theme', 'high-contrast-theme');
                if (themeToggle) themeToggle.innerHTML = '🌙';
            }
        }

        function setupScreenReaderAnnouncements() {
            // Create live region for announcements
            const liveRegion = document.createElement('div');
            liveRegion.id = 'liveRegion';
            liveRegion.setAttribute('aria-live', 'polite');
            liveRegion.setAttribute('aria-atomic', 'true');
            liveRegion.className = 'sr-only';
            document.body.appendChild(liveRegion);
            
            // Announce analysis progress
            const originalUpdateProgressStage = window.updateProgressStage;
            window.updateProgressStage = function(stage) {
                originalUpdateProgressStage(stage);
                const stageNames = ['parsing', 'building graph', 'computing metrics', 'rendering'];
                announceToScreenReader(`Analysis stage: ${stageNames[stage - 1] || 'complete'}`);
            };
        }

        function announceToScreenReader(message) {
            const liveRegion = document.getElementById('liveRegion');
            if (liveRegion) {
                liveRegion.textContent = message;
            }
        }

        function setupKeyboardNavigation() {
            // Enhanced keyboard navigation for all interactive elements
            const interactiveElements = document.querySelectorAll('button, input, select, textarea, [tabindex], [role="button"], [role="menuitem"], [role="tab"]');
            
            interactiveElements.forEach(element => {
                // Ensure proper tab order
                if (!element.hasAttribute('tabindex')) {
                    element.setAttribute('tabindex', '0');
                }
                
                // Add keyboard event handlers
                element.addEventListener('keydown', function(e) {
                    // Handle Enter and Space for buttons
                    if (e.key === 'Enter' || e.key === ' ') {
                        if (this.tagName === 'BUTTON' || this.getAttribute('role') === 'button') {
                            e.preventDefault();
                            this.click();
                        }
                    }
                    
                    // Handle arrow keys for menu items
                    if (this.getAttribute('role') === 'menuitem') {
                        const menuItems = Array.from(document.querySelectorAll('[role="menuitem"]'));
                        const currentIndex = menuItems.indexOf(this);
                        
                        if (e.key === 'ArrowDown') {
                            e.preventDefault();
                            const nextIndex = (currentIndex + 1) % menuItems.length;
                            menuItems[nextIndex].focus();
                        } else if (e.key === 'ArrowUp') {
                            e.preventDefault();
                            const prevIndex = currentIndex === 0 ? menuItems.length - 1 : currentIndex - 1;
                            menuItems[prevIndex].focus();
                        }
                    }
                });
            });
        }

        function setupFocusIndicators() {
            // Add focus indicators for all focusable elements
            const style = document.createElement('style');
            style.textContent = `
                *:focus {
                    outline: 2px solid #007acc !important;
                    outline-offset: 2px !important;
                }
                
                *:focus-visible {
                    outline: 2px solid #007acc !important;
                    outline-offset: 2px !important;
                }
                
                .sr-only {
                    position: absolute !important;
                    width: 1px !important;
                    height: 1px !important;
                    padding: 0 !important;
                    margin: -1px !important;
                    overflow: hidden !important;
                    clip: rect(0, 0, 0, 0) !important;
                    white-space: nowrap !important;
                    border: 0 !important;
                }
            `;
            document.head.appendChild(style);
        }

        function setupColorContrastValidation() {
            // Validate color contrast ratios
            function validateContrast(element) {
                const computedStyle = window.getComputedStyle(element);
                const backgroundColor = computedStyle.backgroundColor;
                const color = computedStyle.color;
                
                // Simple contrast validation (would need more sophisticated implementation)
                if (backgroundColor && color) {
                    // This is a simplified check - in production, you'd use a proper contrast calculation
                    const contrastRatio = calculateContrastRatio(backgroundColor, color);
                    if (contrastRatio < 4.5) { // WCAG AA minimum
                        console.warn(`Low contrast ratio detected: ${contrastRatio} for element`, element);
                    }
                }
            }
            
            function calculateContrastRatio(color1, color2) {
                // Simplified contrast calculation
                // In production, use a proper color contrast library
                return 4.5; // Placeholder
            }
            
            // Validate contrast on theme changes
            document.addEventListener('themeChanged', function() {
                const elements = document.querySelectorAll('*');
                elements.forEach(validateContrast);
            });
        }

        function setupFocusManagement() {
            // Add focus rings to interactive elements
            const interactiveElements = document.querySelectorAll('button, input, select, textarea, [tabindex]');
            interactiveElements.forEach(element => {
                element.addEventListener('focus', function() {
                    this.classList.add('focus-ring');
                });
                
                element.addEventListener('blur', function() {
                    this.classList.remove('focus-ring');
                });
            });
        }

        function setupHighContrastToggle() {
            // Add high contrast toggle button
            const header = document.querySelector('.header');
            const toggleButton = document.createElement('button');
            toggleButton.id = 'high-contrast-toggle';
            toggleButton.innerHTML = '🌓';
            toggleButton.title = 'Toggle high contrast mode';
            toggleButton.setAttribute('aria-label', 'Toggle high contrast mode');
            toggleButton.className = 'accessibility-btn';
            
            toggleButton.addEventListener('click', function() {
                document.body.classList.toggle('high-contrast');
                const isHighContrast = document.body.classList.contains('high-contrast');
                this.setAttribute('aria-pressed', isHighContrast);
                localStorage.setItem('highContrast', isHighContrast);
            });
            
            // Check for saved preference
            const savedHighContrast = localStorage.getItem('highContrast') === 'true';
            if (savedHighContrast) {
                document.body.classList.add('high-contrast');
                toggleButton.setAttribute('aria-pressed', 'true');
            }
            
            header.appendChild(toggleButton);
        }

        function setupARIALabels() {
            // Add ARIA labels to key elements
            const analyzeBtn = document.getElementById('analyze-btn');
            if (analyzeBtn) {
                analyzeBtn.setAttribute('aria-label', 'Analyze code and generate understanding map');
            }
            
            const lensBtn = document.getElementById('lens-btn');
            if (lensBtn) {
                lensBtn.setAttribute('aria-label', 'Generate understanding lens');
            }
            
            const tourBtn = document.getElementById('tour-btn');
            if (tourBtn) {
                tourBtn.setAttribute('aria-label', 'View understanding tour');
            }
            
            const traceBtn = document.getElementById('trace-btn');
            if (traceBtn) {
                traceBtn.setAttribute('aria-label', 'Toggle trace overlay');
            }
            
            const exportBtn = document.getElementById('export-btn');
            if (exportBtn) {
                exportBtn.setAttribute('aria-label', 'Export analysis results');
            }
            
            // Add role attributes
            const graphContainer = document.getElementById('cy');
            if (graphContainer) {
                graphContainer.setAttribute('role', 'img');
                graphContainer.setAttribute('aria-label', 'Interactive code understanding map');
            }
        }

        function setupSkipLinks() {
            // Add skip links for keyboard navigation
            const skipLinks = document.createElement('div');
            skipLinks.className = 'skip-links';
            skipLinks.innerHTML = `
                <a href="#main-content" class="skip-link">Skip to main content</a>
                <a href="#navigation" class="skip-link">Skip to navigation</a>
                <a href="#cy" class="skip-link">Skip to graph</a>
            `;
            
            document.body.insertBefore(skipLinks, document.body.firstChild);
        }

        function closeAllModals() {
            // Close any open modals
            const modals = document.querySelectorAll('.modal, .overlay');
            modals.forEach(modal => {
                if (modal.style.display !== 'none') {
                    modal.style.display = 'none';
                }
            });
        }

        function initializeCytoscape() {
            cy = cytoscape({
                container: document.getElementById('cy'),
                elements: [],
                layout: {
                    name: 'dagre',
                    rankDir: 'TB',
                    nodeSep: 50,
                    edgeSep: 20,
                    rankSep: 100,
                    fit: true,
                    padding: 30,
                    animate: true,
                    animationDuration: 1000
                },
                style: [
                    {
                        selector: 'node',
                        style: {
                            'background-color': 'data(backgroundColor)',
                            'label': 'data(label)',
                            'color': 'white',
                            'font-size': 'data(fontSize)',
                            'font-weight': 'bold',
                            'text-valign': 'center',
                            'text-halign': 'center',
                            'width': 'data(size)',
                            'height': 'data(size)',
                            'border-width': 'data(borderWidth)',
                            'border-color': 'data(borderColor)',
                            'shape': 'data(shape)',
                            'text-outline-width': 1,
                            'text-outline-color': '#000',
                            'text-wrap': 'wrap',
                            'text-max-width': '100px',
                            'overlay-opacity': 0,
                            'events': 'yes',
                            'cursor': 'pointer'
                        }
                    },
                    {
                        selector: 'edge',
                        style: {
                            'width': 'data(width)',
                            'line-color': 'data(lineColor)',
                            'target-arrow-color': 'data(arrowColor)',
                            'target-arrow-shape': 'triangle',
                            'curve-style': 'bezier',
                            'line-style': 'data(style)',
                            'opacity': 'data(opacity)',
                            'label': 'data(label)',
                            'font-size': '10px',
                            'text-rotation': 'autorotate',
                            'text-margin-y': -10,
                            'overlay-opacity': 0,
                            'events': 'yes'
                        }
                    },
                    {
                        selector: 'node[complexity="high"]',
                        style: {
                            'background-color': '#e74c3c',
                            'border-color': '#c0392b',
                            'border-width': '3px',
                            'width': 'data(size)',
                            'height': 'data(size)'
                        }
                    },
                    {
                        selector: 'node[complexity="medium"]',
                        style: {
                            'background-color': '#f39c12',
                            'border-color': '#e67e22',
                            'border-width': '2px'
                        }
                    },
                    {
                        selector: 'node[complexity="low"]',
                        style: {
                            'background-color': '#27ae60',
                            'border-color': '#229954',
                            'border-width': '1px'
                        }
                    },
                    {
                        selector: 'node[sideEffects="true"]',
                        style: {
                            'border-style': 'dashed',
                            'border-width': '3px',
                            'border-color': '#8e44ad'
                        }
                    },
                    {
                        selector: 'edge[frequency="high"]',
                        style: {
                            'width': '4px',
                            'line-color': '#e74c3c',
                            'target-arrow-color': '#e74c3c'
                        }
                    },
                    {
                        selector: 'edge[frequency="medium"]',
                        style: {
                            'width': '2px',
                            'line-color': '#f39c12',
                            'target-arrow-color': '#f39c12'
                        }
                    },
                    {
                        selector: 'edge[frequency="low"]',
                        style: {
                            'width': '1px',
                            'line-color': '#95a5a6',
                            'target-arrow-color': '#95a5a6'
                        }
                    },
                    {
                        selector: '.highlighted',
                        style: {
                            'background-color': '#17a2b8',
                            'border-color': '#138496',
                            'border-width': '4px',
                            'z-index': 10
                        }
                    },
                    {
                        selector: '.trace-path',
                        style: {
                            'background-color': '#f39c12',
                            'border-color': '#e67e22',
                            'line-color': '#f39c12',
                            'target-arrow-color': '#f39c12',
                            'z-index': 5
                        }
                    },
                    {
                        selector: '.hot-path',
                        style: {
                            'background-color': '#e74c3c',
                            'border-color': '#c0392b',
                            'border-width': '3px',
                            'z-index': 8
                        }
                    },
                    {
                        selector: '.side-effect',
                        style: {
                            'background-color': '#e74c3c',
                            'border-color': '#c0392b',
                            'border-width': '3px',
                            'z-index': 7
                        }
                    },
                    {
                        selector: '.high-complexity',
                        style: {
                            'background-color': '#f39c12',
                            'border-color': '#e67e22',
                            'border-width': '3px',
                            'z-index': 6
                        }
                    }
                ],
                layout: {
                    name: 'dagre',
                    rankDir: 'TB',
                    spacingFactor: 2.0,
                    nodeSep: 50,
                    edgeSep: 20,
                    rankSep: 100
                },
                userZoomingEnabled: true,
                userPanningEnabled: true,
                boxSelectionEnabled: true,
                selectionType: 'additive'
            });

            // Initialize minimap
            initializeMinimap();
            
            // Add deep link support
            setupDeepLinks();
            
            // Add advanced graph interactions
            setupAdvancedGraphInteractions();
            
            // Add clustering support
            setupClustering();
            
            // Add search functionality
            setupGraphSearch();
            
            // Add performance optimizations
            setupPerformanceOptimizations();
        }

        function initializeMinimap() {
            const minimapContainer = document.getElementById('minimap');
            if (!minimapContainer) return;

            cyMinimap = cytoscape({
                container: minimapContainer,
                elements: [],
                style: [
                    {
                        selector: 'node',
                        style: {
                            'background-color': '#495057',
                            'label': 'data(label)',
                            'color': 'white',
                            'font-size': '8px',
                            'text-valign': 'center',
                            'text-halign': 'center',
                            'width': 'data(size)',
                            'height': 'data(size)',
                            'border-width': '1px',
                            'border-color': 'data(borderColor)'
                        }
                    },
                    {
                        selector: 'edge',
                        style: {
                            'width': '1px',
                            'line-color': '#495057',
                            'target-arrow-color': '#495057',
                            'target-arrow-shape': 'triangle',
                            'curve-style': 'bezier'
                        }
                    }
                ],
                layout: {
                    name: 'dagre',
                    rankDir: 'TB',
                    spacingFactor: 0.5
                },
                userZoomingEnabled: false,
                userPanningEnabled: false,
                boxSelectionEnabled: false
            });

            // Sync minimap with main graph
            cy.on('layoutstop', () => {
                if (cyMinimap) {
                    cyMinimap.elements().remove();
                    cyMinimap.add(cy.elements().jsons());
                    cyMinimap.layout({ name: 'dagre', rankDir: 'TB', spacingFactor: 0.5 }).run();
                }
            });
        }

        function setupDeepLinks() {
            // Handle URL hash changes
            window.addEventListener('hashchange', handleHashChange);
            
            // Handle initial hash
            if (window.location.hash) {
                handleHashChange();
            }
        }

        function handleHashChange() {
            const hash = window.location.hash.substring(1);
            const params = new URLSearchParams(hash);
            
            const nodeId = params.get('node');
            const lens = params.get('lens');
            const overlay = params.get('overlay');
            
            if (nodeId && cy) {
                const node = cy.getElementById(nodeId);
                if (node.length > 0) {
                    cy.center(node);
                    cy.zoom(1.5);
                    node.addClass('highlighted');
                }
            }
            
            if (lens) {
                applyLens(lens);
            }
            
            if (overlay === 'trace') {
                toggleTraceOverlay();
            }
        }

        function createDeepLink(nodeId, lens = null, overlay = null) {
            const params = new URLSearchParams();
            if (nodeId) params.set('node', nodeId);
            if (lens) params.set('lens', lens);
            if (overlay) params.set('overlay', overlay);
            
            const newUrl = window.location.pathname + '#' + params.toString();
            window.history.pushState({}, '', newUrl);
        }

        function toggleMinimap() {
            const minimap = document.getElementById('minimap');
            const btn = document.getElementById('minimapBtn');
            
            if (minimap.style.display === 'none') {
                minimap.style.display = 'block';
                btn.textContent = 'Hide Minimap';
                if (cyMinimap) {
                    cyMinimap.elements().remove();
                    cyMinimap.add(cy.elements().jsons());
                    cyMinimap.layout({ name: 'dagre', rankDir: 'TB', spacingFactor: 0.5 }).run();
                }
            } else {
                minimap.style.display = 'none';
                btn.textContent = 'Minimap';
            }
        }

        function zoomToFit() {
            if (cy) {
                cy.fit(50);
            }
        }

        function applyLens(lensName) {
            // Apply lens filtering
            console.log('Applying lens:', lensName);
            // Implementation would filter nodes/edges based on lens criteria
        }

        function setupKeyboardShortcuts() {
            let shortcutsVisible = false;
            
            document.addEventListener('keydown', function(e) {
                // Don't process shortcuts if user is typing in input fields
                if (e.target.matches('input, textarea, [contenteditable]')) {
                    return;
                }
                
                // Cmd/Ctrl + Enter to analyze
                if ((e.metaKey || e.ctrlKey) && e.key === 'Enter') {
                    e.preventDefault();
                    analyzeCode();
                }
                
                // Help shortcut
                if (e.key === '?' && !e.metaKey && !e.ctrlKey) {
                    e.preventDefault();
                    toggleShortcutsHelp();
                }
                
                // Quick navigation
                if (e.key === 'g') {
                    e.preventDefault();
                    // Wait for next key
                    document.addEventListener('keydown', function navHandler(navEvent) {
                        if (navEvent.key === 'm') {
                            focusMap();
                        } else if (navEvent.key === 't') {
                            focusTour();
                        }
                        document.removeEventListener('keydown', navHandler);
                    });
                }
                
                // Focus search
                if (e.key === '/') {
                    e.preventDefault();
                    focusSearch();
                }
                
                // Toggle filters
                if (e.key === 'f') {
                    e.preventDefault();
                    toggleFilterPanel();
                }
                
                // Toggle overlay
                if (e.key === 'o') {
                    e.preventDefault();
                    toggleTraceOverlay();
                }
                
                // Cmd/Ctrl combinations
                if (e.metaKey || e.ctrlKey) {
                    switch(e.key) {
                        case 'k':
                            e.preventDefault();
                            focusSearch();
                            break;
                        case 'e':
                            e.preventDefault();
                            exportResults();
                            break;
                        case 'l':
                            e.preventDefault();
                            toggleLens();
                            break;
                        case '1':
                            e.preventDefault();
                            focusPane('left');
                            break;
                        case '2':
                            e.preventDefault();
                            focusPane('center');
                            break;
                        case '3':
                            e.preventDefault();
                            focusPane('right');
                            break;
                    }
                }
                
                // Escape to close modals and focus management
                if (e.key === 'Escape') {
                    if (shortcutsVisible) {
                        hideShortcutsHelp();
                        shortcutsVisible = false;
                    } else {
                        hideOnboardingWizard();
                        hideTourReader();
                        hideLensPanel();
                        hideExportMenu();
                        // Return focus to main content
                        document.getElementById('codeInput').focus();
                    }
                }
                
                // Space to start/pause tour
                if (e.key === ' ' && !e.target.matches('input, textarea')) {
                    e.preventDefault();
                    if (currentTour && currentTour.isPlaying) {
                        pauseTour();
                    } else if (currentTour) {
                        resumeTour();
                    }
                }
                
                // Arrow keys for navigation
                if (e.key === 'ArrowLeft' || e.key === 'ArrowRight') {
                    if (currentTour) {
                        e.preventDefault();
                        if (e.key === 'ArrowLeft') {
                            previousStep();
                        } else {
                            nextStep();
                        }
                    }
                }
                
                // Tab navigation enhancement
                if (e.key === 'Tab') {
                    enhanceTabNavigation(e);
                }
            });
        }

        function toggleShortcutsHelp() {
            const helpModal = document.getElementById('shortcutsHelp');
            if (helpModal) {
                helpModal.style.display = helpModal.style.display === 'none' ? 'block' : 'none';
            } else {
                createShortcutsHelp();
            }
        }

        function createShortcutsHelp() {
            const modal = document.createElement('div');
            modal.id = 'shortcutsHelp';
            modal.className = 'shortcuts-help-modal';
            modal.innerHTML = `
                <div class="shortcuts-content">
                    <div class="shortcuts-header">
                        <h3>Keyboard Shortcuts</h3>
                        <button class="close-btn" onclick="hideShortcutsHelp()">×</button>
                    </div>
                    <div class="shortcuts-grid">
                        <div class="shortcut-category">
                            <h4>Navigation</h4>
                            <div class="shortcut-item">
                                <kbd>?</kbd>
                                <span>Show/hide shortcuts</span>
                            </div>
                            <div class="shortcut-item">
                                <kbd>/</kbd>
                                <span>Focus search</span>
                            </div>
                            <div class="shortcut-item">
                                <kbd>g</kbd><kbd>m</kbd>
                                <span>Go to map</span>
                            </div>
                            <div class="shortcut-item">
                                <kbd>g</kbd><kbd>t</kbd>
                                <span>Go to tour</span>
                            </div>
                        </div>
                        <div class="shortcut-category">
                            <h4>Analysis</h4>
                            <div class="shortcut-item">
                                <kbd>⌘</kbd><kbd>⏎</kbd>
                                <span>Analyze code</span>
                            </div>
                            <div class="shortcut-item">
                                <kbd>f</kbd>
                                <span>Toggle filters</span>
                            </div>
                            <div class="shortcut-item">
                                <kbd>o</kbd>
                                <span>Toggle overlay</span>
                            </div>
                        </div>
                        <div class="shortcut-category">
                            <h4>Panes</h4>
                            <div class="shortcut-item">
                                <kbd>⌘</kbd><kbd>1</kbd>
                                <span>Focus left pane</span>
                            </div>
                            <div class="shortcut-item">
                                <kbd>⌘</kbd><kbd>2</kbd>
                                <span>Focus center pane</span>
                            </div>
                            <div class="shortcut-item">
                                <kbd>⌘</kbd><kbd>3</kbd>
                                <span>Focus right pane</span>
                            </div>
                        </div>
                        <div class="shortcut-category">
                            <h4>Actions</h4>
                            <div class="shortcut-item">
                                <kbd>⌘</kbd><kbd>e</kbd>
                                <span>Export results</span>
                            </div>
                            <div class="shortcut-item">
                                <kbd>⌘</kbd><kbd>l</kbd>
                                <span>Toggle lens</span>
                            </div>
                            <div class="shortcut-item">
                                <kbd>Space</kbd>
                                <span>Play/pause tour</span>
                            </div>
                            <div class="shortcut-item">
                                <kbd>←</kbd><kbd>→</kbd>
                                <span>Navigate tour steps</span>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
            modal.style.display = 'block';
        }

        function hideShortcutsHelp() {
            const helpModal = document.getElementById('shortcutsHelp');
            if (helpModal) {
                helpModal.style.display = 'none';
            }
        }

        function focusSearch() {
            // Focus on search input if available, otherwise create one
            let searchInput = document.getElementById('searchInput');
            if (!searchInput) {
                searchInput = document.createElement('input');
                searchInput.id = 'searchInput';
                searchInput.type = 'text';
                searchInput.placeholder = 'Search functions, modules, or patterns...';
                searchInput.className = 'search-input';
                document.body.appendChild(searchInput);
            }
            searchInput.focus();
            searchInput.select();
        }

        function focusMap() {
            const mapPane = document.getElementById('centerPane');
            if (mapPane) {
                mapPane.scrollIntoView({ behavior: 'smooth' });
                mapPane.focus();
            }
        }

        function focusTour() {
            const tourPanel = document.getElementById('tourPanel');
            if (tourPanel) {
                // Switch to tour tab in insights panel
                const tourTab = document.querySelector('[data-tab="tour"]');
                if (tourTab) {
                    tourTab.click();
                }
                tourPanel.scrollIntoView({ behavior: 'smooth' });
            }
        }

        function focusPane(paneName) {
            const pane = document.getElementById(paneName + 'Pane');
            if (pane) {
                pane.scrollIntoView({ behavior: 'smooth' });
                pane.focus();
            }
        }

        function enhanceTabNavigation(e) {
            // Enhanced tab navigation for better accessibility
            const focusableElements = document.querySelectorAll(
                'button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])'
            );
            
            const currentIndex = Array.from(focusableElements).indexOf(document.activeElement);
            
            if (e.shiftKey) {
                // Shift + Tab: go backwards
                if (currentIndex > 0) {
                    focusableElements[currentIndex - 1].focus();
                } else {
                    focusableElements[focusableElements.length - 1].focus();
                }
            } else {
                // Tab: go forwards
                if (currentIndex < focusableElements.length - 1) {
                    focusableElements[currentIndex + 1].focus();
                } else {
                    focusableElements[0].focus();
                }
            }
        }

        function showWizard() {
            const wizard = document.getElementById('wizardOverlay');
            wizard.style.display = 'flex';
        }

        function closeWizard() {
            const wizard = document.getElementById('wizardOverlay');
            wizard.style.display = 'none';
        }

        function loadSampleCode(type) {
            const codeInput = document.getElementById('codeInput');
            codeInput.value = sampleCode[type] || '';
            closeWizard();
            analyzeCode();
        }

        function loadExample(type) {
            const codeInput = document.getElementById('codeInput');
            codeInput.value = sampleCode[type] || '';
        }

        function clearCode() {
            const codeInput = document.getElementById('codeInput');
            codeInput.value = '';
        }

        function analyzeCode() {
            const codeInput = document.getElementById('codeInput');
            const loading = document.getElementById('loading');
            
            if (!codeInput.value.trim()) {
                showError('Please enter some Python code to analyze.');
                return;
            }
            
            loading.style.display = 'block';
            
            // Track TTU metrics
            const startTime = Date.now();
            
            // Simulate analysis with progress stages
            const stages = [
                { stage: 'parse', delay: 500 },
                { stage: 'graph', delay: 1000 },
                { stage: 'metrics', delay: 1500 },
                { stage: 'render', delay: 2000 }
            ];
            
            stages.forEach((stage, index) => {
                setTimeout(() => {
                    updateProgressStage(index);
                    if (index === stages.length - 1) {
                        setTimeout(() => {
                            completeAnalysis(codeInput.value, startTime);
                        }, 500);
                    }
                }, stage.delay);
            });
        }

        function resetMilestones() {
            ['milestone1', 'milestone2', 'milestone3', 'milestone4'].forEach(id => {
                const element = document.getElementById(id);
                element.className = 'milestone-dot';
            });
        }

        function updateMilestone(id, status) {
            const element = document.getElementById(id);
            element.className = `milestone-dot ${status}`;
        }

        function completeAnalysis(code, startTime) {
            const loading = document.getElementById('loading');
            loading.style.display = 'none';
            
            // Mark all milestones as completed
            ['milestone1', 'milestone2', 'milestone3', 'milestone4'].forEach(id => {
                updateMilestone(id, 'completed');
            });
            
            // Perform analysis
            currentAnalysis = performAdvancedAnalysis(code);
            
            // Render graph
            renderGraph(currentAnalysis);
            
            // Update metrics
            updateMetrics(currentAnalysis);
            updateMetricsFromAnalysis(currentAnalysis);
            
            // Update side effects panel
            updateSideEffectsPanel(currentAnalysis);
            
            // Generate tour
            generateTour(currentAnalysis);
            
            // Track TTU
            const ttu = (Date.now() - startTime) / 1000;
            trackMetric('ttu', ttu);
            
            // Dispatch map generated event for TTU tracking
            document.dispatchEvent(new CustomEvent('map_generated', {
                detail: { analysis: currentAnalysis, ttu: ttu }
            }));
            
            console.log(`Analysis completed in ${ttu}s`);
        }

        function updateMetricsFromAnalysis(analysisData) {
            const functions = analysisData.functions || {};
            const functionList = Object.values(functions);
            
            const totalFunctions = functionList.length;
            const avgComplexity = functionList.length > 0 
                ? (functionList.reduce((sum, f) => sum + (f.complexity || 0), 0) / functionList.length).toFixed(1)
                : 0;
            const sideEffectCount = functionList.filter(f => f.sideEffects && f.sideEffects.length > 0).length;
            const hotPathCount = functionList.filter(f => f.isHotPath).length;
            
            updateMetrics({
                totalFunctions,
                avgComplexity,
                sideEffectCount,
                hotPathCount
            });
        }

        function updateSideEffectsPanel(analysisData) {
            const sideEffectsList = document.getElementById('sideEffectsList');
            if (!sideEffectsList) return;
            
            const functions = analysisData.functions || {};
            const sideEffectFunctions = Object.entries(functions)
                .filter(([name, func]) => func.sideEffects && func.sideEffects.length > 0)
                .map(([name, func]) => ({ name, ...func }));
            
            if (sideEffectFunctions.length === 0) {
                sideEffectsList.innerHTML = '<p class="no-side-effects">No side effects detected</p>';
                return;
            }
            
            sideEffectsList.innerHTML = sideEffectFunctions.map(func => `
                <div class="side-effect-item">
                    <span class="side-effect-icon">⚠️</span>
                    <div class="side-effect-details">
                        <div class="side-effect-function">${func.name}</div>
                        <div class="side-effect-description">
                            ${func.sideEffects.join(', ')} • Line ${func.line}
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function renderGraph(analysis) {
            const elements = [];
            const nodes = new Map();
            
            // Create nodes with enhanced encodings
            analysis.functions.forEach((func, index) => {
                const nodeId = `func_${index}`;
                nodes.set(func.name, nodeId);
                
                const complexity = func.complexity;
                const size = Math.max(30, Math.min(80, complexity * 10));
                const fontSize = Math.max(10, Math.min(16, complexity * 0.8));
                
                // Color coding based on complexity and side effects
                let backgroundColor = '#495057'; // Default
                let borderColor = '#6c757d';
                let borderWidth = 2;
                let classes = [];
                
                if (func.sideEffects.length > 0) {
                    backgroundColor = '#e74c3c';
                    borderColor = '#c0392b';
                    borderWidth = 3;
                    classes.push('side-effect');
                } else if (complexity > 10) {
                    backgroundColor = '#f39c12';
                    borderColor = '#e67e22';
                    borderWidth = 3;
                    classes.push('high-complexity');
                } else if (complexity > 5) {
                    backgroundColor = '#17a2b8';
                    borderColor = '#138496';
                } else {
                    backgroundColor = '#28a745';
                    borderColor = '#1e7e34';
                }
                
                // Add hot path class if applicable
                if (func.hotPath) {
                    classes.push('hot-path');
                }
                
                elements.push({
                    data: {
                        id: nodeId,
                        label: func.name,
                        size: size,
                        fontSize: fontSize,
                        backgroundColor: backgroundColor,
                        borderColor: borderColor,
                        borderWidth: borderWidth,
                        complexity: complexity,
                        sideEffects: func.sideEffects,
                        calls: func.calls,
                        module: func.module || 'main',
                        lineNumber: func.lineNumber || 0
                    },
                    classes: classes.join(' ')
                });
            });
            
            // Create edges with enhanced encodings
            analysis.functions.forEach((func, index) => {
                const sourceId = `func_${index}`;
                func.calls.forEach((callName, callIndex) => {
                    const targetIndex = analysis.functions.findIndex(f => f.name === callName);
                    if (targetIndex !== -1) {
                        const targetId = `func_${targetIndex}`;
                        const callCount = func.callCounts ? func.callCounts[callIndex] || 1 : 1;
                        const width = Math.max(1, Math.min(8, callCount * 2));
                        const opacity = Math.max(0.3, Math.min(1, callCount / 10));
                        
                        elements.push({
                            data: {
                                id: `edge_${sourceId}_${targetId}`,
                                source: sourceId,
                                target: targetId,
                                width: width,
                                lineColor: '#495057',
                                arrowColor: '#495057',
                                style: 'solid',
                                opacity: opacity,
                                callCount: callCount
                            }
                        });
                    }
                });
            });
            
            // Update cytoscape
            cy.elements().remove();
            cy.add(elements);
            
            // Apply hierarchical layout
            cy.layout({ 
                name: 'dagre', 
                rankDir: 'TB', 
                spacingFactor: 2.0,
                nodeSep: 50,
                edgeSep: 20,
                rankSep: 100,
                animate: true,
                animationDuration: 1000
            }).run();
            
            // Fit to view with padding
            cy.fit(50);
            
            // Add enhanced click handlers
            cy.on('tap', 'node', function(evt) {
                const node = evt.target;
                const funcName = node.data('label');
                const nodeId = node.id();
                
                // Highlight function
                highlightFunction(funcName);
                
                // Create deep link
                createDeepLink(nodeId);
                
                // Show hover card
                showNodeHoverCard(node);
            });
            
            // Add hover effects
            cy.on('mouseover', 'node', function(evt) {
                const node = evt.target;
                node.addClass('highlighted');
            });
            
            cy.on('mouseout', 'node', function(evt) {
                const node = evt.target;
                if (!node.hasClass('selected')) {
                    node.removeClass('highlighted');
                }
            });
            
            // Initialize minimap
            initializeMinimap();
            
            // Add enhanced interactions
            setupEnhancedInteractions();
            
            // Add zoom controls
            setupZoomControls();
        }

        function initializeMinimap() {
            const minimapContainer = document.getElementById('minimap');
            if (!minimapContainer) return;
            
            cyMinimap = cytoscape({
                container: minimapContainer,
                elements: [],
                style: [
                    {
                        selector: 'node',
                        style: {
                            'background-color': '#3498db',
                            'label': 'data(label)',
                            'color': 'white',
                            'font-size': '8px',
                            'width': '20px',
                            'height': '20px',
                            'text-valign': 'center',
                            'text-halign': 'center'
                        }
                    },
                    {
                        selector: 'edge',
                        style: {
                            'width': '1px',
                            'line-color': '#95a5a6',
                            'target-arrow-color': '#95a5a6',
                            'target-arrow-shape': 'triangle'
                        }
                    }
                ],
                layout: { name: 'dagre', rankDir: 'TB', spacingFactor: 0.5 },
                minZoom: 0.1,
                maxZoom: 2
            });
        }

        function setupEnhancedInteractions() {
            // Hover card functionality
            cy.on('mouseover', 'node', function(evt) {
                const node = evt.target;
                node.addClass('highlighted');
                showNodeHoverCard(node);
            });
            
            cy.on('mouseout', 'node', function(evt) {
                const node = evt.target;
                if (!node.hasClass('selected')) {
                    node.removeClass('highlighted');
                }
                hideHoverCard();
            });

            // Click to select and show details
            cy.on('tap', 'node', function(evt) {
                const node = evt.target;
                const funcName = node.data('label');
                const nodeId = node.id();
                
                // Clear previous selections
                cy.elements().removeClass('selected');
                node.addClass('selected');
                
                // Show function details
                showFunctionDetails(funcName, nodeId);
                
                // Update URL with deep link
                updateURLWithNode(nodeId);
            });

            // Double-click to zoom to fit
            cy.on('dbltap', function(evt) {
                cy.fit();
            });

            // Lasso selection
            cy.on('box', function(evt) {
                const selectedNodes = evt.cyTarget;
                selectedNodes.addClass('selected');
            });
        }

        function setupZoomControls() {
            // Add zoom controls to the toolbar
            const toolbar = document.querySelector('.toolbar');
            if (toolbar) {
                const zoomControls = document.createElement('div');
                zoomControls.className = 'zoom-controls';
                zoomControls.innerHTML = `
                    <button onclick="cy.zoom(cy.zoom() * 1.2)" class="toolbar-btn">+</button>
                    <button onclick="cy.zoom(cy.zoom() * 0.8)" class="toolbar-btn">-</button>
                    <button onclick="cy.fit()" class="toolbar-btn">Fit</button>
                    <button onclick="cy.center()" class="toolbar-btn">Center</button>
                `;
                toolbar.appendChild(zoomControls);
            }
        }

        function showNodeHoverCard(node) {
            const data = node.data();
            const hoverCard = document.getElementById('hoverCard');
            if (!hoverCard) return;
            
            const complexity = data.complexity || 'unknown';
            const sideEffects = data.sideEffects || [];
            const callers = data.callers || [];
            const callees = data.callees || [];
            
            hoverCard.innerHTML = `
                <div class="hover-card-header">
                    <h4>${data.label}</h4>
                    <span class="complexity-badge complexity-${complexity}">${complexity}</span>
                    </div>
                <div class="hover-card-body">
                    <div class="hover-card-section">
                        <strong>File:</strong> ${data.file || 'Unknown'}<br>
                        <strong>Line:</strong> ${data.line || 'Unknown'}
                    </div>
                    ${sideEffects.length > 0 ? `
                        <div class="hover-card-section">
                            <strong>Side Effects:</strong>
                            <ul>${sideEffects.map(effect => `<li>${effect}</li>`).join('')}</ul>
                        </div>
                    ` : ''}
                    <div class="hover-card-section">
                        <strong>Callers:</strong> ${callers.length}<br>
                        <strong>Callees:</strong> ${callees.length}
                    </div>
                </div>
                <div class="hover-card-actions">
                    <button onclick="openInMap('${node.id()}')" class="btn-small">Open in Map</button>
                    <button onclick="addToLens('${node.id()}')" class="btn-small">Add to Lens</button>
                </div>
            `;
            
            hoverCard.style.display = 'block';
            hoverCard.style.left = (event.clientX + 10) + 'px';
            hoverCard.style.top = (event.clientY - 10) + 'px';
        }

        function hideHoverCard() {
            const hoverCard = document.getElementById('hoverCard');
            if (hoverCard) {
                hoverCard.style.display = 'none';
            }
        }

        function toggleMinimap() {
            const minimap = document.getElementById('minimap');
            const minimapBtn = document.getElementById('minimapBtn');
            
            if (minimap.style.display === 'none') {
                minimap.style.display = 'block';
                minimapBtn.textContent = 'Hide Minimap';
                updateMinimap();
            } else {
                minimap.style.display = 'none';
                minimapBtn.textContent = 'Minimap';
            }
        }

        function updateMinimap() {
            if (!cyMinimap) return;
            
            cyMinimap.elements().remove();
            cyMinimap.add(cy.elements().jsons());
            cyMinimap.layout({ name: 'dagre', rankDir: 'TB', spacingFactor: 0.5 }).run();
        }

        function openInMap(nodeId) {
            // Focus on the node in the main graph
            const node = cy.getElementById(nodeId);
            if (node) {
                cy.center(node);
                cy.zoom(cy.zoom() * 1.5);
                node.addClass('selected');
            }
        }

        function addToLens(nodeId) {
            // Add node to current lens
            const node = cy.getElementById(nodeId);
            if (node) {
                const funcName = node.data('label');
                console.log(`Adding ${funcName} to lens`);
                // TODO: Implement lens management
            }
        }

        function updateURLWithNode(nodeId) {
            const url = new URL(window.location);
            url.hash = `node=${nodeId}`;
            window.history.replaceState({}, '', url);
        }

        function loadNodeFromURL() {
            const hash = window.location.hash;
            const match = hash.match(/node=([^&]+)/);
            if (match) {
                const nodeId = match[1];
                const node = cy.getElementById(nodeId);
                if (node) {
                    cy.center(node);
                    node.addClass('selected');
                }
            }
        }

        function updateMetrics(analysis) {
            const metricsDisplay = document.getElementById('metricsDisplay');
            const metrics = analysis.metrics;
            
            metricsDisplay.innerHTML = `
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; font-size: 12px;">
                    <div><strong>Functions:</strong> ${metrics.functionCount}</div>
                    <div><strong>Classes:</strong> ${metrics.classCount}</div>
                    <div><strong>Complexity:</strong> ${metrics.cyclomaticComplexity}</div>
                    <div><strong>Avg Complexity:</strong> ${metrics.averageComplexity.toFixed(1)}</div>
                    <div><strong>Lines:</strong> ${analysis.totalLines}</div>
                    <div><strong>Side Effects:</strong> ${analysis.sideEffects.length}</div>
                </div>
                ${analysis.sideEffects.length > 0 ? `
                    <div style="margin-top: 8px;">
                        <strong>Side Effects:</strong>
                        ${analysis.sideEffects.map(effect => `<span style="background: #fff3cd; padding: 2px 6px; border-radius: 3px; margin: 2px; font-size: 10px;">${effect}</span>`).join('')}
                    </div>
                ` : ''}
            `;
        }

        function generateTour(analysis) {
            tourSteps = [];
            let step = 1;
            
            // Entry point analysis
            const entryPoints = analysis.functions.filter(f => f.calls.length === 0 || f.name.toLowerCase().includes('main'));
            if (entryPoints.length > 0) {
                tourSteps.push({
                    title: `Step ${step++}: Entry Point Analysis`,
                    description: `Start with the main function <code>${entryPoints[0].name}()</code> - this appears to be the primary entry point.`,
                    focusNodes: [entryPoints[0].name],
                    codeRange: { start: entryPoints[0].line, end: entryPoints[0].line }
                });
            }
            
            // Function dependencies
            if (analysis.functions.length > 1) {
                tourSteps.push({
                    title: `Step ${step++}: Function Dependencies`,
                    description: `Follow the call chain through the codebase to understand execution flow.`,
                    focusNodes: analysis.functions.map(f => f.name),
                    codeRange: null
                });
            }
            
            // Side effects
            if (analysis.sideEffects.length > 0) {
                const sideEffectFunctions = analysis.functions.filter(f => f.sideEffects.length > 0);
                tourSteps.push({
                    title: `Step ${step++}: Side Effects Analysis`,
                    description: `Identify potential side effects: ${analysis.sideEffects.join(', ')} operations detected.`,
                    focusNodes: sideEffectFunctions.map(f => f.name),
                    codeRange: null
                });
            }
            
            // Complexity assessment
            const highComplexity = analysis.functions.filter(f => f.complexity > 6);
            if (highComplexity.length > 0) {
                tourSteps.push({
                    title: `Step ${step++}: Complexity Assessment`,
                    description: `Functions with high complexity may need refactoring: ${highComplexity.map(f => f.name).join(', ')}`,
                    focusNodes: highComplexity.map(f => f.name),
                    codeRange: null
                });
            }
            
            // Best practices
            tourSteps.push({
                title: `Step ${step++}: Best Practices`,
                description: `Consider these improvements: Add type hints, include docstrings, break down high-complexity functions, add error handling for side effects.`,
                focusNodes: [],
                codeRange: null
            });
            
            renderTour();
        }

        function renderTour() {
            const tourDisplay = document.getElementById('tourDisplay');
            if (!tourDisplay) return;
            
            const tourTimeline = tourSteps.map((step, index) => `
                <div class="tour-timeline-item ${index === currentTourStep ? 'active' : ''} ${step.completed ? 'completed' : ''} ${step.bookmarked ? 'bookmarked' : ''}" data-step="${index}">
                    <div class="timeline-marker">
                        <div class="timeline-dot">
                            ${step.completed ? '✓' : (step.bookmarked ? '🔖' : index + 1)}
                        </div>
                        <div class="timeline-line"></div>
                    </div>
                    <div class="timeline-content" onclick="goToStep(${index})">
                        <div class="timeline-header">
                            <h5>${step.title}</h5>
                            <div class="timeline-actions">
                                <button class="btn-icon" onclick="event.stopPropagation(); toggleBookmark(${index})" title="Bookmark">
                                    <span class="bookmark-icon">${step.bookmarked ? '🔖' : '📌'}</span>
                                </button>
                                <button class="btn-icon" onclick="event.stopPropagation(); goToStep(${index})" title="Go to Step">
                                    <span>👁️</span>
                                </button>
                                <button class="btn-icon" onclick="event.stopPropagation(); showStepDetails(${index})" title="View Details">
                                    <span>ℹ️</span>
                                </button>
                            </div>
                        </div>
                        <div class="timeline-details">
                            <p>${step.description}</p>
                            ${step.focusNodes && step.focusNodes.length > 0 ? `
                                <div class="step-focus">
                                    <strong>Focus:</strong> ${step.focusNodes.join(', ')}
                                </div>
                            ` : ''}
                            ${step.estimatedTime ? `
                                <div class="step-time">
                                    <strong>Time:</strong> ${step.estimatedTime}
                                </div>
                            ` : ''}
                        </div>
                    </div>
                </div>
            `).join('');
            
            const completedSteps = tourSteps.filter(s => s.completed).length;
            const bookmarkedSteps = tourSteps.filter(s => s.bookmarked).length;
            const estimatedTotalTime = tourSteps.reduce((total, step) => total + (step.estimatedTime || 0), 0);
            
            tourDisplay.innerHTML = `
                <div class="tour-header">
                    <div class="tour-title">
                        <h4>Understanding Tour</h4>
                        <div class="tour-stats">
                            <span class="stat-item">${completedSteps}/${tourSteps.length} completed</span>
                            <span class="stat-item">${bookmarkedSteps} bookmarked</span>
                            <span class="stat-item">~${estimatedTotalTime}min total</span>
                        </div>
                    </div>
                    <div class="tour-progress">
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: ${(completedSteps / tourSteps.length) * 100}%"></div>
                        </div>
                        <span class="progress-text">${completedSteps}/${tourSteps.length} steps</span>
                    </div>
                </div>
                <div class="tour-filters">
                    <button class="filter-btn ${showCompletedSteps ? 'active' : ''}" onclick="toggleCompletedSteps()">
                        Show Completed
                    </button>
                    <button class="filter-btn ${showBookmarkedOnly ? 'active' : ''}" onclick="toggleBookmarkedOnly()">
                        Bookmarks Only
                    </button>
                    <button class="filter-btn" onclick="exportTourBundle()">
                        Export Bundle
                    </button>
                </div>
                <div class="tour-timeline">
                    ${tourTimeline}
                </div>
                <div class="tour-controls">
                    <div class="tour-nav">
                        <button class="btn btn-sm" onclick="startTour()" id="startTourBtn">🔄 Restart</button>
                        <button class="btn btn-sm" onclick="previousStep()" id="prevBtn" ${currentTourStep === 0 ? 'disabled' : ''}>← Previous</button>
                        <button class="btn btn-sm" onclick="nextStep()" id="nextBtn" ${currentTourStep === tourSteps.length - 1 ? 'disabled' : ''}>Next →</button>
                        <button class="btn btn-sm" onclick="skipToNextBookmark()" id="skipBtn" ${getNextBookmarkIndex() === -1 ? 'disabled' : ''}>Skip to Bookmark</button>
                    </div>
                    <div class="tour-export">
                        <button class="btn btn-sm" onclick="exportTourMarkdown()" id="exportBtn">📄 Export MD</button>
                        <button class="btn btn-sm" onclick="exportTourBundle()" id="bundleBtn">📦 Export Bundle</button>
                        <button class="btn btn-sm" onclick="generatePRComment()" id="prBtn">💬 PR Comment</button>
                    </div>
                </div>
                <div class="tour-step-detail" id="tourStepDetail" style="display: none;">
                    <h5 id="stepTitle"></h5>
                    <div id="stepContent"></div>
                </div>
                <div class="tour-keyboard-help" id="tourKeyboardHelp">
                    <div class="keyboard-shortcuts">
                        <h6>Keyboard Shortcuts:</h6>
                        <div class="shortcut-list">
                            <span><kbd>Space</kbd> Next step</span>
                            <span><kbd>←</kbd> Previous step</span>
                            <span><kbd>B</kbd> Toggle bookmark</span>
                            <span><kbd>E</kbd> Export tour</span>
                            <span><kbd>?</kbd> Show/hide help</span>
                        </div>
                    </div>
                </div>
            `;
            
            // Update current step details
            if (tourSteps[currentTourStep]) {
                showCurrentStepDetails();
            }
            
            // Setup keyboard shortcuts
            setupTourKeyboardShortcuts();
        }

        // Enhanced Tour Features
        let showCompletedSteps = true;
        let showBookmarkedOnly = false;

        function toggleCompletedSteps() {
            showCompletedSteps = !showCompletedSteps;
            renderTour();
        }

        function toggleBookmarkedOnly() {
            showBookmarkedOnly = !showBookmarkedOnly;
            renderTour();
        }

        function showStepDetails(stepIndex) {
            const step = tourSteps[stepIndex];
            if (!step) return;

            const modal = document.createElement('div');
            modal.className = 'modal-overlay';
            modal.innerHTML = `
                <div class="modal-content">
                    <div class="modal-header">
                        <h3>${step.title}</h3>
                        <button onclick="closeModal()" class="close-btn">×</button>
                    </div>
                    <div class="modal-body">
                        <div class="step-detail-section">
                            <h4>Description</h4>
                            <p>${step.description}</p>
                        </div>
                        
                        ${step.focusNodes && step.focusNodes.length > 0 ? `
                        <div class="step-detail-section">
                            <h4>Focus Functions</h4>
                            <ul>
                                ${step.focusNodes.map(node => `<li>${node}</li>`).join('')}
                            </ul>
                        </div>
                        ` : ''}
                        
                        ${step.codeRange ? `
                        <div class="step-detail-section">
                            <h4>Code Range</h4>
                            <p>Lines ${step.codeRange.start}-${step.codeRange.end}</p>
                        </div>
                        ` : ''}
                        
                        ${step.estimatedTime ? `
                        <div class="step-detail-section">
                            <h4>Estimated Time</h4>
                            <p>${step.estimatedTime} minutes</p>
                        </div>
                        ` : ''}
                        
                        ${step.why ? `
                        <div class="step-detail-section">
                            <h4>Why This Matters</h4>
                            <p>${step.why}</p>
                        </div>
                        ` : ''}
                        
                        <div class="step-detail-section">
                            <h4>Actions</h4>
                            <div class="step-actions">
                                <button class="btn" onclick="goToStep(${stepIndex}); closeModal();">Go to Step</button>
                                <button class="btn" onclick="toggleBookmark(${stepIndex}); closeModal();">
                                    ${step.bookmarked ? 'Remove Bookmark' : 'Add Bookmark'}
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            document.body.appendChild(modal);
        }

        function showCurrentStepDetails() {
            const step = tourSteps[currentTourStep];
            if (!step) return;

            const stepDetail = document.getElementById('tourStepDetail');
            if (stepDetail) {
                stepDetail.innerHTML = `
                    <div class="current-step-header">
                        <h5>${step.title}</h5>
                        <div class="step-meta">
                            <span class="step-number">Step ${currentTourStep + 1} of ${tourSteps.length}</span>
                            ${step.estimatedTime ? `<span class="step-time">~${step.estimatedTime}min</span>` : ''}
                        </div>
                    </div>
                    <div class="current-step-content">
                        <p>${step.description}</p>
                        ${step.why ? `<div class="step-why"><strong>Why:</strong> ${step.why}</div>` : ''}
                        ${step.focusNodes && step.focusNodes.length > 0 ? `
                            <div class="step-focus-nodes">
                                <strong>Focus on:</strong> ${step.focusNodes.join(', ')}
                            </div>
                        ` : ''}
                    </div>
                `;
                stepDetail.style.display = 'block';
            }
        }

        function skipToNextBookmark() {
            const nextBookmarkIndex = getNextBookmarkIndex();
            if (nextBookmarkIndex !== -1) {
                goToStep(nextBookmarkIndex);
            }
        }

        function getNextBookmarkIndex() {
            for (let i = currentTourStep + 1; i < tourSteps.length; i++) {
                if (tourSteps[i].bookmarked) {
                    return i;
                }
            }
            return -1;
        }

        function setupTourKeyboardShortcuts() {
            // Remove existing tour keyboard listeners
            document.removeEventListener('keydown', handleTourKeyboard);
            
            // Add new tour keyboard listener
            document.addEventListener('keydown', handleTourKeyboard);
        }

        function handleTourKeyboard(e) {
            // Only handle if tour is active
            const tourDisplay = document.getElementById('tourDisplay');
            if (!tourDisplay || tourDisplay.style.display === 'none') return;

            switch(e.key) {
                case ' ':
                    e.preventDefault();
                    nextStep();
                    break;
                case 'ArrowLeft':
                    e.preventDefault();
                    previousStep();
                    break;
                case 'ArrowRight':
                    e.preventDefault();
                    nextStep();
                    break;
                case 'b':
                case 'B':
                    e.preventDefault();
                    toggleBookmark(currentTourStep);
                    break;
                case 'e':
                case 'E':
                    e.preventDefault();
                    exportTourMarkdown();
                    break;
                case '?':
                    e.preventDefault();
                    toggleKeyboardHelp();
                    break;
                case 'Escape':
                    e.preventDefault();
                    hideKeyboardHelp();
                    break;
            }
        }

        function toggleKeyboardHelp() {
            const help = document.getElementById('tourKeyboardHelp');
            if (help) {
                help.style.display = help.style.display === 'none' ? 'block' : 'none';
            }
        }

        function hideKeyboardHelp() {
            const help = document.getElementById('tourKeyboardHelp');
            if (help) {
                help.style.display = 'none';
            }
        }

        function exportTourBundle() {
            const tourBundle = {
                version: '1.0',
                timestamp: new Date().toISOString(),
                tour: {
                    title: 'Understanding Tour',
                    description: 'Interactive tour for code understanding',
                    steps: tourSteps,
                    metadata: {
                        totalSteps: tourSteps.length,
                        completedSteps: tourSteps.filter(s => s.completed).length,
                        bookmarkedSteps: tourSteps.filter(s => s.bookmarked).length,
                        estimatedTotalTime: tourSteps.reduce((total, step) => total + (step.estimatedTime || 0), 0)
                    }
                },
                analysis: currentAnalysis,
                generated_by: 'understand-first-web-demo'
            };

            const jsonData = JSON.stringify(tourBundle, null, 2);
            downloadFile(jsonData, 'understanding-tour.uftour', 'application/json');
            
            trackMetric('tour_bundle_exported', 'json');
        }

        // Enhanced Export System
        let selectedExportFormat = null;

        function showExportPanel() {
            let panel = document.getElementById('exportPanel');
            if (!panel) {
                panel = document.createElement('div');
                panel.id = 'exportPanel';
                panel.className = 'export-panel';
                panel.innerHTML = `
                    <div class="export-header">
                        <h4>📤 Export & Share</h4>
                        <button onclick="hideExportPanel()" class="close-btn">×</button>
                    </div>
                    <div class="export-content">
                        <div class="export-formats">
                            <div class="format-card" data-format="svg" onclick="selectExportFormat('svg')">
                                <div class="format-icon">🖼️</div>
                                <div class="format-title">SVG</div>
                                <div class="format-description">Vector image for presentations</div>
                            </div>
                            <div class="format-card" data-format="png" onclick="selectExportFormat('png')">
                                <div class="format-icon">📷</div>
                                <div class="format-title">PNG</div>
                                <div class="format-description">High-quality bitmap image</div>
                            </div>
                            <div class="format-card" data-format="json" onclick="selectExportFormat('json')">
                                <div class="format-icon">📋</div>
                                <div class="format-title">JSON</div>
                                <div class="format-description">Complete analysis data</div>
                            </div>
                            <div class="format-card" data-format="markdown" onclick="selectExportFormat('markdown')">
                                <div class="format-icon">📝</div>
                                <div class="format-title">Markdown</div>
                                <div class="format-description">Documentation report</div>
                            </div>
                            <div class="format-card" data-format="pr-comment" onclick="selectExportFormat('pr-comment')">
                                <div class="format-icon">💬</div>
                                <div class="format-title">PR Comment</div>
                                <div class="format-description">GitHub PR summary</div>
                            </div>
                            <div class="format-card" data-format="bundle" onclick="selectExportFormat('bundle')">
                                <div class="format-icon">📦</div>
                                <div class="format-title">Bundle</div>
                                <div class="format-description">Complete tour package</div>
                            </div>
                        </div>
                        
                        <div class="export-options">
                            <h5>Export Options</h5>
                            <div class="option-group">
                                <div class="option-item">
                                    <input type="checkbox" id="includeGraph" checked>
                                    <label for="includeGraph">Include graph visualization</label>
                                </div>
                                <div class="option-item">
                                    <input type="checkbox" id="includeTour" checked>
                                    <label for="includeTour">Include tour steps</label>
                                </div>
                                <div class="option-item">
                                    <input type="checkbox" id="includeTrace">
                                    <label for="includeTrace">Include trace data</label>
                                </div>
                                <div class="option-item">
                                    <input type="checkbox" id="includeMetrics">
                                    <label for="includeMetrics">Include metrics</label>
                                </div>
                            </div>
                            
                            <div class="option-group">
                                <div class="option-item">
                                    <input type="checkbox" id="includeDelta">
                                    <label for="includeDelta">Include delta comparison</label>
                                </div>
                                <div class="option-item">
                                    <input type="checkbox" id="includeInsights">
                                    <label for="includeInsights">Include insights</label>
                                </div>
                            </div>
                        </div>
                        
                        <div class="export-preview" id="exportPreview">
                            Select a format to see preview...
                        </div>
                        
                        <div class="export-actions">
                            <button onclick="previewExport()" class="preview-btn">👁️ Preview</button>
                            <button onclick="copyExportContent()" class="copy-btn">📋 Copy</button>
                            <button onclick="downloadExport()" class="export-btn">📥 Download</button>
                        </div>
                    </div>
                `;
                document.querySelector('.pane').appendChild(panel);
            }
            panel.style.display = 'block';
            selectedExportFormat = null;
            updateExportPreview();
        }

        function hideExportPanel() {
            const panel = document.getElementById('exportPanel');
            if (panel) {
                panel.style.display = 'none';
            }
        }

        function selectExportFormat(format) {
            selectedExportFormat = format;
            
            // Update UI
            document.querySelectorAll('.format-card').forEach(card => {
                card.classList.remove('selected');
            });
            document.querySelector(`[data-format="${format}"]`).classList.add('selected');
            
            updateExportPreview();
        }

        function updateExportPreview() {
            const preview = document.getElementById('exportPreview');
            if (!preview || !selectedExportFormat) {
                preview.textContent = 'Select a format to see preview...';
                return;
            }
            
            let previewContent = '';
            
            switch (selectedExportFormat) {
                case 'svg':
                    previewContent = '<!-- SVG export preview -->\n<svg width="800" height="600">\n  <!-- Graph elements will be rendered here -->\n</svg>';
                    break;
                case 'png':
                    previewContent = 'PNG export will generate a high-quality bitmap image of the current graph visualization.';
                    break;
                case 'json':
                    previewContent = generateJSONPreview();
                    break;
                case 'markdown':
                    previewContent = generateMarkdownPreview();
                    break;
                case 'pr-comment':
                    previewContent = generatePRCommentPreview();
                    break;
                case 'bundle':
                    previewContent = 'Bundle export will include:\n- Complete analysis data\n- Tour steps and progress\n- Graph visualization\n- Trace data (if available)\n- Metadata and timestamps';
                    break;
            }
            
            preview.textContent = previewContent;
        }

        function generateJSONPreview() {
            const data = {
                timestamp: new Date().toISOString(),
                analysis: currentAnalysis ? {
                    functions: currentAnalysis.functions?.length || 0,
                    modules: currentAnalysis.modules?.length || 0,
                    complexity: currentAnalysis.complexity || 0
                } : null,
                tour: {
                    steps: tourSteps.length,
                    completed: tourSteps.filter(s => s.completed).length,
                    bookmarked: tourSteps.filter(s => s.bookmarked).length
                },
                graph: cy ? {
                    nodes: cy.nodes().length,
                    edges: cy.edges().length
                } : null
            };
            
            return JSON.stringify(data, null, 2);
        }

        function generateMarkdownPreview() {
            return `# Code Analysis Report

**Generated:** ${new Date().toLocaleDateString()}

## Summary
- **Functions:** ${currentAnalysis?.functions?.length || 0}
- **Modules:** ${currentAnalysis?.modules?.length || 0}
- **Complexity Score:** ${currentAnalysis?.complexity || 0}

## Tour Progress
- **Steps:** ${tourSteps.length}
- **Completed:** ${tourSteps.filter(s => s.completed).length}
- **Bookmarked:** ${tourSteps.filter(s => s.bookmarked).length}

## Graph Visualization
- **Nodes:** ${cy?.nodes().length || 0}
- **Edges:** ${cy?.edges().length || 0}

*Full report will include detailed analysis...*`;
        }

        function generatePRCommentPreview() {
            return `## 🔍 Code Analysis Summary

### 📊 Metrics
| Metric | Value | Change |
|--------|-------|--------|
| Functions | ${currentAnalysis?.functions?.length || 0} | +0 |
| Complexity | ${currentAnalysis?.complexity || 0} | +0 |

### 🎯 Key Insights
- ${tourSteps.length} tour steps created
- ${tourSteps.filter(s => s.completed).length} completed
- ${tourSteps.filter(s => s.bookmarked).length} bookmarked

### 📈 Recommendations
- Review high-complexity functions
- Complete understanding tour
- Consider refactoring opportunities

---
*Generated by Understand First*`;
        }

        function previewExport() {
            if (!selectedExportFormat) {
                showError('Please select an export format first.');
                return;
            }
            
            showExportModal();
        }

        function showExportModal() {
            const modal = document.createElement('div');
            modal.className = 'export-modal';
            modal.innerHTML = `
                <div class="export-modal-content">
                    <div class="export-modal-header">
                        <h3>Export Preview</h3>
                        <button onclick="closeExportModal()" class="close-modal-btn">×</button>
                    </div>
                    <div class="export-preview">
                        ${getFullExportContent()}
                    </div>
                    <div class="export-actions">
                        <button onclick="copyExportContent()" class="copy-btn">📋 Copy</button>
                        <button onclick="downloadExport()" class="export-btn">📥 Download</button>
                        <button onclick="closeExportModal()" class="btn btn-sm">Close</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        function closeExportModal() {
            const modal = document.querySelector('.export-modal');
            if (modal) {
                document.body.removeChild(modal);
            }
        }

        function getFullExportContent() {
            if (!selectedExportFormat) return '';
            
            switch (selectedExportFormat) {
                case 'svg':
                    return cy ? cy.svg({ scale: 1, quality: 1 }) : '<svg>No graph available</svg>';
                case 'png':
                    return '<div>PNG export ready. Click download to save image.</div>';
                case 'json':
                    return generateFullJSONExport();
                case 'markdown':
                    return generateFullMarkdownExport();
                case 'pr-comment':
                    return generateFullPRComment();
                case 'bundle':
                    return generateFullBundleExport();
                default:
                    return 'Export content not available.';
            }
        }

        function generateFullJSONExport() {
            const exportData = {
                version: '1.0',
                timestamp: new Date().toISOString(),
                metadata: {
                    generatedBy: 'Understand First Web Demo',
                    format: 'json'
                },
                analysis: currentAnalysis,
                tour: {
                    steps: tourSteps,
                    currentStep: currentTourStep,
                    completedSteps: tourSteps.filter(s => s.completed).length,
                    bookmarkedSteps: tourSteps.filter(s => s.bookmarked).length
                },
                graph: cy ? cy.elements().jsons() : null,
                trace: currentAnalysis?.trace || null,
                metrics: {
                    totalFunctions: currentAnalysis?.functions?.length || 0,
                    totalModules: currentAnalysis?.modules?.length || 0,
                    averageComplexity: currentAnalysis?.complexity || 0
                }
            };
            
            return `<pre>${JSON.stringify(exportData, null, 2)}</pre>`;
        }

        function generateFullMarkdownExport() {
            const completedSteps = tourSteps.filter(s => s.completed).length;
            const bookmarkedSteps = tourSteps.filter(s => s.bookmarked).length;
            const estimatedTime = tourSteps.reduce((total, step) => total + (step.estimatedTime || 0), 0);
            
            return `<pre># Code Analysis Report

**Generated:** ${new Date().toLocaleDateString()}
**Analysis ID:** ${currentAnalysis?.id || 'N/A'}

## Executive Summary

This analysis covers ${currentAnalysis?.functions?.length || 0} functions across ${currentAnalysis?.modules?.length || 0} modules, with an overall complexity score of ${currentAnalysis?.complexity || 0}.

## Key Metrics

| Metric | Value | Description |
|--------|-------|-------------|
| Total Functions | ${currentAnalysis?.functions?.length || 0} | Number of analyzed functions |
| Total Modules | ${currentAnalysis?.modules?.length || 0} | Number of code modules |
| Complexity Score | ${currentAnalysis?.complexity || 0} | Overall system complexity |
| Graph Nodes | ${cy?.nodes().length || 0} | Functions in visualization |
| Graph Edges | ${cy?.edges().length || 0} | Relationships between functions |

## Understanding Tour

**Progress:** ${completedSteps}/${tourSteps.length} steps completed (${Math.round((completedSteps/tourSteps.length)*100)}%)
**Bookmarked Steps:** ${bookmarkedSteps}
**Estimated Time:** ~${estimatedTime} minutes

### Tour Steps

${tourSteps.map((step, index) => {
    const status = step.completed ? '✅' : (step.bookmarked ? '🔖' : '⏳');
    const timeInfo = step.estimatedTime ? ` *(${step.estimatedTime}min)*` : '';
    const focusInfo = step.focusNodes && step.focusNodes.length > 0 ? 
        `\n   **Focus:** ${step.focusNodes.join(', ')}` : '';
    return `${status} **${index + 1}. ${step.title}**${timeInfo}\n   ${step.description}${focusInfo}`;
}).join('\n\n')}

## Recommendations

1. **Complete Understanding Tour**: ${completedSteps < tourSteps.length ? `Complete remaining ${tourSteps.length - completedSteps} steps` : 'All steps completed! ✅'}
2. **Review Complex Functions**: Focus on functions with high complexity scores
3. **Analyze Dependencies**: Review the graph visualization for tight coupling
4. **Consider Refactoring**: Look for opportunities to reduce complexity

## Technical Details

### Analysis Configuration
- **Tool**: Understand First Web Demo
- **Version**: 1.0
- **Export Format**: Markdown
- **Include Graph**: ${document.getElementById('includeGraph')?.checked ? 'Yes' : 'No'}
- **Include Trace**: ${document.getElementById('includeTrace')?.checked ? 'Yes' : 'No'}

---
*Generated by Understand First - Web Demo*</pre>`;
        }

        function generateFullPRComment() {
            const completedSteps = tourSteps.filter(s => s.completed).length;
            const progress = Math.round((completedSteps/tourSteps.length)*100);
            
            return `<pre>## 🔍 Code Analysis Summary

### 📊 Impact Assessment

| Metric | Current | Change | Status |
|--------|---------|--------|--------|
| Functions | ${currentAnalysis?.functions?.length || 0} | +0 | ✅ |
| Complexity | ${currentAnalysis?.complexity || 0} | +0 | ✅ |
| Modules | ${currentAnalysis?.modules?.length || 0} | +0 | ✅ |

### 🎯 Understanding Progress

**Tour Completion:** ${completedSteps}/${tourSteps.length} steps (${progress}%)

${completedSteps < tourSteps.length ? 
`⚠️ **Action Required:** Complete remaining ${tourSteps.length - completedSteps} tour steps for full understanding` :
'✅ **Complete:** All understanding tour steps completed'}

### 📈 Key Insights

${tourSteps.filter(s => s.title.toLowerCase().includes('entry')).length > 0 ? 
`- **Entry Points:** ${tourSteps.filter(s => s.title.toLowerCase().includes('entry')).length} identified` : ''}
${tourSteps.filter(s => s.title.toLowerCase().includes('path')).length > 0 ? 
`- **Critical Paths:** ${tourSteps.filter(s => s.title.toLowerCase().includes('path')).length} analyzed` : ''}
${tourSteps.filter(s => s.title.toLowerCase().includes('depend')).length > 0 ? 
`- **Dependencies:** ${tourSteps.filter(s => s.title.toLowerCase().includes('depend')).length} mapped` : ''}

### 🔧 Recommendations

${currentAnalysis?.complexity > 7 ? 
'⚠️ **High Complexity Detected:** Consider refactoring complex functions' : 
'✅ **Complexity Acceptable:** Code complexity within reasonable bounds'}

${completedSteps < tourSteps.length ? 
'📚 **Complete Understanding Tour:** Finish remaining steps before making changes' : 
'✅ **Ready for Changes:** Understanding tour complete'}

### 📋 Checklist

- [ ] ${completedSteps >= tourSteps.length ? '✅' : '⏳'} Understanding tour completed
- [ ] ${currentAnalysis?.complexity <= 7 ? '✅' : '⚠️'} Complexity review passed
- [ ] ${cy?.nodes().length > 0 ? '✅' : '⏳'} Graph visualization analyzed
- [ ] ${tourSteps.filter(s => s.bookmarked).length > 0 ? '✅' : '⏳'} Key insights bookmarked

---
*Generated by [Understand First](https://github.com/understand-first) - Web Demo*</pre>`;
        }

        function generateFullBundleExport() {
            return `<pre>Bundle Export Contents:

📦 understanding-tour-${new Date().toISOString().split('T')[0]}.uftour
├── 📄 tour.json - Tour steps and progress
├── 📊 analysis.json - Complete analysis data  
├── 🗺️ graph.json - Graph visualization data
├── 📈 trace.json - Runtime trace data (if available)
├── 📋 metadata.json - Export metadata
└── 📖 README.md - Bundle documentation

Total Size: ~${Math.round(Math.random() * 500 + 100)}KB
Compatible with: Understand First CLI, VS Code Extension</pre>`;
        }

        function copyExportContent() {
            if (!selectedExportFormat) {
                showError('Please select an export format first.');
                return;
            }
            
            let content = '';
            
            switch (selectedExportFormat) {
                case 'svg':
                    content = cy ? cy.svg({ scale: 1, quality: 1 }) : '';
                    break;
                case 'json':
                    content = JSON.stringify(JSON.parse(document.querySelector('.export-preview pre')?.textContent || '{}'), null, 2);
                    break;
                case 'markdown':
                case 'pr-comment':
                case 'bundle':
                    content = document.querySelector('.export-preview pre')?.textContent || '';
                    break;
                case 'png':
                    showError('PNG content cannot be copied to clipboard. Use download instead.');
                    return;
            }
            
            navigator.clipboard.writeText(content).then(() => {
                showSuccess('Content copied to clipboard!');
            }).catch(() => {
                showError('Failed to copy content to clipboard.');
            });
        }

        function downloadExport() {
            if (!selectedExportFormat) {
                showError('Please select an export format first.');
                return;
            }
            
            let content = '';
            let filename = '';
            let mimeType = '';
            
            switch (selectedExportFormat) {
                case 'svg':
                    content = cy ? cy.svg({ scale: 1, quality: 1 }) : '';
                    filename = `graph-${new Date().toISOString().split('T')[0]}.svg`;
                    mimeType = 'image/svg+xml';
                    break;
                case 'png':
                    exportAsPNG();
                    return;
                case 'json':
                    const jsonData = JSON.parse(document.querySelector('.export-preview pre')?.textContent || '{}');
                    content = JSON.stringify(jsonData, null, 2);
                    filename = `analysis-${new Date().toISOString().split('T')[0]}.json`;
                    mimeType = 'application/json';
                    break;
                case 'markdown':
                    content = document.querySelector('.export-preview pre')?.textContent || '';
                    filename = `analysis-report-${new Date().toISOString().split('T')[0]}.md`;
                    mimeType = 'text/markdown';
                    break;
                case 'pr-comment':
                    content = document.querySelector('.export-preview pre')?.textContent || '';
                    filename = `pr-comment-${new Date().toISOString().split('T')[0]}.md`;
                    mimeType = 'text/markdown';
                    break;
                case 'bundle':
                    const bundleData = {
                        version: '1.0',
                        timestamp: new Date().toISOString(),
                        tour: tourSteps,
                        analysis: currentAnalysis,
                        graph: cy ? cy.elements().jsons() : [],
                        trace: currentAnalysis?.trace || null,
                        metadata: {
                            generatedBy: 'Understand First Web Demo',
                            format: 'uftour'
                        }
                    };
                    content = JSON.stringify(bundleData, null, 2);
                    filename = `understanding-tour-${new Date().toISOString().split('T')[0]}.uftour`;
                    mimeType = 'application/json';
                    break;
            }
            
            const blob = new Blob([content], { type: mimeType });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            a.click();
            URL.revokeObjectURL(url);
            
            showSuccess(`Downloaded: ${filename}`);
        }

        function generatePRComment() {
            const completedSteps = tourSteps.filter(s => s.completed);
            const bookmarkedSteps = tourSteps.filter(s => s.bookmarked);
            
            let comment = `## 📚 Understanding Tour Summary\n\n`;
            comment += `**Progress:** ${completedSteps.length}/${tourSteps.length} steps completed\n\n`;
            
            if (bookmarkedSteps.length > 0) {
                comment += `**Key Insights (${bookmarkedSteps.length} bookmarked):**\n`;
                bookmarkedSteps.forEach((step, index) => {
                    comment += `${index + 1}. ${step.title}: ${step.description}\n`;
                });
                comment += `\n`;
            }
            
            comment += `**Next Steps:**\n`;
            const remainingSteps = tourSteps.filter(s => !s.completed);
            if (remainingSteps.length > 0) {
                comment += `- Complete remaining ${remainingSteps.length} tour steps\n`;
            } else {
                comment += `- ✅ All tour steps completed!\n`;
            }
            
            comment += `- Review code changes with understanding context\n`;
            comment += `- Update documentation if needed\n\n`;
            
            comment += `*This tour helps achieve TTU ≤ 10 minutes by providing structured understanding.*\n`;
            
            copyToClipboard(comment);
            showSuccess('PR comment copied to clipboard!');
            
            trackMetric('pr_comment_generated', 'tour');
        }

        function goToTourStep(stepIndex) {
            currentTourStep = stepIndex;
            const step = tourSteps[stepIndex];
            
            if (step && step.focusNodes.length > 0) {
                // Highlight nodes in graph
                cy.elements().removeClass('highlighted');
                step.focusNodes.forEach(funcName => {
                    cy.nodes().filter(node => node.data('label') === funcName).addClass('highlighted');
                });
                
                // Center on highlighted nodes
                cy.fit(cy.nodes('.highlighted'));
            }
            
            renderTour();
        }

        function goToStep(stepIndex) {
            currentTourStep = stepIndex;
            const step = tourSteps[stepIndex];
            
            // Mark step as completed
            step.completed = true;
            
            // Focus on nodes
            if (step.focusNodes && step.focusNodes.length > 0) {
                cy.elements().removeClass('highlighted');
                step.focusNodes.forEach(nodeName => {
                    const node = cy.nodes().filter(n => n.data('label') === nodeName);
                    if (node.length > 0) {
                        node.addClass('highlighted');
                        cy.center(node);
                        cy.zoom(1.5);
                    }
                });
            }
            
            // Update UI
            updateTourProgress();
            renderTour();
        }

        function startTour() {
            currentTourStep = 0;
            goToStep(0);
        }

        function nextStep() {
            if (currentTourStep < tourSteps.length - 1) {
                goToStep(currentTourStep + 1);
            }
        }

        function previousStep() {
            if (currentTourStep > 0) {
                goToStep(currentTourStep - 1);
            }
        }

        function toggleBookmark(stepIndex) {
            tourSteps[stepIndex].bookmarked = !tourSteps[stepIndex].bookmarked;
            renderTour();
        }

        function updateTourProgress() {
            const progressFill = document.querySelector('.progress-fill');
            const progressText = document.querySelector('.progress-text');
            
            if (progressFill) {
                progressFill.style.width = `${(currentTourStep / tourSteps.length) * 100}%`;
            }
            
            if (progressText) {
                progressText.textContent = `${currentTourStep} / ${tourSteps.length}`;
            }
        }

        function exportTourMarkdown() {
            const markdown = generateTourMarkdown();
            const blob = new Blob([markdown], { type: 'text/markdown' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'understanding_tour.md';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        function generateTourMarkdown() {
            let markdown = `# Understanding Tour\n\n`;
            markdown += `Generated: ${new Date().toISOString()}\n\n`;
            markdown += `## Overview\n\n`;
            markdown += `This tour guides you through understanding the codebase structure and key concepts.\n\n`;
            
            tourSteps.forEach((step, index) => {
                markdown += `## ${step.title}\n\n`;
                markdown += `${step.description}\n\n`;
                
                if (step.focusNodes && step.focusNodes.length > 0) {
                    markdown += `**Focus Functions:** ${step.focusNodes.join(', ')}\n\n`;
                }
                
                if (step.codeRange) {
                    markdown += `**Code Range:** Lines ${step.codeRange.start}-${step.codeRange.end}\n\n`;
                }
                
                markdown += `---\n\n`;
            });
            
            markdown += `## Summary\n\n`;
            markdown += `- Total Steps: ${tourSteps.length}\n`;
            markdown += `- Completed Steps: ${tourSteps.filter(s => s.completed).length}\n`;
            markdown += `- Bookmarked Steps: ${tourSteps.filter(s => s.bookmarked).length}\n\n`;
            markdown += `*This tour was generated by Understand-First to help achieve TTU ≤ 10 minutes.*\n`;
            
            return markdown;
        }
        
        function performAdvancedAnalysis(code) {
            const lines = code.split('\n');
            const functions = [];
            const classes = [];
            const imports = [];
            let totalComplexity = 0;
            let sideEffects = new Set();
            
            // Analyze imports
            lines.forEach((line, index) => {
                const importMatch = line.match(/^(import|from)\s+(\w+)/);
                if (importMatch) {
                    imports.push({
                        type: importMatch[1],
                        module: importMatch[2],
                        line: index + 1
                    });
                }
            });
            
            // Analyze classes
            lines.forEach((line, index) => {
                const classMatch = line.match(/class\s+(\w+)/);
                if (classMatch) {
                    classes.push({
                        name: classMatch[1],
                        line: index + 1,
                        methods: []
                    });
                }
            });
            
            // Analyze functions
            lines.forEach((line, index) => {
                const funcMatch = line.match(/def\s+(\w+)\s*\(/);
                if (funcMatch) {
                    const funcName = funcMatch[1];
                    const complexity = calculateComplexity(lines, index);
                    const calls = findFunctionCalls(lines, index);
                    const funcSideEffects = findSideEffects(lines, index);
                    
                    funcSideEffects.forEach(effect => sideEffects.add(effect));
                    
                    functions.push({
                        name: funcName,
                        line: index + 1,
                        complexity: complexity,
                        calls: calls,
                        sideEffects: funcSideEffects,
                        isAsync: line.includes('async def'),
                        isClassMethod: line.includes('    def') || line.includes('\tdef')
                    });
                    
                    totalComplexity += complexity;
                }
            });
            
            return {
                functions: functions,
                classes: classes,
                imports: imports,
                totalLines: lines.length,
                totalComplexity: totalComplexity,
                sideEffects: Array.from(sideEffects),
                metrics: {
                    cyclomaticComplexity: totalComplexity,
                    functionCount: functions.length,
                    classCount: classes.length,
                    importCount: imports.length,
                    averageComplexity: functions.length > 0 ? totalComplexity / functions.length : 0
                }
            };
        }
        
        function calculateComplexity(lines, startIndex) {
            let complexity = 1; // Base complexity
            let braceLevel = 0;
            
            for (let i = startIndex; i < lines.length; i++) {
                const line = lines[i].trim();
                
                // Stop at next function/class definition
                if (i > startIndex && (line.startsWith('def ') || line.startsWith('class '))) {
                    break;
                }
                
                // Count control structures
                if (line.match(/\b(if|elif|while|for|except|with)\b/)) {
                    complexity++;
                }
                
                // Count logical operators
                const logicalOps = (line.match(/\b(and|or)\b/g) || []).length;
                complexity += logicalOps;
                
                // Count ternary operators
                const ternaryOps = (line.match(/\?\s*.*\s*:/g) || []).length;
                complexity += ternaryOps;
            }
            
            return Math.max(1, complexity);
        }
        
        function findFunctionCalls(lines, startIndex) {
            const calls = [];
            const functionName = lines[startIndex].match(/def\s+(\w+)/)[1];
            
            for (let i = startIndex; i < lines.length; i++) {
                const line = lines[i].trim();
                
                // Stop at next function/class definition
                if (i > startIndex && (line.startsWith('def ') || line.startsWith('class '))) {
                    break;
                }
                
                // Find function calls
                const callMatches = line.match(/(\w+)\s*\(/g);
                if (callMatches) {
                    callMatches.forEach(call => {
                        const callName = call.replace(/\s*\(/, '');
                        if (callName !== functionName && !['print', 'len', 'str', 'int', 'float', 'bool', 'list', 'dict', 'set', 'tuple'].includes(callName)) {
                            calls.push(callName);
                        }
                    });
                }
            }
            
            return [...new Set(calls)]; // Remove duplicates
        }
        
        function findSideEffects(lines, startIndex) {
            const sideEffects = [];
            
            for (let i = startIndex; i < lines.length; i++) {
                const line = lines[i].trim();
                
                // Stop at next function/class definition
                if (i > startIndex && (line.startsWith('def ') || line.startsWith('class '))) {
                    break;
                }
                
                // Check for side effects
                if (line.includes('print(') || line.includes('logger.')) {
                    sideEffects.push('logging');
                }
                if (line.includes('open(') || line.includes('write(') || line.includes('read(')) {
                    sideEffects.push('file_io');
                }
                if (line.includes('requests.') || line.includes('aiohttp.') || line.includes('urllib.')) {
                    sideEffects.push('network');
                }
                if (line.includes('database') || line.includes('db.') || line.includes('cursor.')) {
                    sideEffects.push('database');
                }
                if (line.includes('redis.') || line.includes('cache.')) {
                    sideEffects.push('cache');
                }
                if (line.includes('send_email') || line.includes('smtp')) {
                    sideEffects.push('email');
                }
            }
            
            return [...new Set(sideEffects)];
        }
        
        function displayAdvancedResults(analysis) {
            const results = document.getElementById('results');
            
            let html = `
                <div class="success">
                    <strong>Analysis Complete!</strong> Found ${analysis.functions.length} functions, ${analysis.classes.length} classes, and ${analysis.imports.length} imports in ${analysis.totalLines} lines of code.
                </div>
                
                <div class="analysis-tabs">
                    <div class="tab active" onclick="switchTab('overview')">Overview</div>
                    <div class="tab" onclick="switchTab('functions')">Functions</div>
                    <div class="tab" onclick="switchTab('classes')">Classes</div>
                    <div class="tab" onclick="switchTab('tour')">Understanding Tour</div>
                </div>
                
                <div id="overview" class="tab-content active">
                    <div class="metrics-grid">
                        <div class="metric-card">
                            <div class="metric-value">${analysis.metrics.functionCount}</div>
                            <div class="metric-label">Functions</div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-value">${analysis.metrics.classCount}</div>
                            <div class="metric-label">Classes</div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-value">${analysis.metrics.cyclomaticComplexity}</div>
                            <div class="metric-label">Total Complexity</div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-value">${analysis.metrics.averageComplexity.toFixed(1)}</div>
                            <div class="metric-label">Avg Complexity</div>
                        </div>
                    </div>
                    
                    ${analysis.sideEffects.length > 0 ? `
                        <div class="side-effects">
                            <h4>Side Effects Detected</h4>
                            ${analysis.sideEffects.map(effect => `<span class="side-effect-tag">${effect}</span>`).join('')}
                        </div>
                    ` : ''}
                    
                    <div class="call-graph">
                        <h3>Call Graph</h3>
                        <div id="callGraphContent">
                            ${generateCallGraph(analysis.functions)}
                        </div>
                    </div>
                </div>
                
                <div id="functions" class="tab-content">
                    <h3>Function Analysis</h3>
                    ${analysis.functions.map(func => generateFunctionCard(func)).join('')}
                </div>
                
                <div id="classes" class="tab-content">
                    <h3>Class Analysis</h3>
                    ${analysis.classes.length > 0 ? 
                        analysis.classes.map(cls => generateClassCard(cls, analysis.functions)).join('') :
                        '<p>No classes found in the code.</p>'
                    }
                </div>
                
                <div id="tour" class="tab-content">
                    <div class="tour-section">
                        <h3>Generated Understanding Tour</h3>
                        <p>Here's how Understand-First would guide a developer through this code:</p>
                        ${generateUnderstandingTour(analysis)}
                    </div>
                </div>
                
                <div class="export-options">
                    <button class="export-btn primary" onclick="exportAnalysis('json')">Export JSON</button>
                    <button class="export-btn" onclick="exportAnalysis('markdown')">Export Markdown</button>
                    <button class="export-btn" onclick="exportAnalysis('tour')">Export Tour</button>
                    <button class="export-btn" onclick="exportAnalysis('svg')">Export SVG</button>
                    <button class="export-btn" onclick="exportAnalysis('png')">Export PNG</button>
                    <button class="export-btn" onclick="exportAnalysis('pr')">PR Snippet</button>
                </div>
            `;
            
            results.innerHTML = html;
        }
        
        function generateCallGraph(functions) {
            if (functions.length === 0) return '<p>No function calls detected.</p>';
            
            let graph = '';
            functions.forEach(func => {
                if (func.calls.length > 0) {
                    graph += `<div class="graph-node">${func.name}</div>`;
                    func.calls.forEach(call => {
                        graph += `<span class="graph-edge">→</span><div class="graph-node">${call}</div>`;
                    });
                    graph += '<br>';
                }
            });
            
            return graph || '<p>No function call relationships detected.</p>';
        }
        
        function generateFunctionCard(func) {
            const complexityClass = func.complexity <= 3 ? 'low' : func.complexity <= 6 ? 'medium' : 'high';
            const complexityText = func.complexity <= 3 ? 'Low' : func.complexity <= 6 ? 'Medium' : 'High';
            
            return `
                <div class="function-item">
                    <div class="function-name">
                        <span class="complexity-indicator ${complexityClass}"></span>
                        ${func.name}() 
                        <span class="complexity ${complexityClass}">${complexityText} Complexity</span>
                        ${func.isAsync ? '<span style="color: #495057; font-size: 12px;">[async]</span>' : ''}
                        ${func.isClassMethod ? '<span style="color: #17a2b8; font-size: 12px;">[method]</span>' : ''}
                    </div>
                    <div class="function-details">
                        <strong>Line:</strong> ${func.line} | 
                        <strong>Calls:</strong> ${func.calls.length > 0 ? func.calls.join(', ') : 'None'} |
                        <strong>Side Effects:</strong> ${func.sideEffects.length > 0 ? func.sideEffects.join(', ') : 'None'}
                    </div>
                </div>
            `;
        }
        
        function generateClassCard(cls, functions) {
            const classMethods = functions.filter(func => func.isClassMethod);
            
            return `
                <div class="function-item">
                    <div class="function-name">
                        <span class="complexity-indicator medium"></span>
                        ${cls.name} (Class)
                    </div>
                    <div class="function-details">
                        <strong>Line:</strong> ${cls.line} | 
                        <strong>Methods:</strong> ${classMethods.length}
                        ${classMethods.length > 0 ? `(${classMethods.map(m => m.name).join(', ')})` : ''}
                    </div>
                </div>
            `;
        }
        
        function generateUnderstandingTour(analysis) {
            let tour = '';
            let step = 1;
            
            // Entry point analysis
            const entryPoints = analysis.functions.filter(f => f.calls.length === 0 || f.name.toLowerCase().includes('main'));
            if (entryPoints.length > 0) {
                tour += `
                    <div class="tour-step">
                        <h4>Step ${step++}: Entry Point Analysis</h4>
                        <p>Start with the main function <code>${entryPoints[0].name}()</code> - this appears to be the primary entry point.</p>
                        <div class="code-snippet">def ${entryPoints[0].name}():</div>
                    </div>
                `;
            }
            
            // Function dependencies
            if (analysis.functions.length > 1) {
                tour += `
                    <div class="tour-step">
                        <h4>Step ${step++}: Function Dependencies</h4>
                        <p>Follow the call chain through the codebase:</p>
                        <div class="code-snippet">${generateCallChain(analysis.functions)}</div>
                    </div>
                `;
            }
            
            // Side effects
            if (analysis.sideEffects.length > 0) {
                tour += `
                    <div class="tour-step">
                        <h4>Step ${step++}: Side Effects Analysis</h4>
                        <p>Identify potential side effects: ${analysis.sideEffects.join(', ')} operations detected.</p>
                        <div class="side-effects">
                            <h4>Side Effects Found</h4>
                            ${analysis.sideEffects.map(effect => `<span class="side-effect-tag">${effect}</span>`).join('')}
                        </div>
                    </div>
                `;
            }
            
            // Complexity assessment
            const highComplexity = analysis.functions.filter(f => f.complexity > 6);
            if (highComplexity.length > 0) {
                tour += `
                    <div class="tour-step">
                        <h4>Step ${step++}: Complexity Assessment</h4>
                        <p>Functions with high complexity may need refactoring: ${highComplexity.map(f => f.name).join(', ')}</p>
                    </div>
                `;
            }
            
            // Best practices
            tour += `
                <div class="tour-step">
                    <h4>Step ${step++}: Best Practices</h4>
                    <p>Consider these improvements:</p>
                    <ul>
                        <li>Add type hints for better code documentation</li>
                        <li>Include docstrings for complex functions</li>
                        <li>Consider breaking down high-complexity functions</li>
                        <li>Add error handling for side effects</li>
                    </ul>
                </div>
            `;
            
            return tour;
        }
        
        function generateCallChain(functions) {
            const chains = [];
            functions.forEach(func => {
                if (func.calls.length > 0) {
                    chains.push(`${func.name}() → ${func.calls.join(', ')}()`);
                }
            });
            return chains.join('\n') || 'No call chains detected';
        }
        
        function switchTab(tabName) {
            // Hide all tab contents
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            
            // Remove active class from all tabs
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Show selected tab content
            document.getElementById(tabName).classList.add('active');
            
            // Add active class to clicked tab
            event.target.classList.add('active');
        }
        
        function exportAnalysis(format) {
            if (!currentAnalysis) return;
            
            let content = '';
            let filename = '';
            let mimeType = '';
            
            switch (format) {
                case 'json':
                    content = JSON.stringify(currentAnalysis, null, 2);
                    filename = 'analysis.json';
                    mimeType = 'application/json';
                    break;
                case 'markdown':
                    content = generateMarkdownReport(currentAnalysis);
                    filename = 'analysis.md';
                    mimeType = 'text/markdown';
                    break;
                case 'tour':
                    content = generateTourMarkdown(currentAnalysis);
                    filename = 'understanding_tour.md';
                    mimeType = 'text/markdown';
                    break;
                case 'svg':
                    content = generateSVGExport();
                    filename = 'code_map.svg';
                    mimeType = 'image/svg+xml';
                    break;
                case 'png':
                    exportAsPNG();
                    return;
                case 'pr':
                    content = generatePRCommentSnippet(currentAnalysis);
                    navigator.clipboard.writeText(content);
                    showSuccess('PR snippet copied to clipboard!');
                    return;
            }
            
            if (content) {
                const blob = new Blob([content], { type: mimeType });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            }
        }
        
        function exportAsPNG() {
            const canvas = document.getElementById('cy');
            if (!canvas) return;
            
            // Create a temporary canvas for export
            const tempCanvas = document.createElement('canvas');
            const ctx = tempCanvas.getContext('2d');
            
            // Set canvas size to match the graph
            const rect = canvas.getBoundingClientRect();
            tempCanvas.width = rect.width;
            tempCanvas.height = rect.height;
            
            // Draw the graph to the temporary canvas
            const imageData = ctx.getImageData(0, 0, rect.width, rect.height);
            ctx.putImageData(imageData, 0, 0);
            
            // Convert to PNG and download
            tempCanvas.toBlob((blob) => {
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'code_map.png';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            }, 'image/png');
        }
        
        function generateMarkdownReport(analysis) {
            return `# Code Analysis Report

## Overview
- **Functions:** ${analysis.metrics.functionCount}
- **Classes:** ${analysis.metrics.classCount}
- **Total Lines:** ${analysis.totalLines}
- **Cyclomatic Complexity:** ${analysis.metrics.cyclomaticComplexity}
- **Average Complexity:** ${analysis.metrics.averageComplexity.toFixed(1)}

## Functions
${analysis.functions.map(func => `### ${func.name}()
- **Line:** ${func.line}
- **Complexity:** ${func.complexity}
- **Calls:** ${func.calls.join(', ') || 'None'}
- **Side Effects:** ${func.sideEffects.join(', ') || 'None'}

`).join('')}

## Classes
${analysis.classes.map(cls => `### ${cls.name}
- **Line:** ${cls.line}
- **Methods:** ${analysis.functions.filter(f => f.isClassMethod).length}

`).join('')}
`;
        }
        
        function generateTourMarkdown(analysis) {
            return `# Understanding Tour

${generateUnderstandingTour(analysis).replace(/<[^>]*>/g, '').replace(/&lt;/g, '<').replace(/&gt;/g, '>')}
`;
        }
        
        function showError(message) {
            const results = document.getElementById('results');
            results.innerHTML = `<div class="error">${message}</div>`;
        }

        // Enhanced feature functions
        function toggleShortcutsHelp() {
            const help = document.getElementById('shortcutsHelp');
            help.style.display = help.style.display === 'none' ? 'block' : 'none';
        }

        // Enhanced trace overlay functionality
        function animateHotPath(nodes) {
            nodes.forEach(node => {
                node.animate({
                    style: {
                        'background-color': '#f39c12',
                        'border-color': '#e67e22'
                    }
                }, {
                    duration: 1000,
                    complete: () => {
                        node.animate({
                            style: {
                                'background-color': '#495057',
                                'border-color': '#6c757d'
                            }
                        }, { duration: 500 });
                    }
                });
            });
        }

        function showTraceConflicts() {
            // Show static vs runtime conflicts
            const conflicts = cy.elements().filter(element => {
                const data = element.data();
                return data.staticPath && !data.runtimePath;
            });
            
            conflicts.addClass('conflict-badge');
            
            // Show conflict notification
            const conflictNotification = document.getElementById('conflictNotification');
            if (conflictNotification) {
                conflictNotification.innerHTML = `
                    <div class="conflict-alert">
                        <span class="conflict-icon">⚠️</span>
                        <span>Found ${conflicts.length} static/runtime path conflicts</span>
                    </div>
                `;
                conflictNotification.style.display = 'block';
            }
        }

        function hideTraceConflicts() {
            cy.elements().removeClass('conflict-badge');
            const conflictNotification = document.getElementById('conflictNotification');
            if (conflictNotification) {
                conflictNotification.style.display = 'none';
            }
        }

        function toggleStaticRuntime() {
            const toggle = document.getElementById('staticRuntimeToggle');
            const isStatic = toggle.checked;
            
            if (isStatic) {
                // Show only static analysis paths
                cy.elements().removeClass('trace-path runtime-path');
                cy.elements().addClass('static-path');
            } else {
                // Show runtime trace paths
                cy.elements().removeClass('static-path');
                if (traceOverlay) {
                    showTraceOverlay();
                }
            }
        }

        function showTraceBreadcrumb() {
            const breadcrumb = document.getElementById('traceBreadcrumb');
            if (breadcrumb && currentAnalysis && currentAnalysis.traceData) {
                const recentCalls = currentAnalysis.traceData
                    .filter(trace => trace.callCount > 5)
                    .slice(-10)
                    .map(trace => {
                        const edge = cy.getElementById(trace.edgeId);
                        return edge.data('source') + ' → ' + edge.data('target');
                    });
                
                breadcrumb.innerHTML = `
                    <h4>Recent Hot Path Calls</h4>
                    <div class="breadcrumb-list">
                        ${recentCalls.map(call => `<span class="breadcrumb-item">${call}</span>`).join('')}
                    </div>
                `;
                breadcrumb.style.display = 'block';
            }
        }

        function showTraceConflicts() {
            // Simulate conflict detection between static and runtime analysis
            const conflicts = cy.nodes().filter(node => {
                const data = node.data();
                return data.complexity > 5 && !data.runtime_hit;
            });
            
            if (conflicts.length > 0) {
                conflicts.addClass('conflict');
                showConflictBadge(conflicts.length);
            }
        }

        function hideTraceConflicts() {
            cy.elements().removeClass('conflict');
            hideConflictBadge();
        }

        function showConflictBadge(count) {
            let badge = document.getElementById('conflictBadge');
            if (!badge) {
                badge = document.createElement('div');
                badge.id = 'conflictBadge';
                badge.className = 'conflict-badge';
                badge.innerHTML = `⚠️ ${count} static/runtime conflicts detected`;
                document.querySelector('.pane-header').appendChild(badge);
            }
            badge.style.display = 'block';
        }

        function hideConflictBadge() {
            const badge = document.getElementById('conflictBadge');
            if (badge) {
                badge.style.display = 'none';
            }
        }

        // Enhanced lens and filter functionality
        function showLensPanel() {
            let panel = document.getElementById('lensPanel');
            if (!panel) {
                panel = document.createElement('div');
                panel.id = 'lensPanel';
                panel.className = 'lens-panel';
                panel.innerHTML = `
                    <div class="lens-header">
                        <h4>🔍 Understanding Lens</h4>
                        <button onclick="hideLensPanel()" class="close-btn">×</button>
                    </div>
                    <div class="lens-content">
                        <div class="lens-presets">
                            <h5>Quick Presets</h5>
                            <div class="preset-buttons">
                                <button onclick="applyPreset('hot-path')" class="preset-btn">🔥 Hot Path</button>
                                <button onclick="applyPreset('side-effects')" class="preset-btn">⚠️ Side Effects</button>
                                <button onclick="applyPreset('complexity')" class="preset-btn">🧩 High Complexity</button>
                                <button onclick="applyPreset('entry-points')" class="preset-btn">🚪 Entry Points</button>
                            </div>
                        </div>
                        
                        <div class="lens-seeds">
                            <h5>Seed Functions</h5>
                            <div class="seed-input-container">
                                <input type="text" id="seedInput" placeholder="Enter function name..." class="seed-input">
                                <button onclick="addSeedFromInput()" class="add-seed-btn">+ Add</button>
                            </div>
                            <div id="lensSeeds" class="seeds-list"></div>
                        </div>
                        
                        <div class="lens-filters">
                            <h5>Advanced Filters</h5>
                            
                            <div class="filter-group">
                                <h6>Complexity</h6>
                                <div class="filter-controls">
                                    <input type="range" id="complexitySlider" min="0" max="10" value="5" class="slider">
                                    <span id="complexityValue">5+</span>
                                </div>
                            </div>
                            
                            <div class="filter-group">
                                <h6>Side Effects</h6>
                                <div class="filter-options">
                                    <label><input type="checkbox" id="filterFileIO"> File I/O</label>
                                    <label><input type="checkbox" id="filterNetwork"> Network</label>
                                    <label><input type="checkbox" id="filterDatabase"> Database</label>
                                    <label><input type="checkbox" id="filterLogging"> Logging</label>
                                </div>
                            </div>
                            
                            <div class="filter-group">
                                <h6>Modules</h6>
                                <div class="module-filters">
                                    <input type="text" id="moduleFilter" placeholder="Filter by module..." class="module-input">
                                    <div id="moduleList" class="module-list"></div>
                                </div>
                            </div>
                            
                            <div class="filter-group">
                                <h6>Call Relationships</h6>
                                <div class="relationship-filters">
                                    <label><input type="checkbox" id="filterHighCallers"> High Callers (5+)</label>
                                    <label><input type="checkbox" id="filterHighCallees"> High Callees (5+)</label>
                                    <label><input type="checkbox" id="filterIsolated"> Isolated Functions</label>
                                </div>
                            </div>
                        </div>
                        
                        <div class="lens-preview">
                            <h5>Preview</h5>
                            <div id="lensPreview" class="preview-stats">
                                <div class="preview-stat">
                                    <span class="stat-label">Functions:</span>
                                    <span class="stat-value" id="previewFunctionCount">0</span>
                                </div>
                                <div class="preview-stat">
                                    <span class="stat-label">Modules:</span>
                                    <span class="stat-value" id="previewModuleCount">0</span>
                                </div>
                                <div class="preview-stat">
                                    <span class="stat-label">Avg Complexity:</span>
                                    <span class="stat-value" id="previewAvgComplexity">0</span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="lens-actions">
                            <button onclick="applyLens()" class="apply-lens-btn">Apply Lens</button>
                            <button onclick="resetLens()" class="reset-lens-btn">Reset</button>
                            <button onclick="saveLensPreset()" class="save-preset-btn">Save Preset</button>
                            <button onclick="loadLensPreset()" class="load-preset-btn">Load Preset</button>
                        </div>
                        
                        <div class="lens-url">
                            <h6>Share Lens</h6>
                            <div class="url-container">
                                <input type="text" id="lensUrl" readonly class="url-input">
                                <button onclick="copyLensUrl()" class="copy-url-btn">📋</button>
                            </div>
                        </div>
                    </div>
                `;
                document.querySelector('.pane').appendChild(panel);
            }
            panel.style.display = 'block';
            updateLensSeeds();
            updateLensPreview();
            updateLensUrl();
            setupLensEventListeners();
        }

        function setupLensEventListeners() {
            // Complexity slider
            const complexitySlider = document.getElementById('complexitySlider');
            if (complexitySlider) {
                complexitySlider.addEventListener('input', function() {
                    document.getElementById('complexityValue').textContent = this.value + '+';
                    updateLensPreview();
                });
            }

            // Filter checkboxes
            const filterCheckboxes = document.querySelectorAll('.lens-filters input[type="checkbox"]');
            filterCheckboxes.forEach(checkbox => {
                checkbox.addEventListener('change', updateLensPreview);
            });

            // Module filter input
            const moduleFilter = document.getElementById('moduleFilter');
            if (moduleFilter) {
                moduleFilter.addEventListener('input', function() {
                    filterModules(this.value);
                });
            }

            // Seed input
            const seedInput = document.getElementById('seedInput');
            if (seedInput) {
                seedInput.addEventListener('keydown', function(e) {
                    if (e.key === 'Enter') {
                        addSeedFromInput();
                    }
                });
            }
        }

        function applyPreset(presetName) {
            // Reset current filters
            resetLens();
            
            switch(presetName) {
                case 'hot-path':
                    document.getElementById('filterHighCallers').checked = true;
                    document.getElementById('filterHighCallees').checked = true;
                    break;
                case 'side-effects':
                    document.getElementById('filterFileIO').checked = true;
                    document.getElementById('filterNetwork').checked = true;
                    document.getElementById('filterDatabase').checked = true;
                    break;
                case 'complexity':
                    document.getElementById('complexitySlider').value = 7;
                    document.getElementById('complexityValue').textContent = '7+';
                    break;
                case 'entry-points':
                    // Add main functions as seeds
                    if (currentAnalysis && currentAnalysis.functions) {
                        const mainFunctions = Object.keys(currentAnalysis.functions).filter(name => 
                            name.toLowerCase().includes('main') || 
                            name.toLowerCase().includes('entry') ||
                            name.toLowerCase().includes('start')
                        );
                        mainFunctions.forEach(func => addSeedFunction(func));
                    }
                    break;
            }
            
            updateLensPreview();
            applyLens();
            
            trackMetric('lens_preset_applied', presetName);
        }

        function addSeedFromInput() {
            const seedInput = document.getElementById('seedInput');
            const functionName = seedInput.value.trim();
            
            if (functionName) {
                addSeedFunction(functionName);
                seedInput.value = '';
            }
        }

        function addSeedFunction(functionName) {
            if (!currentAnalysis) return;
            
            if (!currentAnalysis.seeds) {
                currentAnalysis.seeds = [];
            }
            
            if (!currentAnalysis.seeds.includes(functionName)) {
                currentAnalysis.seeds.push(functionName);
                updateLensSeeds();
                updateLensPreview();
            }
        }

        function updateLensSeeds() {
            const seedsContainer = document.getElementById('lensSeeds');
            if (!seedsContainer || !currentAnalysis) return;
            
            const seeds = currentAnalysis.seeds || [];
            seedsContainer.innerHTML = seeds.map(seed => `
                <div class="seed-item">
                    <span class="seed-name">${seed}</span>
                    <button onclick="removeSeed('${seed}')" class="remove-seed-btn" title="Remove seed">×</button>
                </div>
            `).join('');
        }

        function removeSeed(seed) {
            if (currentAnalysis && currentAnalysis.seeds) {
                currentAnalysis.seeds = currentAnalysis.seeds.filter(s => s !== seed);
                updateLensSeeds();
                updateLensPreview();
            }
        }

        function updateLensPreview() {
            if (!currentAnalysis) return;
            
            const previewData = calculateLensPreview();
            
            document.getElementById('previewFunctionCount').textContent = previewData.functionCount;
            document.getElementById('previewModuleCount').textContent = previewData.moduleCount;
            document.getElementById('previewAvgComplexity').textContent = previewData.avgComplexity.toFixed(1);
        }

        function calculateLensPreview() {
            if (!currentAnalysis || !currentAnalysis.functions) {
                return { functionCount: 0, moduleCount: 0, avgComplexity: 0 };
            }
            
            const functions = Object.values(currentAnalysis.functions);
            let filteredFunctions = functions;
            
            // Apply complexity filter
            const complexityThreshold = parseInt(document.getElementById('complexitySlider').value);
            filteredFunctions = filteredFunctions.filter(f => f.complexity >= complexityThreshold);
            
            // Apply side effect filters
            const sideEffectFilters = {
                fileIO: document.getElementById('filterFileIO').checked,
                network: document.getElementById('filterNetwork').checked,
                database: document.getElementById('filterDatabase').checked,
                logging: document.getElementById('filterLogging').checked
            };
            
            if (Object.values(sideEffectFilters).some(f => f)) {
                filteredFunctions = filteredFunctions.filter(f => {
                    const sideEffects = f.sideEffects || [];
                    return sideEffectFilters.fileIO && sideEffects.includes('file') ||
                           sideEffectFilters.network && sideEffects.includes('network') ||
                           sideEffectFilters.database && sideEffects.includes('database') ||
                           sideEffectFilters.logging && sideEffects.includes('logging');
                });
            }
            
            // Apply relationship filters
            if (document.getElementById('filterHighCallers').checked) {
                filteredFunctions = filteredFunctions.filter(f => f.callers && f.callers.length >= 5);
            }
            
            if (document.getElementById('filterHighCallees').checked) {
                filteredFunctions = filteredFunctions.filter(f => f.calls && f.calls.length >= 5);
            }
            
            if (document.getElementById('filterIsolated').checked) {
                filteredFunctions = filteredFunctions.filter(f => 
                    (!f.callers || f.callers.length === 0) && 
                    (!f.calls || f.calls.length === 0)
                );
            }
            
            // Calculate metrics
            const modules = new Set(filteredFunctions.map(f => f.module || 'unknown'));
            const avgComplexity = filteredFunctions.length > 0 
                ? filteredFunctions.reduce((sum, f) => sum + (f.complexity || 0), 0) / filteredFunctions.length 
                : 0;
            
            return {
                functionCount: filteredFunctions.length,
                moduleCount: modules.size,
                avgComplexity: avgComplexity
            };
        }

        function applyLens() {
            if (!currentAnalysis || !cy) return;
            
            const previewData = calculateLensPreview();
            
            // Clear existing highlights
            cy.elements().removeClass('lens-highlighted');
            
            // Apply lens highlighting based on current filters
            const functions = Object.values(currentAnalysis.functions);
            const complexityThreshold = parseInt(document.getElementById('complexitySlider').value);
            
            functions.forEach(func => {
                const node = cy.nodes().filter(`[label = "${func.name}"]`);
                if (node.length > 0 && shouldHighlightFunction(func)) {
                    node.addClass('lens-highlighted');
                }
            });
            
            // Update URL with lens state
            updateLensUrl();
            
            showNotification(`Lens applied: ${previewData.functionCount} functions highlighted`, 'success');
            trackMetric('lens_applied', 'custom');
        }

        function shouldHighlightFunction(func) {
            // Check complexity
            const complexityThreshold = parseInt(document.getElementById('complexitySlider').value);
            if (func.complexity < complexityThreshold) return false;
            
            // Check side effects
            const sideEffectFilters = {
                fileIO: document.getElementById('filterFileIO').checked,
                network: document.getElementById('filterNetwork').checked,
                database: document.getElementById('filterDatabase').checked,
                logging: document.getElementById('filterLogging').checked
            };
            
            if (Object.values(sideEffectFilters).some(f => f)) {
                const sideEffects = func.sideEffects || [];
                const hasMatchingSideEffect = sideEffectFilters.fileIO && sideEffects.includes('file') ||
                                           sideEffectFilters.network && sideEffects.includes('network') ||
                                           sideEffectFilters.database && sideEffects.includes('database') ||
                                           sideEffectFilters.logging && sideEffects.includes('logging');
                if (!hasMatchingSideEffect) return false;
            }
            
            // Check relationships
            if (document.getElementById('filterHighCallers').checked && 
                (!func.callers || func.callers.length < 5)) return false;
            
            if (document.getElementById('filterHighCallees').checked && 
                (!func.calls || func.calls.length < 5)) return false;
            
            if (document.getElementById('filterIsolated').checked && 
                ((func.callers && func.callers.length > 0) || (func.calls && func.calls.length > 0))) return false;
            
            return true;
        }

        function resetLens() {
            // Reset all filters
            document.getElementById('complexitySlider').value = 0;
            document.getElementById('complexityValue').textContent = '0+';
            
            const checkboxes = document.querySelectorAll('.lens-filters input[type="checkbox"]');
            checkboxes.forEach(checkbox => checkbox.checked = false);
            
            document.getElementById('moduleFilter').value = '';
            
            // Clear seeds
            if (currentAnalysis) {
                currentAnalysis.seeds = [];
                updateLensSeeds();
            }
            
            // Clear highlights
            if (cy) {
                cy.elements().removeClass('lens-highlighted');
            }
            
            updateLensPreview();
            updateLensUrl();
            
            trackMetric('lens_reset', 'all');
        }

        function saveLensPreset() {
            const presetName = prompt('Enter preset name:');
            if (!presetName) return;
            
            const preset = {
                name: presetName,
                timestamp: new Date().toISOString(),
                seeds: currentAnalysis ? (currentAnalysis.seeds || []) : [],
                filters: {
                    complexity: parseInt(document.getElementById('complexitySlider').value),
                    sideEffects: {
                        fileIO: document.getElementById('filterFileIO').checked,
                        network: document.getElementById('filterNetwork').checked,
                        database: document.getElementById('filterDatabase').checked,
                        logging: document.getElementById('filterLogging').checked
                    },
                    relationships: {
                        highCallers: document.getElementById('filterHighCallers').checked,
                        highCallees: document.getElementById('filterHighCallees').checked,
                        isolated: document.getElementById('filterIsolated').checked
                    }
                }
            };
            
            // Save to localStorage
            const presets = JSON.parse(localStorage.getItem('uf-lens-presets') || '[]');
            presets.push(preset);
            localStorage.setItem('uf-lens-presets', JSON.stringify(presets));
            
            showNotification(`Preset "${presetName}" saved`, 'success');
            trackMetric('lens_preset_saved', presetName);
        }

        function loadLensPreset() {
            const presets = JSON.parse(localStorage.getItem('uf-lens-presets') || '[]');
            if (presets.length === 0) {
                showNotification('No saved presets found', 'warning');
                return;
            }
            
            // Create preset selection modal
            const modal = document.createElement('div');
            modal.className = 'modal-overlay';
            modal.innerHTML = `
                <div class="modal-content">
                    <div class="modal-header">
                        <h3>Load Lens Preset</h3>
                        <button onclick="closeModal()" class="close-btn">×</button>
                    </div>
                    <div class="modal-body">
                        <div class="preset-list">
                            ${presets.map((preset, index) => `
                                <div class="preset-item" onclick="loadPreset(${index})">
                                    <div class="preset-info">
                                        <h4>${preset.name}</h4>
                                        <p>Saved: ${new Date(preset.timestamp).toLocaleDateString()}</p>
                                    </div>
                                    <button onclick="event.stopPropagation(); deletePreset(${index})" class="delete-preset-btn">🗑️</button>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        }

        function loadPreset(index) {
            const presets = JSON.parse(localStorage.getItem('uf-lens-presets') || '[]');
            const preset = presets[index];
            
            if (!preset) return;
            
            // Apply preset
            resetLens();
            
            // Set seeds
            if (currentAnalysis) {
                currentAnalysis.seeds = preset.seeds || [];
                updateLensSeeds();
            }
            
            // Set filters
            document.getElementById('complexitySlider').value = preset.filters.complexity || 0;
            document.getElementById('complexityValue').textContent = (preset.filters.complexity || 0) + '+';
            
            if (preset.filters.sideEffects) {
                document.getElementById('filterFileIO').checked = preset.filters.sideEffects.fileIO || false;
                document.getElementById('filterNetwork').checked = preset.filters.sideEffects.network || false;
                document.getElementById('filterDatabase').checked = preset.filters.sideEffects.database || false;
                document.getElementById('filterLogging').checked = preset.filters.sideEffects.logging || false;
            }
            
            if (preset.filters.relationships) {
                document.getElementById('filterHighCallers').checked = preset.filters.relationships.highCallers || false;
                document.getElementById('filterHighCallees').checked = preset.filters.relationships.highCallees || false;
                document.getElementById('filterIsolated').checked = preset.filters.relationships.isolated || false;
            }
            
            updateLensPreview();
            closeModal();
            
            showNotification(`Preset "${preset.name}" loaded`, 'success');
            trackMetric('lens_preset_loaded', preset.name);
        }

        function deletePreset(index) {
            if (!confirm('Delete this preset?')) return;
            
            const presets = JSON.parse(localStorage.getItem('uf-lens-presets') || '[]');
            presets.splice(index, 1);
            localStorage.setItem('uf-lens-presets', JSON.stringify(presets));
            
            // Refresh modal
            closeModal();
            loadLensPreset();
            
            trackMetric('lens_preset_deleted', 'custom');
        }

        function updateLensUrl() {
            const url = new URL(window.location);
            const lensState = {
                seeds: currentAnalysis ? (currentAnalysis.seeds || []) : [],
                complexity: parseInt(document.getElementById('complexitySlider').value),
                filters: {
                    fileIO: document.getElementById('filterFileIO').checked,
                    network: document.getElementById('filterNetwork').checked,
                    database: document.getElementById('filterDatabase').checked,
                    logging: document.getElementById('filterLogging').checked,
                    highCallers: document.getElementById('filterHighCallers').checked,
                    highCallees: document.getElementById('filterHighCallees').checked,
                    isolated: document.getElementById('filterIsolated').checked
                }
            };
            
            url.hash = `#lens=${encodeURIComponent(JSON.stringify(lensState))}`;
            document.getElementById('lensUrl').value = url.toString();
        }

        function copyLensUrl() {
            const urlInput = document.getElementById('lensUrl');
            urlInput.select();
            document.execCommand('copy');
            showNotification('Lens URL copied to clipboard', 'success');
            trackMetric('lens_url_copied', 'clipboard');
        }

        function hideLensPanel() {
            const panel = document.getElementById('lensPanel');
            if (panel) {
                panel.style.display = 'none';
            }
        }

        function updateLensSeeds() {
            const seedsContainer = document.getElementById('lensSeeds');
            if (!seedsContainer) return;
            
            const seeds = currentAnalysis ? Object.keys(currentAnalysis.functions).slice(0, 5) : [];
            seedsContainer.innerHTML = seeds.map(seed => `
                <div class="seed-item">
                    <span>${seed}</span>
                    <button onclick="removeSeed('${seed}')" class="remove-seed-btn">×</button>
                </div>
            `).join('');
        }

        function addSeedFunction() {
            const functionName = prompt('Enter function name to add as seed:');
            if (functionName && currentAnalysis) {
                // Add to current analysis seeds
                if (!currentAnalysis.seeds) {
                    currentAnalysis.seeds = [];
                }
                if (!currentAnalysis.seeds.includes(functionName)) {
                    currentAnalysis.seeds.push(functionName);
                    updateLensSeeds();
                }
            }
        }

        function removeSeed(seed) {
            if (currentAnalysis && currentAnalysis.seeds) {
                currentAnalysis.seeds = currentAnalysis.seeds.filter(s => s !== seed);
                updateLensSeeds();
            }
        }

        function saveLens() {
            if (!currentAnalysis) return;
            
            const lensData = {
                seeds: currentAnalysis.seeds || [],
                filters: {
                    complexity: document.getElementById('filterComplexity').checked,
                    sideEffects: document.getElementById('filterSideEffects').checked,
                    hotPath: document.getElementById('filterHotPath').checked
                },
                timestamp: new Date().toISOString()
            };
            
            const blob = new Blob([JSON.stringify(lensData, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'understanding-lens.json';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        function loadLens() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = (e) => {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        try {
                            const lensData = JSON.parse(e.target.result);
                            if (lensData.seeds) {
                                if (!currentAnalysis) currentAnalysis = {};
                                currentAnalysis.seeds = lensData.seeds;
                                updateLensSeeds();
                            }
                            if (lensData.filters) {
                                document.getElementById('filterComplexity').checked = lensData.filters.complexity || false;
                                document.getElementById('filterSideEffects').checked = lensData.filters.sideEffects || false;
                                document.getElementById('filterHotPath').checked = lensData.filters.hotPath || false;
                                applyFilters();
                            }
                        } catch (error) {
                            alert('Error loading lens file: ' + error.message);
                        }
                    };
                    reader.readAsText(file);
                }
            };
            input.click();
        }

        function generateSVGExport() {
            // Generate SVG representation of the current graph
            const nodes = cy.nodes();
            const edges = cy.edges();
            const bounds = cy.extent();
            
            let svg = `<svg width="800" height="600" viewBox="${bounds.x1} ${bounds.y1} ${bounds.x2 - bounds.x1} ${bounds.y2 - bounds.y1}" xmlns="http://www.w3.org/2000/svg">`;
            
            // Add edges
            edges.forEach(edge => {
                const source = edge.source();
                const target = edge.target();
                const sourcePos = source.position();
                const targetPos = target.position();
                
                svg += `<line x1="${sourcePos.x}" y1="${sourcePos.y}" x2="${targetPos.x}" y2="${targetPos.y}" stroke="#495057" stroke-width="2" marker-end="url(#arrowhead)"/>`;
            });
            
            // Add nodes
            nodes.forEach(node => {
                const pos = node.position();
                const data = node.data();
                const size = data.size || 30;
                
                svg += `<circle cx="${pos.x}" cy="${pos.y}" r="${size/2}" fill="#495057" stroke="#6c757d" stroke-width="2"/>`;
                svg += `<text x="${pos.x}" y="${pos.y + 5}" text-anchor="middle" fill="white" font-size="12" font-family="monospace">${data.label}</text>`;
            });
            
            // Add arrow marker
            svg += `<defs><marker id="arrowhead" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto"><polygon points="0 0, 10 3.5, 0 7" fill="#495057"/></marker></defs>`;
            
            svg += '</svg>';
            return svg;
        }

        function generatePRCommentSnippet(analysis) {
            const functions = analysis.functions || [];
            const addedCount = functions.length;
            const highComplexity = functions.filter(f => (f.complexity || 0) > 5).length;
            const sideEffects = functions.filter(f => (f.side_effects || []).length > 0).length;
            const hotPaths = functions.filter(f => f.hot_path).length;
            
            let snippet = `## 📊 Understanding Analysis\n\n`;
            snippet += `**Functions analyzed**: ${addedCount}\n`;
            snippet += `**High complexity**: ${highComplexity}\n`;
            snippet += `**With side effects**: ${sideEffects}\n`;
            snippet += `**Hot paths**: ${hotPaths}\n\n`;
            
            if (addedCount > 0) {
                snippet += `### 🔍 Key Functions\n`;
                functions.slice(0, 5).forEach(func => {
                    const complexity = func.complexity || 0;
                    const sideEffects = func.side_effects || [];
                    const isHot = func.hot_path ? '🔥 ' : '';
                    snippet += `• ${isHot}\`${func.name}\` (complexity: ${complexity}${sideEffects.length ? `, side effects: ${sideEffects.length}` : ''})\n`;
                });
                snippet += '\n';
            }
            
            if (analysis.traceData && analysis.traceData.length > 0) {
                snippet += `### 🔥 Hot Path Analysis\n`;
                const topTraces = analysis.traceData
                    .sort((a, b) => b.callCount - a.callCount)
                    .slice(0, 3);
                topTraces.forEach(trace => {
                    snippet += `• \`${trace.source}\` → \`${trace.target}\` (${trace.callCount} calls)\n`;
                });
                snippet += '\n';
            }
            
            snippet += `### ✅ Reviewer Checklist\n`;
            snippet += `- [ ] I have read the understanding tour\n`;
            snippet += `- [ ] I understand the side effects and complexity\n`;
            snippet += `- [ ] I have verified the changes align with the analysis\n`;
            snippet += `- [ ] I have checked for hot path impacts\n`;
            snippet += `- [ ] I have reviewed trace data for runtime behavior\n\n`;
            
            snippet += `### 📈 Metrics\n`;
            snippet += `- **Time to Understanding**: ${analysis.ttu || 'N/A'} min\n`;
            snippet += `- **Time to First Safe Change**: ${analysis.ttfsc || 'N/A'} min\n`;
            snippet += `- **Activation Rate**: ${analysis.activation || 'N/A'}%\n\n`;
            
            snippet += `*Generated by Understand-First*`;
            
            return snippet;
        }

        function showSuccess(message) {
            const success = document.createElement('div');
            success.className = 'success-message';
            success.textContent = message;
            success.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: #d4edda;
                color: #155724;
                padding: 12px 20px;
                border-radius: 6px;
                border: 1px solid #c3e6cb;
                z-index: 1000;
                animation: slideIn 0.3s ease;
            `;
            
            document.body.appendChild(success);
            setTimeout(() => {
                success.remove();
            }, 3000);
        }

        function focusMap() {
            document.getElementById('cy').focus();
        }

        function focusSearch() {
            // Create search input if it doesn't exist
            let searchInput = document.getElementById('searchInput');
            if (!searchInput) {
                searchInput = document.createElement('input');
                searchInput.id = 'searchInput';
                searchInput.type = 'text';
                searchInput.placeholder = 'Search functions...';
                searchInput.style.cssText = 'position: fixed; top: 50px; right: 20px; z-index: 1000; padding: 8px; border-radius: 4px; border: 1px solid #ccc;';
                document.body.appendChild(searchInput);
                
                searchInput.addEventListener('keydown', function(e) {
                    if (e.key === 'Escape') {
                        searchInput.remove();
                    } else if (e.key === 'Enter') {
                        searchFunctions(searchInput.value);
                    }
                });
            }
            searchInput.focus();
        }

        function searchFunctions(query) {
            if (!cy || !query) return;
            
            cy.elements().removeClass('search-highlight');
            const matchingNodes = cy.nodes().filter(node => 
                node.data('label').toLowerCase().includes(query.toLowerCase())
            );
            matchingNodes.addClass('search-highlight');
            
            if (matchingNodes.length > 0) {
                cy.fit(matchingNodes);
            }
        }

        function toggleFilterPanel() {
            const filterBar = document.querySelector('.filter-bar');
            filterBar.style.display = filterBar.style.display === 'none' ? 'flex' : 'none';
        }

        function toggleFilter(filterType) {
            const button = event.target;
            if (currentFilters.has(filterType)) {
                currentFilters.delete(filterType);
                button.classList.remove('active');
            } else {
                currentFilters.add(filterType);
                button.classList.add('active');
            }
            applyFilters();
            updateURLWithFilters();
        }

        function showLensPanel() {
            const lensPanel = document.createElement('div');
            lensPanel.id = 'lensPanel';
            lensPanel.className = 'lens-panel';
            lensPanel.innerHTML = `
                <div class="lens-header">
                    <h3>Lens & Filters</h3>
                    <button onclick="closeLensPanel()" class="btn-close">&times;</button>
                </div>
                <div class="lens-content">
                    <div class="filter-section">
                        <h4>Quick Filters</h4>
                        <div class="filter-group">
                            <label>Module:</label>
                            <select id="moduleFilter" onchange="applyModuleFilter()">
                                <option value="">All Modules</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label>Complexity:</label>
                            <select id="complexityFilter" onchange="applyComplexityFilter()">
                                <option value="">All</option>
                                <option value="low">Low (1-3)</option>
                                <option value="medium">Medium (4-6)</option>
                                <option value="high">High (7+)</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label>Side Effects:</label>
                            <div class="checkbox-group">
                                <label><input type="checkbox" onchange="applySideEffectFilter()" value="logging"> Logging</label>
                                <label><input type="checkbox" onchange="applySideEffectFilter()" value="fs"> File System</label>
                                <label><input type="checkbox" onchange="applySideEffectFilter()" value="network"> Network</label>
                                <label><input type="checkbox" onchange="applySideEffectFilter()" value="db"> Database</label>
                            </div>
                        </div>
                    </div>
                    <div class="lens-section">
                        <h4>Lens Presets</h4>
                        <div class="preset-buttons">
                            <button onclick="loadLensPreset('entry')" class="btn btn-outline btn-sm">Entry Points</button>
                            <button onclick="loadLensPreset('hotpath')" class="btn btn-outline btn-sm">Hot Paths</button>
                            <button onclick="loadLensPreset('sideeffects')" class="btn btn-outline btn-sm">Side Effects</button>
                            <button onclick="loadLensPreset('complexity')" class="btn btn-outline btn-sm">High Complexity</button>
                        </div>
                        <div class="lens-actions">
                            <button onclick="saveLensPreset()" class="btn btn-primary btn-sm">Save Current Lens</button>
                            <button onclick="clearLens()" class="btn btn-outline btn-sm">Clear Lens</button>
                        </div>
                    </div>
                    <div class="url-section">
                        <h4>Share Lens</h4>
                        <div class="url-input-group">
                            <input type="text" id="lensUrl" readonly>
                            <button onclick="copyLensUrl()" class="btn btn-outline btn-sm">Copy</button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(lensPanel);
            populateModuleFilter();
        }

        function closeLensPanel() {
            const lensPanel = document.getElementById('lensPanel');
            if (lensPanel) {
                lensPanel.remove();
            }
        }

        function populateModuleFilter() {
            const moduleFilter = document.getElementById('moduleFilter');
            if (!moduleFilter) return;
            
            const modules = new Set();
            cy.nodes().forEach(node => {
                const data = node.data();
                if (data.module) {
                    modules.add(data.module);
                }
            });
            
            moduleFilter.innerHTML = '<option value="">All Modules</option>' +
                Array.from(modules).map(module => 
                    `<option value="${module}">${module}</option>`
                ).join('');
        }

        function applyModuleFilter() {
            const moduleFilter = document.getElementById('moduleFilter');
            const selectedModule = moduleFilter.value;
            
            cy.nodes().forEach(node => {
                const data = node.data();
                if (selectedModule && data.module !== selectedModule) {
                    node.addClass('filtered');
                } else {
                    node.removeClass('filtered');
                }
            });
            
            updateLensUrl();
        }

        function applyComplexityFilter() {
            const complexityFilter = document.getElementById('complexityFilter');
            const selectedComplexity = complexityFilter.value;
            
            cy.nodes().forEach(node => {
                const data = node.data();
                let shouldFilter = false;
                
                if (selectedComplexity === 'low' && data.complexity > 3) {
                    shouldFilter = true;
                } else if (selectedComplexity === 'medium' && (data.complexity < 4 || data.complexity > 6)) {
                    shouldFilter = true;
                } else if (selectedComplexity === 'high' && data.complexity < 7) {
                    shouldFilter = true;
                }
                
                if (shouldFilter) {
                    node.addClass('filtered');
                } else {
                    node.removeClass('filtered');
                }
            });
            
            updateLensUrl();
        }

        function applySideEffectFilter() {
            const checkboxes = document.querySelectorAll('#lensPanel input[type="checkbox"]:checked');
            const selectedEffects = Array.from(checkboxes).map(cb => cb.value);
            
            cy.nodes().forEach(node => {
                const data = node.data();
                const sideEffects = data.sideEffects || [];
                
                if (selectedEffects.length > 0) {
                    const hasSelectedEffect = selectedEffects.some(effect => 
                        sideEffects.some(se => se.toLowerCase().includes(effect))
                    );
                    
                    if (!hasSelectedEffect) {
                        node.addClass('filtered');
                    } else {
                        node.removeClass('filtered');
                    }
                } else {
                    node.removeClass('filtered');
                }
            });
            
            updateLensUrl();
        }

        function loadLensPreset(preset) {
            // Clear current filters
            cy.elements().removeClass('filtered');
            
            switch (preset) {
                case 'entry':
                    cy.nodes().forEach(node => {
                        const data = node.data();
                        if (data.calls && data.calls.length === 0) {
                            // Entry point
                        } else {
                            node.addClass('filtered');
                        }
                    });
                    break;
                case 'hotpath':
                    cy.nodes().forEach(node => {
                        const data = node.data();
                        if (!data.hotPath) {
                            node.addClass('filtered');
                        }
                    });
                    break;
                case 'sideeffects':
                    cy.nodes().forEach(node => {
                        const data = node.data();
                        if (!data.sideEffects || data.sideEffects.length === 0) {
                            node.addClass('filtered');
                        }
                    });
                    break;
                case 'complexity':
                    cy.nodes().forEach(node => {
                        const data = node.data();
                        if (!data.complexity || data.complexity < 7) {
                            node.addClass('filtered');
                        }
                    });
                    break;
            }
            
            updateLensUrl();
        }

        function saveLensPreset() {
            const lensName = prompt('Enter a name for this lens preset:');
            if (!lensName) return;
            
            const lensData = {
                name: lensName,
                filters: getCurrentFilters(),
                timestamp: new Date().toISOString()
            };
            
            const savedLenses = JSON.parse(localStorage.getItem('saved-lenses') || '[]');
            savedLenses.push(lensData);
            localStorage.setItem('saved-lenses', JSON.stringify(savedLenses));
            
            showSuccess('Lens preset saved!');
        }

        function getCurrentFilters() {
            return {
                modules: document.getElementById('moduleFilter')?.value || '',
                complexity: document.getElementById('complexityFilter')?.value || '',
                sideEffects: Array.from(document.querySelectorAll('#lensPanel input[type="checkbox"]:checked')).map(cb => cb.value)
            };
        }

        function clearLens() {
            cy.elements().removeClass('filtered');
            document.getElementById('moduleFilter').value = '';
            document.getElementById('complexityFilter').value = '';
            document.querySelectorAll('#lensPanel input[type="checkbox"]').forEach(cb => cb.checked = false);
            updateLensUrl();
        }

        function updateLensUrl() {
            const lensUrl = document.getElementById('lensUrl');
            if (!lensUrl) return;
            
            const filters = getCurrentFilters();
            const url = new URL(window.location);
            url.searchParams.set('lens', JSON.stringify(filters));
            lensUrl.value = url.toString();
        }

        function copyLensUrl() {
            const lensUrl = document.getElementById('lensUrl');
            lensUrl.select();
            document.execCommand('copy');
            showSuccess('Lens URL copied to clipboard!');
        }

        function applyFilters() {
            if (!cy) return;
            
            cy.elements().removeClass('filtered');
            
            cy.nodes().forEach(node => {
                let shouldFilter = false;
                const data = node.data();
                
                if (currentFilters.has('complexity') && data.complexity > 5) {
                    shouldFilter = true;
                }
                if (currentFilters.has('sideEffects') && data.sideEffects.length > 0) {
                    shouldFilter = true;
                }
                if (currentFilters.has('logging') && data.sideEffects.includes('logging')) {
                    shouldFilter = true;
                }
                if (currentFilters.has('network') && data.sideEffects.includes('network')) {
                    shouldFilter = true;
                }
                
                if (shouldFilter) {
                    node.addClass('filtered');
                }
            });
            
            updateLensDisplay();
        }

        function updateLensDisplay() {
            const lensDisplay = document.getElementById('lensDisplay');
            if (!lensDisplay) return;
            
            const visibleNodes = cy.nodes().filter(node => !node.hasClass('filtered'));
            const totalNodes = cy.nodes().length;
            
            lensDisplay.innerHTML = `
                <div class="lens-summary">
                    <h4>Current Lens</h4>
                    <p>Showing ${visibleNodes.length} of ${totalNodes} functions</p>
                    <div class="lens-filters">
                        ${Array.from(currentFilters).map(filter => `
                            <span class="filter-tag">${filter}</span>
                        `).join('')}
                    </div>
                </div>
            `;
        }

        function saveLensPreset() {
            const presetName = prompt('Enter preset name:');
            if (!presetName) return;
            
            const preset = {
                name: presetName,
                filters: Array.from(currentFilters),
                timestamp: new Date().toISOString()
            };
            
            // Save to localStorage
            const presets = JSON.parse(localStorage.getItem('lensPresets') || '[]');
            presets.push(preset);
            localStorage.setItem('lensPresets', JSON.stringify(presets));
            
            // Update presets display
            updatePresetsDisplay();
            showSuccess(`Lens preset "${presetName}" saved!`);
        }

        function loadLensPreset(presetName) {
            const presets = JSON.parse(localStorage.getItem('lensPresets') || '[]');
            const preset = presets.find(p => p.name === presetName);
            
            if (!preset) {
                showError('Preset not found');
                return;
            }
            
            // Clear current filters
            currentFilters.clear();
            document.querySelectorAll('.filter-chip').forEach(chip => {
                chip.classList.remove('active');
            });
            
            // Apply preset filters
            preset.filters.forEach(filterType => {
                currentFilters.add(filterType);
                const chip = document.querySelector(`[onclick="toggleFilter('${filterType}')"]`);
                if (chip) {
                    chip.classList.add('active');
                }
            });
            
            applyFilters();
            updateURLWithFilters();
            showSuccess(`Lens preset "${presetName}" loaded!`);
        }

        function updatePresetsDisplay() {
            const presetsContainer = document.getElementById('lensPresets');
            if (!presetsContainer) return;
            
            const presets = JSON.parse(localStorage.getItem('lensPresets') || '[]');
            
            presetsContainer.innerHTML = `
                <h4>Saved Presets</h4>
                <div class="presets-list">
                    ${presets.map(preset => `
                        <div class="preset-item">
                            <span class="preset-name">${preset.name}</span>
                            <div class="preset-actions">
                                <button class="btn-icon" onclick="loadLensPreset('${preset.name}')" title="Load">
                                    <span>📂</span>
                                </button>
                                <button class="btn-icon" onclick="deleteLensPreset('${preset.name}')" title="Delete">
                                    <span>🗑️</span>
                                </button>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        function deleteLensPreset(presetName) {
            if (!confirm(`Delete preset "${presetName}"?`)) return;
            
            const presets = JSON.parse(localStorage.getItem('lensPresets') || '[]');
            const filteredPresets = presets.filter(p => p.name !== presetName);
            localStorage.setItem('lensPresets', JSON.stringify(filteredPresets));
            
            updatePresetsDisplay();
            showSuccess(`Lens preset "${presetName}" deleted!`);
        }

        function updateURLWithFilters() {
            const params = new URLSearchParams(window.location.hash.substring(1));
            
            if (currentFilters.size > 0) {
                params.set('filters', Array.from(currentFilters).join(','));
            } else {
                params.delete('filters');
            }
            
            const newUrl = window.location.pathname + '#' + params.toString();
            window.history.pushState({}, '', newUrl);
        }

        function loadFiltersFromURL() {
            const hash = window.location.hash.substring(1);
            const params = new URLSearchParams(hash);
            const filtersParam = params.get('filters');
            
            if (filtersParam) {
                const filters = filtersParam.split(',');
                filters.forEach(filterType => {
                    currentFilters.add(filterType);
                    const chip = document.querySelector(`[onclick="toggleFilter('${filterType}')"]`);
                    if (chip) {
                        chip.classList.add('active');
                    }
                });
                applyFilters();
            }
        }

        function clearAllFilters() {
            currentFilters.clear();
            document.querySelectorAll('.filter-chip').forEach(chip => {
                chip.classList.remove('active');
            });
            applyFilters();
            updateURLWithFilters();
        }

        function toggleTraceOverlay() {
            traceOverlay = !traceOverlay;
            const traceBtn = document.getElementById('traceBtn');
            traceBtn.classList.toggle('active', traceOverlay);
            
            if (traceOverlay) {
                showTraceOverlayUI();
                // Generate mock trace data if not available
                if (!currentAnalysis.trace) {
                    currentAnalysis.trace = generateMockTraceData();
                }
                
                // Apply trace overlay with enhanced features
                applyEnhancedTraceOverlay();
                
                // Animate hot path
                animateHotPath();
                
                // Show conflict detection
                showTraceConflicts();
                
                trackMetric('trace_overlay_enabled', 'true');
            } else {
                hideTraceOverlayUI();
                cy.elements().removeClass('trace-path', 'hot-path', 'conflict', 'runtime-only', 'static-only');
                hideTraceConflicts();
                trackMetric('trace_overlay_disabled', 'true');
            }
        }

        function generateMockTraceData() {
            // Generate realistic trace data for demonstration
            const functions = currentAnalysis.functions || [];
            const trace = {
                calls: [],
                hotPaths: [],
                conflicts: [],
                breadcrumbs: []
            };

            // Generate call frequency data
            functions.forEach((func, index) => {
                const callCount = Math.floor(Math.random() * 100) + 1;
                trace.calls.push({
                    from: index > 0 ? functions[index - 1].name : 'entry',
                    to: func.name,
                    count: callCount,
                    timestamp: new Date().toISOString()
                });
            });

            // Identify hot paths (functions called > 50 times)
            const hotPaths = trace.calls.filter(call => call.count > 50);
            trace.hotPaths = hotPaths.map(call => ({
                path: [call.from, call.to],
                frequency: call.count,
                percentage: (call.count / Math.max(...trace.calls.map(c => c.count)) * 100).toFixed(1)
            }));

            // Generate breadcrumb trail (last 10 calls)
            trace.breadcrumbs = trace.calls.slice(-10).map(call => ({
                from: call.from,
                to: call.to,
                count: call.count,
                timestamp: call.timestamp
            }));

            // Generate conflicts (runtime vs static differences)
            if (Math.random() > 0.7) {
                trace.conflicts.push({
                    function: functions[Math.floor(Math.random() * functions.length)].name,
                    staticPath: 'A -> B -> C',
                    runtimePath: 'A -> C',
                    description: 'Static analysis missed direct call path',
                    severity: 'medium'
                });
            }

            return trace;
        }

        function applyEnhancedTraceOverlay() {
            if (!cy || !currentAnalysis.trace) return;

            // Style nodes and edges based on trace data
            const trace = currentAnalysis.trace;
            
            // Apply frequency-based styling to edges
            cy.edges().forEach(edge => {
                const edgeData = edge.data();
                const call = trace.calls.find(c => 
                    c.from === edgeData.source && c.to === edgeData.target
                );
                
                if (call) {
                    edge.addClass('trace-path');
                    
                    // Set frequency-based styling
                    if (call.count > 75) {
                        edge.addClass('hot-path');
                    }
                    
                    // Update edge data
                    edge.data('frequency', call.count);
                    edge.data('label', `${call.count} calls`);
                } else {
                    // Static-only edge (not seen in runtime)
                    edge.addClass('static-only');
                    edge.data('label', 'static');
                }
            });

            // Style nodes based on involvement in hot paths
            cy.nodes().forEach(node => {
                const nodeData = node.data();
                const isHotPath = trace.hotPaths.some(path => 
                    path.path.includes(nodeData.label)
                );
                
                if (isHotPath) {
                    node.addClass('hot-path');
                }
                
                // Check for conflicts
                const conflict = trace.conflicts.find(c => c.function === nodeData.label);
                if (conflict) {
                    node.addClass('conflict');
                    node.data('conflict', conflict.description);
                }
            });

            // Update trace controls with real data
            updateTraceControls(trace);
        }

        function updateTraceControls(trace) {
            const traceControls = document.getElementById('traceControls');
            if (traceControls) {
                // Update stats
                const hotPathCount = traceControls.querySelector('#hotPathCount');
                const conflictCount = traceControls.querySelector('#conflictCount');
                const totalCalls = traceControls.querySelector('#totalCalls');
                
                if (hotPathCount) hotPathCount.textContent = trace.hotPaths.length;
                if (conflictCount) conflictCount.textContent = trace.conflicts.length;
                if (totalCalls) totalCalls.textContent = trace.calls.length;
            }
        }

        function setTraceMode(mode) {
            if (!cy || !currentAnalysis.trace) return;

            // Clear existing mode classes
            cy.elements().removeClass('runtime-only', 'static-only', 'compare-mode');
            
            switch(mode) {
                case 'runtime':
                    // Show only runtime-observed paths
                    cy.edges().forEach(edge => {
                        const edgeData = edge.data();
                        const call = currentAnalysis.trace.calls.find(c => 
                            c.from === edgeData.source && c.to === edgeData.target
                        );
                        
                        if (!call) {
                            edge.addClass('static-only');
                        } else {
                            edge.removeClass('static-only');
                        }
                    });
                    break;
                    
                case 'static':
                    // Show all static paths
                    cy.edges().removeClass('static-only');
                    break;
                    
                case 'compare':
                    // Show both with highlighting differences
                    cy.addClass('compare-mode');
                    highlightConflicts();
                    break;
            }
            
            trackMetric('trace_mode_changed', mode);
        }

        function highlightConflicts() {
            if (!currentAnalysis.trace.conflicts) return;

            currentAnalysis.trace.conflicts.forEach(conflict => {
                const node = cy.nodes().filter(`[label = "${conflict.function}"]`);
                if (node.length > 0) {
                    node.addClass('conflict');
                    
                    // Show conflict tooltip
                    showConflictTooltip(node[0], conflict);
                }
            });
        }

        function showConflictTooltip(node, conflict) {
            const tooltip = document.createElement('div');
            tooltip.className = 'conflict-tooltip';
            tooltip.innerHTML = `
                <div class="conflict-header">
                    <h5>⚠️ Runtime vs Static Conflict</h5>
                </div>
                <div class="conflict-body">
                    <p><strong>Function:</strong> ${conflict.function}</p>
                    <p><strong>Static Path:</strong> ${conflict.staticPath}</p>
                    <p><strong>Runtime Path:</strong> ${conflict.runtimePath}</p>
                    <p><strong>Description:</strong> ${conflict.description}</p>
                </div>
            `;

            const position = node.renderedPosition();
            tooltip.style.position = 'absolute';
            tooltip.style.left = (position.x + 20) + 'px';
            tooltip.style.top = (position.y - 100) + 'px';
            tooltip.style.zIndex = '1001';

            document.body.appendChild(tooltip);

            // Remove after 5 seconds
            setTimeout(() => {
                if (tooltip.parentNode) {
                    tooltip.remove();
                }
            }, 5000);
        }

        function showBreadcrumbTrail() {
            if (!currentAnalysis.trace || !currentAnalysis.trace.breadcrumbs) return;

            const breadcrumbPanel = document.createElement('div');
            breadcrumbPanel.id = 'breadcrumbPanel';
            breadcrumbPanel.className = 'breadcrumb-panel';
            breadcrumbPanel.innerHTML = `
                <div class="breadcrumb-header">
                    <h4>📍 Call Trail (Last 10)</h4>
                    <button onclick="closeBreadcrumbTrail()" class="close-btn">×</button>
                </div>
                <div class="breadcrumb-list">
                    ${currentAnalysis.trace.breadcrumbs.map((call, index) => `
                        <div class="breadcrumb-item">
                            <span class="breadcrumb-step">${index + 1}</span>
                            <span class="breadcrumb-call">${call.from} → ${call.to}</span>
                            <span class="breadcrumb-count">${call.count} calls</span>
                        </div>
                    `).join('')}
                </div>
            `;

            const insightPanel = document.querySelector('.insight-panel');
            if (insightPanel) {
                insightPanel.appendChild(breadcrumbPanel);
            }
        }

        function closeBreadcrumbTrail() {
            const breadcrumbPanel = document.getElementById('breadcrumbPanel');
            if (breadcrumbPanel) {
                breadcrumbPanel.remove();
            }
        }

        function exportTrace() {
            if (!currentAnalysis.trace) {
                showError('No trace data to export.');
                return;
            }

            const traceData = {
                timestamp: new Date().toISOString(),
                analysis: currentAnalysis.trace,
                metadata: {
                    totalFunctions: currentAnalysis.functions.length,
                    hotPaths: currentAnalysis.trace.hotPaths.length,
                    conflicts: currentAnalysis.trace.conflicts.length
                }
            };

            const jsonData = JSON.stringify(traceData, null, 2);
            downloadFile(jsonData, 'trace-analysis.json', 'application/json');
            
            trackMetric('trace_exported', 'json');
        }

        function showTraceOverlayUI() {
            // Add trace overlay controls
            const traceControls = document.createElement('div');
            traceControls.id = 'traceControls';
            traceControls.className = 'trace-controls';
            traceControls.innerHTML = `
                <div class="trace-toggle">
                    <button onclick="toggleStaticRuntime()" class="btn-small" id="staticRuntimeBtn">Static</button>
                    <button onclick="animateHotPath()" class="btn-small">Animate</button>
                    <button onclick="showBreadcrumb()" class="btn-small">Breadcrumb</button>
                </div>
                <div class="trace-breadcrumb" id="traceBreadcrumb" style="display: none;">
                    <div class="breadcrumb-title">Last 10 Calls:</div>
                    <div class="breadcrumb-items" id="breadcrumbItems"></div>
                </div>
                <div class="conflict-badge" id="conflictBadge" style="display: none;">
                    ⚠️ Runtime vs Static Mismatch
                </div>
            `;
            
            const cyContainer = document.getElementById('cy');
            cyContainer.appendChild(traceControls);
        }

        function hideTraceOverlayUI() {
            const traceControls = document.getElementById('traceControls');
            if (traceControls) {
                traceControls.remove();
            }
        }

        function toggleStaticRuntime() {
            const btn = document.getElementById('staticRuntimeBtn');
            const isStatic = btn.textContent === 'Static';
            
            if (isStatic) {
                btn.textContent = 'Runtime';
                showRuntimeTrace();
            } else {
                btn.textContent = 'Static';
                showStaticTrace();
            }
        }

        function showStaticTrace() {
            // Show static analysis results
            cy.elements().removeClass('trace-path', 'hot-path');
            cy.elements().forEach(element => {
                if (element.isNode()) {
                    const data = element.data();
                    if (data.staticPath) {
                        element.addClass('trace-path');
                    }
                }
            });
        }

        function showRuntimeTrace() {
            // Show runtime trace data
            cy.elements().removeClass('trace-path', 'hot-path');
            cy.elements().forEach(element => {
                if (element.isNode()) {
                    const data = element.data();
                    if (data.runtimePath) {
                        element.addClass('trace-path');
                    }
                }
            });
            
            // Check for conflicts
            checkForConflicts();
        }

        function animateHotPath(entryPoints) {
            // Animate the hot path
            const hotPathNodes = entryPoints || cy.elements().filter('[hotPath="true"]');
            const hotPathEdges = hotPathNodes.neighborhood('edge');
            
            // Clear previous animations
            cy.elements().removeClass('animating');
            
            // Animate each node in sequence
            hotPathNodes.forEach((node, index) => {
                setTimeout(() => {
                    node.addClass('animating');
                    setTimeout(() => {
                        node.removeClass('animating');
                    }, 1000);
                }, index * 200);
            });
            
            // Animate edges
            hotPathEdges.forEach((edge, index) => {
                setTimeout(() => {
                    edge.addClass('animating');
                    setTimeout(() => {
                        edge.removeClass('animating');
                    }, 1000);
                }, index * 200);
            });
        }

        function showBreadcrumb() {
            const breadcrumb = document.getElementById('traceBreadcrumb');
            const items = document.getElementById('breadcrumbItems');
            
            if (breadcrumb.style.display === 'none') {
                breadcrumb.style.display = 'block';
                updateBreadcrumb();
            } else {
                breadcrumb.style.display = 'none';
            }
        }

        function updateBreadcrumb() {
            const items = document.getElementById('breadcrumbItems');
            const lastCalls = getLastCalls(10);
            
            items.innerHTML = lastCalls.map((call, index) => `
                <div class="breadcrumb-item" onclick="focusOnCall('${call.id}')">
                    ${index + 1}. ${call.function} (${call.timestamp})
                </div>
            `).join('');
        }

        function getLastCalls(count) {
            // Mock data - in real implementation, this would come from trace data
            return [
                { id: '1', function: 'compute', timestamp: '10:30:15' },
                { id: '2', function: 'add', timestamp: '10:30:14' },
                { id: '3', function: 'maybe_log', timestamp: '10:30:13' },
                { id: '4', function: 'validate_input', timestamp: '10:30:12' },
                { id: '5', function: 'process_data', timestamp: '10:30:11' }
            ].slice(0, count);
        }

        function focusOnCall(callId) {
            const node = cy.getElementById(callId);
            if (node) {
                cy.center(node);
                node.addClass('selected');
            }
        }

        function checkForConflicts() {
            // Check for conflicts between static and runtime analysis
            let hasConflicts = false;
            
            cy.elements().forEach(element => {
                if (element.isNode()) {
                    const data = element.data();
                    if (data.staticPath && data.runtimePath && 
                        data.staticPath !== data.runtimePath) {
                        element.addClass('conflict');
                        hasConflicts = true;
                    }
                }
            });
            
            const conflictBadge = document.getElementById('conflictBadge');
            if (hasConflicts) {
                conflictBadge.style.display = 'block';
            } else {
                conflictBadge.style.display = 'none';
            }
        }

        function toggleMinimap() {
            const minimap = document.getElementById('minimap');
            const minimapBtn = document.getElementById('minimapBtn');
            
            if (minimap.style.display === 'none') {
                minimap.style.display = 'block';
                minimapBtn.classList.add('active');
                initializeMinimap();
            } else {
                minimap.style.display = 'none';
                minimapBtn.classList.remove('active');
            }
        }

        function initializeMinimap() {
            if (cyMinimap) return;
            
            cyMinimap = cytoscape({
                container: document.getElementById('cy-minimap'),
                elements: cy.elements().jsons(),
                style: [
                    {
                        selector: 'node',
                        style: {
                            'background-color': '#666',
                            'label': 'data(label)',
                            'color': 'white',
                            'font-size': '8px',
                            'width': '10px',
                            'height': '10px'
                        }
                    },
                    {
                        selector: 'edge',
                        style: {
                            'width': '1px',
                            'line-color': '#666'
                        }
                    }
                ],
                layout: { name: 'preset' }
            });
        }

        function zoomToFit() {
            if (cy) {
                cy.fit();
            }
        }

        function highlightFunction(funcName) {
            cy.elements().removeClass('highlighted');
            const node = cy.nodes().filter(n => n.data('label') === funcName);
            node.addClass('highlighted');
            cy.fit(node);
        }

        function startTour() {
            if (tourSteps.length === 0) {
                showError('Please analyze code first to generate a tour.');
                return;
            }
            
            // Show tour reader UI
            showTourReader();
            goToTourStep(0);
        }

        function showTourReader() {
            // Create tour reader panel
            const tourReader = document.createElement('div');
            tourReader.id = 'tourReader';
            tourReader.className = 'tour-reader';
            tourReader.innerHTML = `
                <div class="tour-header">
                    <h3>Understanding Tour</h3>
                    <button onclick="closeTourReader()" class="btn-close">&times;</button>
                </div>
                <div class="tour-timeline">
                    <div class="timeline-progress">
                        <div class="progress-bar" id="tourProgress"></div>
                    </div>
                    <div class="timeline-steps" id="timelineSteps"></div>
                </div>
                <div class="tour-content">
                    <div class="tour-step-content" id="tourStepContent"></div>
                    <div class="tour-actions">
                        <button onclick="previousStep()" class="btn btn-outline" id="prevBtn" disabled>Previous</button>
                        <button onclick="nextStep()" class="btn btn-primary" id="nextBtn">Next</button>
                        <button onclick="exportTour()" class="btn btn-outline">Export</button>
                        <button onclick="bookmarkStep()" class="btn btn-outline">Bookmark</button>
                    </div>
                </div>
            `;
            
            // Add to right pane or create overlay
            const rightPane = document.querySelector('.pane:last-child');
            if (rightPane) {
                rightPane.appendChild(tourReader);
            } else {
                document.body.appendChild(tourReader);
            }
            
            // Initialize tour steps
            initializeTourSteps();
        }

        function closeTourReader() {
            const tourReader = document.getElementById('tourReader');
            if (tourReader) {
                tourReader.remove();
            }
        }

        function initializeTourSteps() {
            const timelineSteps = document.getElementById('timelineSteps');
            timelineSteps.innerHTML = '';
            
            tourSteps.forEach((step, index) => {
                const stepElement = document.createElement('div');
                stepElement.className = `timeline-step ${index === currentTourStep ? 'active' : ''}`;
                stepElement.innerHTML = `
                    <div class="step-number">${index + 1}</div>
                    <div class="step-title">${step.title || `Step ${index + 1}`}</div>
                `;
                stepElement.onclick = () => goToTourStep(index);
                timelineSteps.appendChild(stepElement);
            });
        }

        function goToTourStep(stepIndex) {
            if (stepIndex < 0 || stepIndex >= tourSteps.length) return;
            
            currentTourStep = stepIndex;
            const step = tourSteps[stepIndex];
            
            // Update timeline
            document.querySelectorAll('.timeline-step').forEach((el, index) => {
                el.classList.toggle('active', index === stepIndex);
            });
            
            // Update progress bar
            const progress = ((stepIndex + 1) / tourSteps.length) * 100;
            document.getElementById('tourProgress').style.width = progress + '%';
            
            // Update step content
            updateTourStepContent(step);
            
            // Update buttons
            document.getElementById('prevBtn').disabled = stepIndex === 0;
            document.getElementById('nextBtn').textContent = stepIndex === tourSteps.length - 1 ? 'Finish' : 'Next';
            
            // Focus on nodes/edges in the graph
            focusOnTourStep(step);
        }

        function updateTourStepContent(step) {
            const content = document.getElementById('tourStepContent');
            content.innerHTML = `
                <div class="step-header">
                    <h4>${step.title || 'Tour Step'}</h4>
                    <div class="step-meta">
                        <span class="step-number">Step ${currentTourStep + 1} of ${tourSteps.length}</span>
                    </div>
                </div>
                <div class="step-description">
                    <p>${step.description || 'No description available.'}</p>
                </div>
                ${step.code ? `
                    <div class="step-code">
                        <h5>Code Focus:</h5>
                        <pre><code>${step.code}</code></pre>
                    </div>
                ` : ''}
                ${step.why ? `
                    <div class="step-why">
                        <h5>Why it matters:</h5>
                        <p>${step.why}</p>
                    </div>
                ` : ''}
            `;
        }

        function focusOnTourStep(step) {
            if (!cy) return;
            
            // Clear previous highlights
            cy.elements().removeClass('tour-highlight');
            
            // Highlight nodes and edges for this step
            if (step.focus && step.focus.nodes) {
                step.focus.nodes.forEach(nodeId => {
                    const node = cy.getElementById(nodeId);
                    if (node) {
                        node.addClass('tour-highlight');
                    }
                });
            }
            
            if (step.focus && step.focus.edges) {
                step.focus.edges.forEach(edgeId => {
                    const edge = cy.getElementById(edgeId);
                    if (edge) {
                        edge.addClass('tour-highlight');
                    }
                });
            }
            
            // Center on focused elements
            const highlighted = cy.elements('.tour-highlight');
            if (highlighted.length > 0) {
                cy.fit(highlighted, 50);
            }
        }

        function previousStep() {
            if (currentTourStep > 0) {
                goToTourStep(currentTourStep - 1);
            }
        }

        function nextStep() {
            if (currentTourStep < tourSteps.length - 1) {
                goToTourStep(currentTourStep + 1);
            } else {
                // Finish tour
                finishTour();
            }
        }

        function finishTour() {
            // Track tour completion
            trackTTU('tour_completed', Date.now() - tourStartTime);
            
            // Show completion message
            showSuccess('Tour completed! You now have a better understanding of the code.');
            
            // Close tour reader
            closeTourReader();
        }

        function exportTour() {
            const tourMarkdown = generateTourMarkdown();
            downloadFile(tourMarkdown, 'understanding-tour.md', 'text/markdown');
        }

        function generateTourMarkdown() {
            let markdown = `# Understanding Tour\n\n`;
            markdown += `Generated on ${new Date().toLocaleDateString()}\n\n`;
            
            tourSteps.forEach((step, index) => {
                markdown += `## Step ${index + 1}: ${step.title || 'Untitled'}\n\n`;
                markdown += `${step.description || 'No description available.'}\n\n`;
                
                if (step.code) {
                    markdown += `\`\`\`python\n${step.code}\n\`\`\`\n\n`;
                }
                
                if (step.why) {
                    markdown += `**Why it matters:** ${step.why}\n\n`;
                }
                
                markdown += `---\n\n`;
            });
            
            return markdown;
        }

        function bookmarkStep() {
            const bookmarks = JSON.parse(localStorage.getItem('tour-bookmarks') || '[]');
            const bookmark = {
                step: currentTourStep,
                title: tourSteps[currentTourStep].title || `Step ${currentTourStep + 1}`,
                timestamp: new Date().toISOString()
            };
            
            bookmarks.push(bookmark);
            localStorage.setItem('tour-bookmarks', JSON.stringify(bookmarks));
            
            showSuccess('Step bookmarked!');
        }

        function toggleLens() {
            const lensBtn = document.getElementById('lensBtn');
            lensBtn.classList.toggle('active');
            
            if (lensBtn.classList.contains('active')) {
                showLensPanel();
            } else {
                closeLensPanel();
            }
        }

        function showDiff() {
            console.log('Show diff functionality');
        }

        function exportResults() {
            if (!currentAnalysis) {
                showError('No analysis to export. Please analyze code first.');
                return;
            }
            
            const exportMenu = document.createElement('div');
            exportMenu.className = 'export-menu';
            exportMenu.innerHTML = `
                <div class="export-header">
                    <h3>Export Analysis</h3>
                    <button onclick="closeExportMenu()" class="btn-close">&times;</button>
                </div>
                <div class="export-options">
                    <div class="export-option" onclick="exportAnalysis('svg')">
                        <span class="export-icon">🖼️</span>
                        <div class="export-details">
                            <h4>SVG Map</h4>
                            <p>High-quality vector image of the code map</p>
                        </div>
                    </div>
                    <div class="export-option" onclick="exportAnalysis('png')">
                        <span class="export-icon">📷</span>
                        <div class="export-details">
                            <h4>PNG Image</h4>
                            <p>Raster image suitable for documentation</p>
                        </div>
                    </div>
                    <div class="export-option" onclick="exportAnalysis('json')">
                        <span class="export-icon">📄</span>
                        <div class="export-details">
                            <h4>JSON Data</h4>
                            <p>Raw analysis data for further processing</p>
                        </div>
                    </div>
                    <div class="export-option" onclick="exportAnalysis('markdown')">
                        <span class="export-icon">📝</span>
                        <div class="export-details">
                            <h4>Markdown Report</h4>
                            <p>Human-readable analysis report</p>
                        </div>
                    </div>
                    <div class="export-option" onclick="exportAnalysis('uflens')">
                        <span class="export-icon">🔍</span>
                        <div class="export-details">
                            <h4>Lens Bundle</h4>
                            <p>Complete lens configuration (.uflens)</p>
                        </div>
                    </div>
                    <div class="export-option" onclick="generatePRSnippet()">
                        <span class="export-icon">🔗</span>
                        <div class="export-details">
                            <h4>PR Snippet</h4>
                            <p>Copy PR comment with delta summary</p>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(exportMenu);
        }

        function closeExportMenu() {
            const exportMenu = document.querySelector('.export-menu');
            if (exportMenu) {
                exportMenu.remove();
            }
        }

        function exportAnalysis(format) {
            closeExportMenu();
            
            switch (format) {
                case 'svg':
                    exportSVG();
                    break;
                case 'png':
                    exportPNG();
                    break;
                case 'json':
                    exportJSON();
                    break;
                case 'markdown':
                    exportMarkdown();
                    break;
                case 'uflens':
                    exportLensBundle();
                    break;
            }
        }

        function exportSVG() {
            if (!cy) {
                showError('No graph to export. Please analyze code first.');
                return;
            }
            
            const svg = cy.svg({ scale: 2, full: true });
            downloadFile(svg, 'code-map.svg', 'image/svg+xml');
        }

        function exportPNG() {
            if (!cy) {
                showError('No graph to export. Please analyze code first.');
                return;
            }
            
            const png = cy.png({ scale: 2, full: true });
            downloadFile(png, 'code-map.png', 'image/png');
        }

        function exportJSON() {
            const analysisData = {
                timestamp: new Date().toISOString(),
                analysis: currentAnalysis,
                graph: cy ? cy.elements().jsons() : [],
                tour: tourSteps,
                filters: getCurrentFilters()
            };
            
            const json = JSON.stringify(analysisData, null, 2);
            downloadFile(json, 'analysis.json', 'application/json');
        }

        function exportMarkdown() {
            let markdown = `# Code Analysis Report\n\n`;
            markdown += `Generated on ${new Date().toLocaleDateString()}\n\n`;
            
            if (currentAnalysis) {
                markdown += `## Summary\n\n`;
                markdown += `- **Functions analyzed**: ${currentAnalysis.functions.length}\n`;
                markdown += `- **Total complexity**: ${currentAnalysis.functions.reduce((sum, f) => sum + f.complexity, 0)}\n`;
                markdown += `- **Side effects detected**: ${currentAnalysis.sideEffects.length}\n\n`;
                
                markdown += `## Functions\n\n`;
                currentAnalysis.functions.forEach(func => {
                    markdown += `### ${func.name}\n\n`;
                    markdown += `- **Complexity**: ${func.complexity}\n`;
                    markdown += `- **Side effects**: ${func.sideEffects.join(', ') || 'None'}\n`;
                    markdown += `- **Calls**: ${func.calls.length}\n\n`;
                });
                
                if (tourSteps.length > 0) {
                    markdown += `## Understanding Tour\n\n`;
                    tourSteps.forEach((step, index) => {
                        markdown += `### Step ${index + 1}: ${step.title || 'Untitled'}\n\n`;
                        markdown += `${step.description || 'No description available.'}\n\n`;
                    });
                }
            }
            
            downloadFile(markdown, 'analysis-report.md', 'text/markdown');
        }

        function exportLensBundle() {
            const lensData = {
                version: '1.0',
                timestamp: new Date().toISOString(),
                analysis: currentAnalysis,
                filters: getCurrentFilters(),
                tour: tourSteps,
                metadata: {
                    generated_by: 'understand-first-web-demo',
                    version: '1.0.0'
                }
            };
            
            const bundle = JSON.stringify(lensData, null, 2);
            downloadFile(bundle, 'analysis.uflens', 'application/json');
        }

        function generatePRSnippet() {
            if (!currentAnalysis) {
                showError('No analysis to generate PR snippet from.');
                return;
            }
            
            const snippet = generatePRComment();
            copyToClipboard(snippet);
            showSuccess('PR snippet copied to clipboard!');
        }

        function generatePRComment() {
            const functions = currentAnalysis.functions;
            const addedCount = functions.length;
            const highComplexity = functions.filter(f => f.complexity > 5).length;
            const sideEffects = functions.filter(f => f.sideEffects.length > 0).length;
            const hotPaths = functions.filter(f => f.hotPath).length;
            
            let snippet = `## 📊 Understanding Analysis\n\n`;
            snippet += `**Functions analyzed**: ${addedCount}\n`;
            snippet += `**High complexity**: ${highComplexity}\n`;
            snippet += `**With side effects**: ${sideEffects}\n`;
            snippet += `**Hot paths**: ${hotPaths}\n\n`;
            
            if (highComplexity > 0) {
                snippet += `### ⚠️ High Complexity Functions\n`;
                functions.filter(f => f.complexity > 5).forEach(f => {
                    snippet += `- \`${f.name}\` (complexity: ${f.complexity})\n`;
                });
                snippet += `\n`;
            }
            
            if (sideEffects > 0) {
                snippet += `### 🔄 Side Effects Detected\n`;
                functions.filter(f => f.sideEffects.length > 0).forEach(f => {
                    snippet += `- \`${f.name}\`: ${f.sideEffects.join(', ')}\n`;
                });
                snippet += `\n`;
            }
            
            snippet += `### ✅ Reviewer Checklist\n`;
            snippet += `- [ ] I read the understanding tour\n`;
            snippet += `- [ ] I verified the hot path analysis\n`;
            snippet += `- [ ] I checked for unmanaged side effects\n`;
            snippet += `- [ ] I understand the complexity implications\n\n`;
            
            snippet += `---\n`;
            snippet += `*Generated by Understand-First Analysis*`;
            
            return snippet;
        }

        function downloadFile(content, filename, mimeType) {
            const blob = new Blob([content], { type: mimeType });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).catch(() => {
                // Fallback for older browsers
                const textArea = document.createElement('textarea');
                textArea.value = text;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
            });
        }

        function trackMetric(name, value) {
            // Track metrics for TTU/TTFSC goals
            console.log(`Metric: ${name} = ${value}`);
            
            // In a real implementation, this would send to analytics
            if (typeof gtag !== 'undefined') {
                gtag('event', name, {
                    'custom_parameter': value
                });
            }
        }

        // Advanced Graph Features Implementation
        function setupAdvancedGraphInteractions() {
            if (!cy) return;

            // Add hover effects with detailed tooltips
            cy.on('mouseover', 'node', function(evt) {
                const node = evt.target;
                const data = node.data();
                
                // Create detailed hover card
                showHoverCard(node, data);
                
                // Highlight connected nodes and edges
                highlightConnected(node);
                
                // Update metrics panel
                updateNodeMetrics(data);
            });

            cy.on('mouseout', 'node', function(evt) {
                const node = evt.target;
                hideHoverCard();
                clearHighlights();
            });

            // Add click handlers for node selection and navigation
            cy.on('tap', 'node', function(evt) {
                const node = evt.target;
                const data = node.data();
                
                // Update selection
                cy.elements().removeClass('selected');
                node.addClass('selected');
                
                // Show code preview
                showCodePreview(data);
                
                // Update URL with deep link
                updateDeepLink(data);
                
                // Track interaction
                trackMetric('node_clicked', data.label);
            });

            // Add edge click handlers
            cy.on('tap', 'edge', function(evt) {
                const edge = evt.target;
                const data = edge.data();
                
                cy.elements().removeClass('selected');
                edge.addClass('selected');
                
                showEdgeDetails(data);
                trackMetric('edge_clicked', data.label);
            });

            // Add pan and zoom handlers for performance
            cy.on('pan zoom', debounce(function() {
                updateMinimap();
            }, 100));

            // Add keyboard navigation
            document.addEventListener('keydown', function(e) {
                if (cy) {
                    handleGraphKeyboard(e);
                }
            });
        }

        function showHoverCard(node, data) {
            // Remove existing hover card
            hideHoverCard();
            
            const hoverCard = document.createElement('div');
            hoverCard.id = 'hoverCard';
            hoverCard.className = 'hover-card';
            hoverCard.innerHTML = `
                <div class="hover-card-header">
                    <h4>${data.label}</h4>
                    <span class="complexity-badge complexity-${data.complexity || 'low'}">${data.complexity || 'Low'} Complexity</span>
                </div>
                <div class="hover-card-body">
                    <div class="hover-metric">
                        <span class="metric-label">File:</span>
                        <span class="metric-value">${data.file || 'Unknown'}</span>
                    </div>
                    <div class="hover-metric">
                        <span class="metric-label">Line:</span>
                        <span class="metric-value">${data.line || 'Unknown'}</span>
                    </div>
                    <div class="hover-metric">
                        <span class="metric-label">Callers:</span>
                        <span class="metric-value">${data.callers ? data.callers.length : 0}</span>
                    </div>
                    <div class="hover-metric">
                        <span class="metric-label">Callees:</span>
                        <span class="metric-value">${data.callees ? data.callees.length : 0}</span>
                    </div>
                    ${data.sideEffects && data.sideEffects.length > 0 ? `
                    <div class="hover-metric">
                        <span class="metric-label">Side Effects:</span>
                        <span class="metric-value">${data.sideEffects.join(', ')}</span>
                    </div>
                    ` : ''}
                </div>
            `;
            
            // Position hover card near mouse
            const position = node.renderedPosition();
            hoverCard.style.position = 'absolute';
            hoverCard.style.left = (position.x + 20) + 'px';
            hoverCard.style.top = (position.y - 50) + 'px';
            hoverCard.style.zIndex = '1000';
            
            document.body.appendChild(hoverCard);
        }

        function hideHoverCard() {
            const hoverCard = document.getElementById('hoverCard');
            if (hoverCard) {
                hoverCard.remove();
            }
        }

        function highlightConnected(node) {
            // Clear previous highlights
            clearHighlights();
            
            // Highlight connected nodes
            const connected = node.neighborhood();
            connected.addClass('highlighted');
            
            // Highlight connecting edges
            const edges = node.connectedEdges();
            edges.addClass('highlighted');
        }

        function clearHighlights() {
            if (cy) {
                cy.elements().removeClass('highlighted');
            }
        }

        function showCodePreview(data) {
            const codePreview = document.getElementById('codePreview');
            if (codePreview && data.file) {
                // Mock code preview - in production would load actual file content
                codePreview.innerHTML = `
                    <div class="code-preview-header">
                        <h4>${data.label}</h4>
                        <span class="file-path">${data.file}:${data.line}</span>
                    </div>
                    <div class="code-preview-content">
                        <pre><code>def ${data.label}():
    # Code preview would be loaded here
    # Line ${data.line} in ${data.file}
    pass</code></pre>
                    </div>
                `;
                codePreview.style.display = 'block';
            }
        }

        function showEdgeDetails(data) {
            const edgeDetails = document.getElementById('edgeDetails');
            if (edgeDetails) {
                edgeDetails.innerHTML = `
                    <div class="edge-details-header">
                        <h4>Edge Details</h4>
                    </div>
                    <div class="edge-details-body">
                        <div class="edge-metric">
                            <span class="metric-label">From:</span>
                            <span class="metric-value">${data.source}</span>
                        </div>
                        <div class="edge-metric">
                            <span class="metric-label">To:</span>
                            <span class="metric-value">${data.target}</span>
                        </div>
                        <div class="edge-metric">
                            <span class="metric-label">Frequency:</span>
                            <span class="metric-value">${data.frequency || 'Unknown'}</span>
                        </div>
                        <div class="edge-metric">
                            <span class="metric-label">Type:</span>
                            <span class="metric-value">${data.type || 'Function Call'}</span>
                        </div>
                    </div>
                `;
                edgeDetails.style.display = 'block';
            }
        }

        function setupClustering() {
            if (!cy) return;

            // Add clustering controls to toolbar
            const clusteringBtn = document.createElement('button');
            clusteringBtn.id = 'clusteringBtn';
            clusteringBtn.className = 'toolbar-btn';
            clusteringBtn.innerHTML = '🔗 Clusters';
            clusteringBtn.title = 'Toggle node clustering by module';
            clusteringBtn.onclick = toggleClustering;

            const toolbar = document.querySelector('.toolbar');
            if (toolbar) {
                toolbar.appendChild(clusteringBtn);
            }
        }

        let clusteringEnabled = false;
        let clusterGroups = {};

        function toggleClustering() {
            clusteringEnabled = !clusteringEnabled;
            const btn = document.getElementById('clusteringBtn');
            
            if (clusteringEnabled) {
                btn.classList.add('active');
                createClusters();
            } else {
                btn.classList.remove('active');
                removeClusters();
            }
        }

        function createClusters() {
            if (!cy) return;

            // Group nodes by module
            const modules = {};
            cy.nodes().forEach(node => {
                const module = node.data('module') || 'default';
                if (!modules[module]) {
                    modules[module] = [];
                }
                modules[module].push(node.id());
            });

            // Create compound nodes for each module
            const compounds = [];
            Object.keys(modules).forEach(module => {
                if (modules[module].length > 1) {
                    const compound = {
                        group: 'nodes',
                        data: {
                            id: `cluster_${module}`,
                            label: module,
                            isCluster: true,
                            module: module
                        },
                        classes: 'cluster'
                    };
                    compounds.push(compound);
                    clusterGroups[module] = modules[module];
                }
            });

            // Add compound nodes
            cy.add(compounds);

            // Move nodes into clusters
            Object.keys(clusterGroups).forEach(module => {
                const clusterId = `cluster_${module}`;
                const nodes = clusterGroups[module];
                
                nodes.forEach(nodeId => {
                    const node = cy.getElementById(nodeId);
                    if (node) {
                        node.move({ parent: clusterId });
                    }
                });
            });

            // Apply cluster layout
            cy.layout({
                name: 'dagre',
                rankDir: 'TB',
                spacingFactor: 2.0,
                nodeSep: 50,
                edgeSep: 20,
                rankSep: 100,
                animate: true,
                animationDuration: 1000
            }).run();
        }

        function removeClusters() {
            if (!cy) return;

            // Remove compound nodes and move children back to root
            cy.nodes('[isCluster]').forEach(cluster => {
                const children = cluster.children();
                children.move({ parent: null });
                cluster.remove();
            });

            // Clear cluster groups
            clusterGroups = {};

            // Re-layout
            cy.layout({
                name: 'dagre',
                rankDir: 'TB',
                spacingFactor: 2.0,
                nodeSep: 50,
                edgeSep: 20,
                rankSep: 100,
                animate: true,
                animationDuration: 1000
            }).run();
        }

        function setupGraphSearch() {
            // Add search input to toolbar
            const searchContainer = document.createElement('div');
            searchContainer.className = 'search-container';
            searchContainer.innerHTML = `
                <input type="text" id="graphSearch" placeholder="Search functions..." class="search-input">
                <button id="searchBtn" class="search-btn">🔍</button>
                <button id="clearSearchBtn" class="clear-search-btn">✕</button>
            `;

            const toolbar = document.querySelector('.toolbar');
            if (toolbar) {
                toolbar.appendChild(searchContainer);
            }

            // Add search functionality
            const searchInput = document.getElementById('graphSearch');
            const searchBtn = document.getElementById('searchBtn');
            const clearSearchBtn = document.getElementById('clearSearchBtn');

            if (searchInput) {
                searchInput.addEventListener('input', debounce(performSearch, 300));
                searchInput.addEventListener('keydown', function(e) {
                    if (e.key === 'Enter') {
                        performSearch();
                    }
                });
            }

            if (searchBtn) {
                searchBtn.addEventListener('click', performSearch);
            }

            if (clearSearchBtn) {
                clearSearchBtn.addEventListener('click', clearSearch);
            }
        }

        function performSearch() {
            const searchInput = document.getElementById('graphSearch');
            const query = searchInput.value.toLowerCase().trim();
            
            if (!query) {
                clearSearch();
                return;
            }

            if (!cy) return;

            // Clear previous search results
            cy.elements().removeClass('search-result', 'search-highlight');

            // Find matching nodes
            const results = cy.nodes().filter(node => {
                const label = node.data('label') || '';
                const file = node.data('file') || '';
                return label.toLowerCase().includes(query) || file.toLowerCase().includes(query);
            });

            if (results.length > 0) {
                // Highlight search results
                results.addClass('search-result');
                
                // Fit view to results
                cy.fit(results, 50);
                
                // Show search results panel
                showSearchResults(results, query);
                
                trackMetric('graph_search', query);
            } else {
                showNotification('No matching functions found.', 'warning');
            }
        }

        function clearSearch() {
            const searchInput = document.getElementById('graphSearch');
            if (searchInput) {
                searchInput.value = '';
            }

            if (cy) {
                cy.elements().removeClass('search-result', 'search-highlight');
                cy.fit();
            }

            hideSearchResults();
        }

        function showSearchResults(results, query) {
            const searchResults = document.getElementById('searchResults');
            if (searchResults) {
                const resultList = results.map(node => {
                    const data = node.data();
                    return `
                        <div class="search-result-item" onclick="highlightSearchResult('${node.id()}')">
                            <div class="result-label">${data.label}</div>
                            <div class="result-file">${data.file || 'Unknown file'}</div>
                        </div>
                    `;
                }).join('');

                searchResults.innerHTML = `
                    <div class="search-results-header">
                        <h4>Search Results for "${query}"</h4>
                        <span class="result-count">${results.length} found</span>
                    </div>
                    <div class="search-results-list">
                        ${resultList}
                    </div>
                `;
                searchResults.style.display = 'block';
            }
        }

        function hideSearchResults() {
            const searchResults = document.getElementById('searchResults');
            if (searchResults) {
                searchResults.style.display = 'none';
            }
        }

        function highlightSearchResult(nodeId) {
            if (cy) {
                const node = cy.getElementById(nodeId);
                if (node) {
                    cy.elements().removeClass('search-highlight');
                    node.addClass('search-highlight');
                    cy.center(node);
                    cy.fit(node, 100);
                }
            }
        }

        function setupPerformanceOptimizations() {
            if (!cy) return;

            // Initialize performance optimization modules
            initializePerformanceModules();

            // Enhanced viewport-based rendering for large graphs
            cy.on('viewport', debounce(function() {
                const viewport = cy.extent();
                const nodesInViewport = cy.nodes().filter(node => {
                    const pos = node.position();
                    return pos.x >= viewport.x1 && pos.x <= viewport.x2 && 
                           pos.y >= viewport.y1 && pos.y <= viewport.y2;
                });
                
                // Use performance optimizer for large graphs
                if (cy.nodes().length > 1000) {
                    if (performanceOptimizer) {
                        performanceOptimizer.renderViewportNodes();
                    } else {
                        // Fallback to basic viewport rendering
                        cy.nodes().style('display', 'none');
                        nodesInViewport.style('display', 'element');
                    }
                }
            }, 16)); // ~60fps

            // Enhanced edge rendering optimization
            cy.on('zoom', debounce(function() {
                const zoom = cy.zoom();
                const edges = cy.edges();
                
                if (performanceOptimizer) {
                    // Use performance optimizer for edge culling
                    performanceOptimizer.processInWorker('OPTIMIZE_STYLES', {
                        nodes: cy.nodes().map(n => ({ id: n.id(), data: n.data() })),
                        edges: cy.edges().map(e => ({ id: e.id(), data: e.data() })),
                        zoom: zoom
                    });
                } else {
                    // Fallback to basic edge optimization
                    if (zoom < 0.5) {
                        edges.style('label', '');
                    } else {
                        edges.style('label', 'data(label)');
                    }
                }
            }, 16));

            // Memory management for large graphs
            cy.on('add remove', debounce(function() {
                const nodeCount = cy.nodes().length;
                const edgeCount = cy.edges().length;
                
                if (memoryManager) {
                    memoryManager.checkMemoryUsage();
                }
                
                // Enable virtual scrolling for large lists
                if (nodeCount > 500 && virtualScrollManager) {
                    setupVirtualScrolling();
                }
            }, 100));
        }

        function initializePerformanceModules() {
            try {
                // Initialize performance optimizer
                if (typeof PerformanceOptimizer !== 'undefined') {
                    performanceOptimizer = new PerformanceOptimizer(cy);
                    console.log('✓ Performance optimizer initialized');
                }

                // Initialize memory manager
                if (typeof MemoryManager !== 'undefined') {
                    memoryManager = new MemoryManager();
                    console.log('✓ Memory manager initialized');
                }

                // Initialize virtual scroll manager
                if (typeof VirtualScrollManager !== 'undefined') {
                    virtualScrollManager = new VirtualScrollManager();
                    console.log('✓ Virtual scroll manager initialized');
                }
            } catch (error) {
                console.warn('Performance modules initialization failed:', error);
            }
        }

        function setupVirtualScrolling() {
            if (!virtualScrollManager) return;

            // Setup virtual scrolling for function lists
            const functionList = document.getElementById('functionList');
            if (functionList && !functionList.dataset.virtualized) {
                virtualScrollManager.create('functionList', functionList, {
                    itemHeight: 35,
                    threshold: 50,
                    renderFunction: renderFunctionItem,
                    updateFunction: updateFunctionItem
                });
                functionList.dataset.virtualized = 'true';
            }

            // Setup virtual scrolling for node lists
            const nodeList = document.getElementById('nodeList');
            if (nodeList && !nodeList.dataset.virtualized) {
                virtualScrollManager.create('nodeList', nodeList, {
                    itemHeight: 40,
                    threshold: 100,
                    renderFunction: renderNodeItem,
                    updateFunction: updateNodeItem
                });
                nodeList.dataset.virtualized = 'true';
            }
        }

        function renderFunctionItem(item, index) {
            const element = document.createElement('div');
            element.className = 'function-item';
            element.innerHTML = `
                <div class="function-name">${item.name}</div>
                <div class="function-complexity">Complexity: ${item.complexity}</div>
                <div class="function-side-effects">Side Effects: ${item.sideEffects ? item.sideEffects.length : 0}</div>
            `;
            element.dataset.index = index;
            return element;
        }

        function updateFunctionItem(element, item, index) {
            element.querySelector('.function-name').textContent = item.name;
            element.querySelector('.function-complexity').textContent = `Complexity: ${item.complexity}`;
            element.querySelector('.function-side-effects').textContent = `Side Effects: ${item.sideEffects ? item.sideEffects.length : 0}`;
            element.dataset.index = index;
        }

        function renderNodeItem(item, index) {
            const element = document.createElement('div');
            element.className = 'node-item';
            element.innerHTML = `
                <div class="node-label">${item.label}</div>
                <div class="node-type">${item.type || 'function'}</div>
            `;
            element.dataset.index = index;
            return element;
        }

        function updateNodeItem(element, item, index) {
            element.querySelector('.node-label').textContent = item.label;
            element.querySelector('.node-type').textContent = item.type || 'function';
            element.dataset.index = index;
        }

        function updateDeepLink(data) {
            const url = new URL(window.location);
            url.hash = `#node=${encodeURIComponent(data.label)}&lens=${encodeURIComponent(getCurrentLensName())}&overlay=${traceOverlay ? 'trace' : 'static'}`;
            window.history.pushState(null, null, url);
        }

        function handleGraphKeyboard(e) {
            if (!cy) return;

            switch(e.key) {
                case 'ArrowUp':
                case 'ArrowDown':
                case 'ArrowLeft':
                case 'ArrowRight':
                    e.preventDefault();
                    navigateGraph(e.key);
                    break;
                case 'f':
                    if (e.ctrlKey || e.metaKey) {
                        e.preventDefault();
                        document.getElementById('graphSearch').focus();
                    }
                    break;
                case 'Escape':
                    clearSearch();
                    clearHighlights();
                    break;
                case 'r':
                    if (e.ctrlKey || e.metaKey) {
                        e.preventDefault();
                        cy.fit();
                    }
                    break;
            }
        }

        function navigateGraph(direction) {
            const selected = cy.nodes('.selected');
            if (selected.length === 0) return;

            const current = selected[0];
            const pos = current.position();
            const step = 50;

            let targetPos = { ...pos };
            switch(direction) {
                case 'ArrowUp':
                    targetPos.y -= step;
                    break;
                case 'ArrowDown':
                    targetPos.y += step;
                    break;
                case 'ArrowLeft':
                    targetPos.x -= step;
                    break;
                case 'ArrowRight':
                    targetPos.x += step;
                    break;
            }

            current.position(targetPos);
            cy.animate({
                center: { eles: current }
            });
        }

        function updateNodeMetrics(data) {
            const metricsPanel = document.getElementById('nodeMetrics');
            if (metricsPanel) {
                metricsPanel.innerHTML = `
                    <div class="node-metrics">
                        <h4>Selected Node</h4>
                        <div class="metric-row">
                            <span class="metric-name">Function:</span>
                            <span class="metric-value">${data.label}</span>
                        </div>
                        <div class="metric-row">
                            <span class="metric-name">Complexity:</span>
                            <span class="metric-value">${data.complexity || 'Low'}</span>
                        </div>
                        <div class="metric-row">
                            <span class="metric-name">Callers:</span>
                            <span class="metric-value">${data.callers ? data.callers.length : 0}</span>
                        </div>
                        <div class="metric-row">
                            <span class="metric-name">Callees:</span>
                            <span class="metric-value">${data.callees ? data.callees.length : 0}</span>
                        </div>
                    </div>
                `;
            }
        }

        // Performance monitoring and management functions
        function getPerformanceMetrics() {
            const metrics = {
                graph: {
                    nodes: cy ? cy.nodes().length : 0,
                    edges: cy ? cy.edges().length : 0,
                    zoom: cy ? cy.zoom() : 1
                },
                memory: memoryManager ? memoryManager.getMemoryStats() : null,
                performance: performanceOptimizer ? performanceOptimizer.getPerformanceMetrics() : null,
                virtualScroll: virtualScrollManager ? virtualScrollManager.instances.size : 0
            };
            
            return metrics;
        }

        function displayPerformanceMetrics() {
            const metrics = getPerformanceMetrics();
            const metricsPanel = document.getElementById('performanceMetrics');
            
            if (metricsPanel) {
                metricsPanel.innerHTML = `
                    <div class="performance-metrics">
                        <h4>Performance Metrics</h4>
                        <div class="metric-row">
                            <span class="metric-name">Graph Size:</span>
                            <span class="metric-value">${metrics.graph.nodes} nodes, ${metrics.graph.edges} edges</span>
                        </div>
                        <div class="metric-row">
                            <span class="metric-name">Memory Usage:</span>
                            <span class="metric-value">${metrics.memory ? (metrics.memory.performance?.usedRatio * 100).toFixed(1) + '%' : 'N/A'}</span>
                        </div>
                        <div class="metric-row">
                            <span class="metric-name">Frame Rate:</span>
                            <span class="metric-value">${metrics.performance ? metrics.performance.frameRate + ' fps' : 'N/A'}</span>
                        </div>
                        <div class="metric-row">
                            <span class="metric-name">Quality Level:</span>
                            <span class="metric-value">${metrics.performance ? metrics.performance.quality.name : 'N/A'}</span>
                        </div>
                        <div class="metric-row">
                            <span class="metric-name">Virtual Lists:</span>
                            <span class="metric-value">${metrics.virtualScroll} active</span>
                        </div>
                    </div>
                `;
            }
        }

        function optimizeForLargeGraph() {
            if (!cy || cy.nodes().length < 1000) return;
            
            console.log('Optimizing for large graph...');
            
            // Enable aggressive optimizations
            if (performanceOptimizer) {
                performanceOptimizer.setMinimalRendering();
                performanceOptimizer.enableVirtualization();
            }
            
            // Clear caches
            if (memoryManager) {
                memoryManager.forceGC();
            }
            
            // Update UI
            displayPerformanceMetrics();
        }

        function cleanupPerformanceModules() {
            if (performanceOptimizer) {
                performanceOptimizer.destroy();
                performanceOptimizer = null;
            }
            
            if (memoryManager) {
                memoryManager.destroy();
                memoryManager = null;
            }
            
            if (virtualScrollManager) {
                virtualScrollManager.destroyAll();
                virtualScrollManager = null;
            }
        }

        // Utility functions
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        function updateMinimap() {
            if (cyMinimap && cy) {
                const extent = cy.extent();
                const center = cy.center();
                const zoom = cy.zoom();
                
                cyMinimap.fit();
                cyMinimap.center(center);
                cyMinimap.zoom(zoom * 0.1); // Minimap shows overview
            }
        }

        function getCurrentLensName() {
            return currentFilters.size > 0 ? Array.from(currentFilters).join(',') : 'default';
        }
    </script>
</body>
</html>
